/*!
 *
 * # BiB/i Extension: OverReflow
 *
 * - "Overlays Reflowable Content Layers on Pre-Paginated Book"
 * - Copyright (c) Satoru MATSUSHIMA - http://bibi.epub.link/ or https://github.com/satorumurmur/bibi
 * - Licensed under the MIT license. - http://www.opensource.org/licenses/mit-license.php
 */
Bibi.x({name:"OverReflow",description:"Overlays Reflowable Content Layers on Pre-Paginated Book",version:"0.1.0",build:20150902.0003})(function(){E.bind("bibi:readPackageDocument",function(){X.OverReflow.Layer=R.Sub.appendChild(sML.create("div",{className:"overreflow-layer hidden",Frames:[],open:function(a){R.Sub.style.display="block",X.OverReflow.Layer.Frames.forEach(function(b){b.style.display=b==a.OverReflow.Frame?"block":"none"}),setTimeout(function(){sML.removeClass(X.OverReflow.Layer,"hidden"),sML.removeClass(X.OverReflow.Bar,"hidden")},0)},close:function(){sML.addClass(X.OverReflow.Layer,"hidden"),sML.addClass(X.OverReflow.Bar,"hidden"),setTimeout(function(){R.Sub.style.display=""},250)}})),X.OverReflow.Bar=R.Sub.appendChild(sML.create("div",{className:"overreflow-bar"})),X.OverReflow.Closer=X.OverReflow.Bar.appendChild(sML.create("span",{className:"overreflow-closer",innerHTML:"Close"})),X.OverReflow.Closer.addEventListener("click",function(){X.OverReflow.Layer.close()})}),E.bind("bibi:loadItem",function(a){if(a.ItemRef["bibi:overreflow"]&&/^idref:/.test(a.ItemRef["bibi:overreflow"])){if(a.stamp("OverReflow Prepare Start"),a.OverReflow={},a.OverReflow.IDRef=a.ItemRef["bibi:overreflow"].replace(/^idref:(.*)/,"$1"),!B.Package.Manifest.items[a.OverReflow.IDRef])return a.stamp("OverReflow Prepare Error");a.OverReflow.idref=a.ItemRef["bibi:overreflow"],a.OverReflow.Path=O.getPath(B.Package.Dir,B.Package.Manifest.items[a.OverReflow.IDRef].href),a.OverReflow.URI=B.Zipped?B.getDataURI(a.OverReflow.Path):B.Path+"/"+a.OverReflow.Path,a.OverReflow.Frame=X.OverReflow.Layer.appendChild(sML.create("iframe",{className:"overreflow-frame",scrolling:"auto",allowtransparency:"true",src:a.OverReflow.URI,onload:function(){var a=this.contentDocument.documentElement,b=this.contentDocument.body;a.addEventListener("click",X.OverReflow.Layer.close,!1),sML.each(b.getElementsByTagName("a"),function(){this.addEventListener("click",function(a){a.stopPropagation()},!1)})}})),a.OverReflow.Opener=a.ItemBox.appendChild(sML.create("span",{className:"overreflow-opener",Item:a,innerHTML:'<a href="'+a.OverReflow.URI+'">Open</a>'},{},{click:function(){X.OverReflow.Layer.open(this.Item)}})),X.OverReflow.Layer.Frames.push(a.OverReflow.Frame),a.stamp("OverReflow Prepare End")}})});
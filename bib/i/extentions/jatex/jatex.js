/*!
 *
 * # BiB/i Extention: JaTEx
 *
 * - "Japanes Typesetting Extra"
 * - Copyright (c) Satoru MATSUSHIMA - http://bibi.epub.link/ or https://github.com/satorumurmur/bibi
 * - Licensed under the MIT license. - http://www.opensource.org/licenses/mit-license.php
 *
 * - Thu July 2 14:36:00 2015 +0900
 */
Bibi.x({name:"JaTEx",description:"Japanese Typesetting Extra",version:"0.1.0",build:20150702,HTMLString:"",Current:0,Log:!1,LogCorrection:!1,LogCancelation:!1,parse:function(a){return a&&"object"==typeof a&&a.tagName&&(a=a.innerHTML),a&&"string"==typeof a?(this.HTMLString=a,this.Current=0,this.Log&&(this.log(1,"BiB/i JaTEx"),this.log(2,"parse"),this.log(3,"HTMLString: "+this.HTMLString)),this.parseInnerHTML()):null},parseInnerHTML:function(){for(var a=(this.Current,[]),b=this.parsePart();null!==b&&(a.push(b),b=this.parsePart()););return a.length?a:null},parsePart:function(){var a=(this.Current,{}),b=this.parseString(/^<[^>]*?>/);if(b)return/^<!--/.test(b)?a.Type="Comment":(a.Type="Tag",/^<ruby[ >]/.test(b)?a.Detail="ruby:open":/^<\/ruby>/.test(b)?a.Detail="ruby:close":/^<span[ >]/.test(b)&&/ class="([\w\d\-]+[\s\t]+)*(tcy|sideways|upright)([\s\t]+[\w\d\-]+)*"/.test(b)?a.Detail="span.x:open":/^<span[ >]/.test(b)?a.Detail="span:open":/^<\/span>/.test(b)&&(a.Detail="span:close")),a.Content=b,a;var c=this.parseString(/[^<]+/);return c?(a.Type="Text",a.Content=c,a):null},parseString:function(a){var b=null,c=!1;if(a instanceof RegExp){var d=this.HTMLString.substr(this.Current,this.HTMLString.length-this.Current);a.test(d)&&(c=!0,a=d.match(a)[0])}else this.HTMLString.substr(this.Current,a.length)===a&&(c=!0);return c&&(this.Current+=a.length,b=a),this.correct(b)},correct:function(a){return this.Log&&this.LogCorrection&&a&&this.log(3,a),a},cancel:function(a,b){return this.Log&&this.LogCancelation&&this.log(4,"cancel: parse"+b+" ("+a+"-"+this.Current+"/"+this.HTMLString.length+")"),"number"==typeof a&&(this.Current=a),null},log:function(a,b){this.Log&&console&&console.log&&(0==a?b="[ERROR] "+b:1==a?b="---------------- "+b+" ----------------":2==a?b=b:3==a?b=" - "+b:4==a&&(b="   . "+b),console.log("BiB/i JaTEx: "+b))},haveTo:function(a){return P["japanese-typesetting-extra"]||a.HTML.getAttribute("data-bibi-jatex")?!sML.UA.WebKit||sML.UA.Android?!1:"ja"!=B.Language||"tb-rl"!=B.WritingMode||"tb-rl"!=S.BWM?!1:!0:!1},Selector:"p, li"})(function(){E.bind("bibi:before:postprocessItem",function(a){X.JaTEx.haveTo(a)&&(a.logNow("JaTEx Preprocess"),sML.each(a.Body.querySelectorAll(X.JaTEx.Selector),function(){var a=this,b=X.JaTEx.parse(a.innerHTML);if(b&&b.length){var c="",d=0,e=0;sML.each(b,function(){var a=this;"Comment"==a.Type||("Tag"==a.Type?"ruby:open"==a.Detail?d++:"ruby:close"==a.Detail?d--:"span.x:open"==a.Detail?e++:"span:open"==a.Detail&&(d||e?e++:"span:close"==a.Detail&&(d||e)&&e--):d||e||(a.Content=a.Content.replace(/(（([^（）]+)）)/g,'</span><span class="parenthesized with-fullwidth-parentheses">（<span>$2</span>）</span><span>').replace(/(\(([^\(\)]+)\))/g,'</span><span class="parenthesized with-parentheses">(<span>$2</span>)</span><span>').replace(/(　)/g,'</span><span class="ideographic-space">$1</span><span>').replace(/(、)/g,'</span><span class="ideographic-comma">$1</span><span>').replace(/(。)/g,'</span><span class="ideographic-full-stop">$1</span><span>').replace(/⋯/g,"…").replace(/(…{3,})/g,'</span><span class="repeated horizontal-ellipses"><span>$1</span>/span><span>').replace(/(……)/g,'</span><span class="repeated as-doublewidth-horizontal-ellipsis"><span>$1</span></span><span>').replace(/(…)/g,'</span><span class="horizontal-ellipsis">$1</span><span>').replace(/―/g,"—").replace(/(—{3,})/g,'</span><span class="repeated em-dashes"><span>$1</span></span><span>').replace(/(——)/g,'</span><span class="repeated as-doublewidth-em-dash"><span>$1</span></span><span>').replace(/(—)/g,'</span><span class="em-dash">$1</span><span>').replace(/(！{3,})/g,'</span><span class="repeated fullwidth-exclamation-marks"><span>$1</span></span><span>').replace(/(？{3,})/g,'</span><span class="repeated fullwidth-question-marks"><span>$1</span></span><span>').replace(/(！！)/g,'</span><span class="coupled as-double-exclamation-mark"><span>$1</span></span><span>').replace(/(？？)/g,'</span><span class="coupled as-double-question-mark"><span>$1</span></span><span>').replace(/(！？)/g,'</span><span class="coupled as-exclamation-question-mark"><span>$1</span></span><span>').replace(/(？！)/g,'</span><span class="coupled as-question-exclamation-mark"><span>$1</span></span><span>'),a.Content="<span>"+a.Content+"</span>")),c+=a.Content}),a.innerHTML=c.replace(/<span><\/span>/g,""),sML.each(a.querySelectorAll(".repeated"),function(){this.innerHTML=this.innerHTML.replace(/<[^>]+>/g,"")}),sML.each(a.querySelectorAll(".coupled"),function(){this.innerHTML=this.innerHTML.replace(/<[^>]+>/g,"")})}}),a.logNow("JaTEx Preprocessed"))}),E.bind("bibi:resetItem",function(a){if(X.JaTEx.haveTo(a)){a.logNow("JaTEx Layout");var b=/^tb/.test(a.HTML.WritingMode);sML.each(a.Body.querySelectorAll(".ideographic-space, .ideographic-comma, .ideographic-full-stop"),function(){sML.style(this,{display:"",margin:"",textIndent:"",transform:""})}),sML.each(a.Body.querySelectorAll(X.JaTEx.Selector),function(){{var a=this.appendChild(sML.create("span",{},{display:"block"})),c=a.appendChild(sML.create("span",{},{display:"block",textAlign:"left"})).appendChild(sML.create("span"))["offset"+S.BASE.S];a.appendChild(sML.create("span",{},{display:"block",textAlign:"right"})).appendChild(sML.create("span"))["offset"+S.BASE.S]}this.removeChild(a),sML.each(this.querySelectorAll(".ideographic-space, .ideographic-comma, .ideographic-full-stop"),function(){this.style.display="inline-block",this.style.textIndent="0",this["offset"+S.BASE.S]==c?(this.style["margin"+S.BASE.S]="-1em",sML.style(this,{transform:"translate"+(b?"Y":"X")+"(1em)"})):(this.style.display="",this.style.textIndent="")})}),a.logNow("JaTEx Layouted")}})});
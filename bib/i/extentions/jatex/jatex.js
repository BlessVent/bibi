/*!
 *
 * # BiB/i Extention: JaTEx
 *
 * - "Japanes Typesetting Extra"
 * - Copyright (c) Satoru MATSUSHIMA - http://bibi.epub.link/ or https://github.com/satorumurmur/bibi
 * - Licensed under the MIT license. - http://www.opensource.org/licenses/mit-license.php
 *
 * - Thu July 2 14:36:00 2015 +0900
 */
Bibi.x({name:"JaTEx",description:"Japanese Typesetting Extra",version:"0.1.0",build:20150702,HTMLString:"",Current:0,Log:!1,LogCorrection:!1,LogCancelation:!1,parse:function(a){return a&&"object"==typeof a&&a.tagName&&(a=a.innerHTML),a&&"string"==typeof a?(this.HTMLString=a,this.Current=0,this.Log&&(this.log(1,"BiB/i JaTEx"),this.log(2,"parse"),this.log(3,"HTMLString: "+this.HTMLString)),this.parseInnerHTML()):null},parseInnerHTML:function(){for(var a=(this.Current,[]),b=this.parsePart();null!==b&&(a.push(b),b=this.parsePart()););return a.length?a:null},parsePart:function(){var a=(this.Current,{}),b=this.parseString(/^<[^>]*?>/);if(b)return/^<!--/.test(b)?a.Type="Comment":(a.Type="Tag",/^<ruby[ >]/.test(b)?a.Detail="ruby:open":/^<\/ruby>/.test(b)?a.Detail="ruby:close":/^<span[ >]/.test(b)&&/ class="([\w\d\-]+[\s\t]+)*(tcy|sideways|upright)([\s\t]+[\w\d\-]+)*"/.test(b)?a.Detail="span.x:open":/^<span[ >]/.test(b)?a.Detail="span:open":/^<\/span>/.test(b)&&(a.Detail="span:close")),a.Content=b,a;var c=this.parseString(/[^<]+/);return c?(a.Type="Text",a.Content=c,a):null},parseString:function(a){var b=null,c=!1;if(a instanceof RegExp){var d=this.HTMLString.substr(this.Current,this.HTMLString.length-this.Current);a.test(d)&&(c=!0,a=d.match(a)[0])}else this.HTMLString.substr(this.Current,a.length)===a&&(c=!0);return c&&(this.Current+=a.length,b=a),this.correct(b)},correct:function(a){return this.Log&&this.LogCorrection&&a&&this.log(3,a),a},cancel:function(a,b){return this.Log&&this.LogCancelation&&this.log(4,"cancel: parse"+b+" ("+a+"-"+this.Current+"/"+this.HTMLString.length+")"),"number"==typeof a&&(this.Current=a),null},log:function(a,b){this.Log&&console&&console.log&&(0==a?b="[ERROR] "+b:1==a?b="---------------- "+b+" ----------------":2==a?b=b:3==a?b=" - "+b:4==a&&(b="   . "+b),console.log("BiB/i JaTEx: "+b))}})(function(){E.bind("bibi:postprocessItem",function(a){a.HTML.getAttribute("data-bibi-jatex")&&(a.logNow("JaTEx Started"),sML.each(a.Body.querySelectorAll("h1, h2, h3, h4, h5, h6, p, li, dt, dd"),function(){var a=X.JaTEx.parse(this.innerHTML);if(a&&a.length){var b="";IgnoringRuby=0,IgnoringSpan=0;for(var c=0,d=a.length;d>c;c++){var e=a[c];"Comment"==e.Type||("Tag"==e.Type?"ruby:open"==e.Detail?IgnoringRuby++:"ruby:close"==e.Detail?IgnoringRuby--:"span.x:open"==e.Detail?IgnoringSpan++:"span:open"==e.Detail&&(IgnoringRuby||IgnoringSpan?IgnoringSpan++:"span:close"==e.Detail&&(IgnoringRuby||IgnoringSpan)&&IgnoringSpan--):IgnoringRuby||IgnoringSpan||(e.Content=e.Content.replace(/(（[^）]）)/g,'<span class="parenthesized">$1</span>').replace(/(、)/g,'<span class="ideographic-comma">$1</span>').replace(/(。)/g,'<span class="ideographic-full-stop">$1</span>').replace(/(・)/g,'<span class="katakana-middle-dot">$1</span>').replace(/(（)/g,'<span class="fullwidth-left-parenthesis">$1</span>').replace(/(）)/g,'<span class="fullwidth-right-parenthesis">$1</span>').replace(/(「)/g,'<span class="left-corner-bracket">$1</span>').replace(/(」)/g,'<span class="right-corner-bracket">$1</span>').replace(/(『)/g,'<span class="left-white-corner-bracket">$1</span>').replace(/(』)/g,'<span class="right-white-corner-bracket">$1</span>').replace(/(〈)/g,'<span class="left-angle-bracket">$1</span>').replace(/(〉)/g,'<span class="right-angle-bracket">$1</span>').replace(/(《)/g,'<span class="left-double-angle-bracket">$1</span>').replace(/(》)/g,'<span class="right-double-angle-bracket">$1</span>').replace(/(｛)/g,'<span class="fullwidth-left-curly-bracket">$1</span>').replace(/(｝)/g,'<span class="fullwidth-right-curly-bracket">$1</span>').replace(/(［)/g,'<span class="fullwidth-left-square-bracket">$1</span>').replace(/(］)/g,'<span class="fullwidth-right-square-bracket">$1</span>').replace(/(【)/g,'<span class="left-black-lenticular-bracket">$1</span>').replace(/(】)/g,'<span class="right-black-lenticular-bracket">$1</span>').replace(/(…{3,})/g,'<span class="repeating-horizontal-ellipsis">$1</span>').replace(/(……)/g,'<span class="double-horizontal-ellipsis">$1</span>').replace(/(…)/g,'<span class="horizontal-ellipsis">$1</span>').replace(/(⋯{3,})/g,'<span class="repeating-midline-horizontal-ellipsis">$1</span>').replace(/(⋯⋯)/g,'<span class="double-midline-horizontal-ellipsis">$1</span>').replace(/(⋯)/g,'<span class="midline-horizontal-ellipsis">$1</span>').replace(/(—{3,})/g,'<span class="repeating-em-dash">$1</span>').replace(/(——)/g,'<span class="double-em-dash">$1</span>').replace(/(—)/g,'<span class="em-dash">$1</span>').replace(/(！{3,})/g,'<span class="repeating-exclamation-mark">$1</span>').replace(/(？{3,})/g,'<span class="repeating-question-mark">$1</span>').replace(/(！！)/g,'<span class="double-exclamation-mark">$1</span>').replace(/(？？)/g,'<span class="double-question-mark">$1</span>').replace(/(！？)/g,'<span class="exclamation-question-mark">$1</span>').replace(/(？！)/g,'<span class="question-exclamation-mark">$1</span>').replace(/(！)/g,'<span class="exclamation-mark">$1</span>').replace(/(？)/g,'<span class="question-mark">$1</span>'))),b+=e.Content}this.innerHTML=b,sML.each(this.querySelectorAll([".repeating-horizontal-ellipsis",".repeating-midline-horizontal-ellipsis",".repeating-em-dash",".repeating-exclamation-mark",".repeating-question-mark"].join(",")),function(){this.innerHTML=this.innerHTML.replace(/<[^>]+>/g,"")}),sML.each(this.querySelectorAll([".double-horizontal-ellipsis",".double-midline-horizontal-ellipsis",".double-em-dash",".double-exclamation-mark",".double-question-mark",".exclamation-question-mark",".question-exclamation-mark"].join(",")),function(){this.innerHTML=this.innerHTML.replace(/<[^>]+>/g,"")})}}),a.logNow("JaTEx Processed"))})});
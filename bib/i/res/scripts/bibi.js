/*!
 *
 * # BiB/i
 *
 * - "EPUB Reader on Your Web Site."
 * - Copyright (c) Satoru MATSUSHIMA - http://bibi.epub.link/ or https://github.com/satorumurmur/bibi
 * - Licensed under the MIT license. - http://www.opensource.org/licenses/mit-license.php
 *
 * ## Components:
 * 1. Native Promise Only | Copyright (c) Kyle Simpson - https://github.com/getify/native-promise-only | Licensed under the MIT license.
 * 2. easing.js | Copyright (c) Dan Rogers - https://github.com/danro/easing-js | Licensed under the MIT license.
 * 3. sML | Copyright (c) Satoru MATSUSHIMA - https://github.com/satorumurmur/sML | Licensed under the MIT license.
 * 4. BiB/i (core)
 */
/*! Native Promise Only
    v0.8.0-a (c) Kyle Simpson
    MIT License: http://getify.mit-license.org
*/
!function(e,t,n){t[e]=t[e]||n(),"undefined"!=typeof module&&module.exports?module.exports=t[e]:"function"==typeof define&&define.amd&&define(function(){return t[e]})}("Promise","undefined"!=typeof global?global:this,function(){"use strict";function e(e,t){g.add(e,t),u||(u=f(g.drain))}function t(e){var t,n=typeof e;return null==e||"object"!=n&&"function"!=n||(t=e.then),"function"==typeof t?t:!1}function n(){for(var e=0;e<this.chain.length;e++)i(this,1===this.state?this.chain[e].success:this.chain[e].failure,this.chain[e]);this.chain.length=0}function i(e,n,i){var r,a;try{n===!1?i.reject(e.msg):(r=n===!0?e.msg:n.call(void 0,e.msg),r===i.promise?i.reject(TypeError("Promise-chain cycle")):(a=t(r))?a.call(r,i.resolve,i.reject):i.resolve(r))}catch(o){i.reject(o)}}function r(i){var o,l=this;if(!l.triggered){l.triggered=!0,l.def&&(l=l.def);try{(o=t(i))?e(function(){var e=new s(l);try{o.call(i,function(){r.apply(e,arguments)},function(){a.apply(e,arguments)})}catch(t){a.call(e,t)}}):(l.msg=i,l.state=1,l.chain.length>0&&e(n,l))}catch(d){a.call(new s(l),d)}}}function a(t){var i=this;i.triggered||(i.triggered=!0,i.def&&(i=i.def),i.msg=t,i.state=2,i.chain.length>0&&e(n,i))}function o(e,t,n,i){for(var r=0;r<t.length;r++)!function(r){e.resolve(t[r]).then(function(e){n(r,e)},i)}(r)}function s(e){this.def=e,this.triggered=!1}function l(e){this.promise=e,this.state=0,this.triggered=!1,this.chain=[],this.msg=void 0}function d(t){if("function"!=typeof t)throw TypeError("Not a function");if(0!==this.__NPO__)throw TypeError("Not a promise");this.__NPO__=1;var i=new l(this);this.then=function(t,r){var a={success:"function"==typeof t?t:!0,failure:"function"==typeof r?r:!1};return a.promise=new this.constructor(function(e,t){if("function"!=typeof e||"function"!=typeof t)throw TypeError("Not a function");a.resolve=e,a.reject=t}),i.chain.push(a),0!==i.state&&e(n,i),a.promise},this["catch"]=function(e){return this.then(void 0,e)};try{t.call(void 0,function(e){r.call(i,e)},function(e){a.call(i,e)})}catch(o){a.call(i,o)}}var c,u,g,p=Object.prototype.toString,f="undefined"!=typeof setImmediate?function(e){return setImmediate(e)}:setTimeout;try{Object.defineProperty({},"x",{}),c=function(e,t,n,i){return Object.defineProperty(e,t,{value:n,writable:!0,configurable:i!==!1})}}catch(h){c=function(e,t,n){return e[t]=n,e}}g=function(){function e(e,t){this.fn=e,this.self=t,this.next=void 0}var t,n,i;return{add:function(r,a){i=new e(r,a),n?n.next=i:t=i,n=i,i=void 0},drain:function(){var e=t;for(t=n=u=void 0;e;)e.fn.call(e.self),e=e.next}}}();var m=c({},"constructor",d,!1);return d.prototype=m,c(m,"__NPO__",0,!1),c(d,"resolve",function(e){var t=this;return e&&"object"==typeof e&&1===e.__NPO__?e:new t(function(t,n){if("function"!=typeof t||"function"!=typeof n)throw TypeError("Not a function");t(e)})}),c(d,"reject",function(e){return new this(function(t,n){if("function"!=typeof t||"function"!=typeof n)throw TypeError("Not a function");n(e)})}),c(d,"all",function(e){var t=this;return"[object Array]"!=p.call(e)?t.reject(TypeError("Not an array")):0===e.length?t.resolve([]):new t(function(n,i){if("function"!=typeof n||"function"!=typeof i)throw TypeError("Not a function");var r=e.length,a=Array(r),s=0;o(t,e,function(e,t){a[e]=t,++s===r&&n(a)},i)})}),c(d,"race",function(e){var t=this;return"[object Array]"!=p.call(e)?t.reject(TypeError("Not an array")):new t(function(n,i){if("function"!=typeof n||"function"!=typeof i)throw TypeError("Not a function");o(t,e,function(e,t){n(t)},i)})}),d}),function(e,t){"function"==typeof define?define(t):"undefined"!=typeof module?module.exports=t:this[e]=t}("easing",{easeInQuad:function(e){return Math.pow(e,2)},easeOutQuad:function(e){return-(Math.pow(e-1,2)-1)},easeInOutQuad:function(e){return(e/=.5)<1?.5*Math.pow(e,2):-.5*((e-=2)*e-2)},easeInCubic:function(e){return Math.pow(e,3)},easeOutCubic:function(e){return Math.pow(e-1,3)+1},easeInOutCubic:function(e){return(e/=.5)<1?.5*Math.pow(e,3):.5*(Math.pow(e-2,3)+2)},easeInQuart:function(e){return Math.pow(e,4)},easeOutQuart:function(e){return-(Math.pow(e-1,4)-1)},easeInOutQuart:function(e){return(e/=.5)<1?.5*Math.pow(e,4):-.5*((e-=2)*Math.pow(e,3)-2)},easeInQuint:function(e){return Math.pow(e,5)},easeOutQuint:function(e){return Math.pow(e-1,5)+1},easeInOutQuint:function(e){return(e/=.5)<1?.5*Math.pow(e,5):.5*(Math.pow(e-2,5)+2)},easeInSine:function(e){return-Math.cos(e*(Math.PI/2))+1},easeOutSine:function(e){return Math.sin(e*(Math.PI/2))},easeInOutSine:function(e){return-.5*(Math.cos(Math.PI*e)-1)},easeInExpo:function(e){return 0===e?0:Math.pow(2,10*(e-1))},easeOutExpo:function(e){return 1===e?1:-Math.pow(2,-10*e)+1},easeInOutExpo:function(e){return 0===e?0:1===e?1:(e/=.5)<1?.5*Math.pow(2,10*(e-1)):.5*(-Math.pow(2,-10*--e)+2)},easeInCirc:function(e){return-(Math.sqrt(1-e*e)-1)},easeOutCirc:function(e){return Math.sqrt(1-Math.pow(e-1,2))},easeInOutCirc:function(e){return(e/=.5)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)},easeOutBounce:function(e){return 1/2.75>e?7.5625*e*e:2/2.75>e?7.5625*(e-=1.5/2.75)*e+.75:2.5/2.75>e?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},easeInBack:function(e){var t=1.70158;return e*e*((t+1)*e-t)},easeOutBack:function(e){var t=1.70158;return(e-=1)*e*((t+1)*e+t)+1},easeInOutBack:function(e){var t=1.70158;return(e/=.5)<1?.5*e*e*(((t*=1.525)+1)*e-t):.5*((e-=2)*e*(((t*=1.525)+1)*e+t)+2)},elastic:function(e){return-1*Math.pow(4,-8*e)*Math.sin(2*(6*e-1)*Math.PI/2)+1},swingFromTo:function(e){var t=1.70158;return(e/=.5)<1?.5*e*e*(((t*=1.525)+1)*e-t):.5*((e-=2)*e*(((t*=1.525)+1)*e+t)+2)},swingFrom:function(e){var t=1.70158;return e*e*((t+1)*e-t)},swingTo:function(e){var t=1.70158;return(e-=1)*e*((t+1)*e+t)+1},bounce:function(e){return 1/2.75>e?7.5625*e*e:2/2.75>e?7.5625*(e-=1.5/2.75)*e+.75:2.5/2.75>e?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},bouncePast:function(e){return 1/2.75>e?7.5625*e*e:2/2.75>e?2-(7.5625*(e-=1.5/2.75)*e+.75):2.5/2.75>e?2-(7.5625*(e-=2.25/2.75)*e+.9375):2-(7.5625*(e-=2.625/2.75)*e+.984375)},easeFromTo:function(e){return(e/=.5)<1?.5*Math.pow(e,4):-.5*((e-=2)*Math.pow(e,3)-2)},easeFrom:function(e){return Math.pow(e,4)},easeTo:function(e){return Math.pow(e,.25)}}),/*!
 *
 * # sML JavaScript Library
 *
 * - "I'm a Simple and Middling Library."
 * - Copyright (c) Satoru MATSUSHIMA - https://github.com/satorumurmur/sML
 * - Licensed under the MIT license. - http://www.opensource.org/licenses/mit-license.php
 *
 */
sML=function(){var version="0.999.24",build=20160115,sML=function(e){var t="string"==typeof e?[sML.create.apply(this,arguments)]:e.length?e:[e];if(window.__proto__)t.__proto__=sML.SML;else for(var n in sML.SML)t[n]=sML.SML[n];return t};sML.Version=sML.version=version,sML.Build=sML.build=build;var nUA=navigator.userAgent,getVersion=function(e){var t=parseFloat(nUA.replace(new RegExp("^.*"+e+"[ :\\/]?(\\d+([\\._]\\d+)?).*$"),"$1").replace(/_/g,"."));return isNaN(t)?void 0:t};return sML.OperatingSystem=sML.OS=function(e){return/iPhone OS \d/.test(nUA)?e.iOS=getVersion("iPhone OS"):/OS X 10[\._]\d/.test(nUA)?e.OSX=getVersion("OS X 10[\\._]"):/Windows Phone( OS)? \d/.test(nUA)?e.WindowsPhone=getVersion("Windows Phone OS")||getVersion("Windows Phone"):/Windows( NT)? \d/.test(nUA)?e.Windows=getVersion("Windows NT")||getVersion("Windows"):/Android \d/.test(nUA)?e.Android=getVersion("Android"):/CrOS/.test(nUA)?e.Chrome=!0:/X11;/.test(nUA)?e.Linux=!0:/Firefox/.test(nUA)&&(e.Firefox=!0),e}({}),sML.UserAgent=sML.UA=function(e){/Gecko\/\d/.test(nUA)?(e.Gecko=getVersion("rv"),/Firefox\/\d/.test(nUA)&&(e.Firefox=getVersion("Firefox"))):/Edge\/\d/.test(nUA)?e.Edge=getVersion("Edge"):/Chrome\/\d/.test(nUA)?(e.Blink=getVersion("Chrome")||!0,/OPR\/\d/.test(nUA)?e.Opera=getVersion("OPR"):/Silk\/\d/.test(nUA)?e.Silk=getVersion("Silk"):e.Chrome=e.Blink):/AppleWebKit\/\d/.test(nUA)?(e.WebKit=getVersion("AppleWebKit"),/CriOS \d/.test(nUA)?e.Chrome=getVersion("CriOS"):/FxiOS \d/.test(nUA)?e.Firefox=getVersion("FxiOS"):/Version\/\d/.test(nUA)&&(e.Safari=getVersion("Version"))):/Trident\/\d/.test(nUA)&&(e.Trident=getVersion("Trident"),e.InternetExplorer=getVersion("rv")||getVersion("MSIE"));try{e.Flash=parseFloat(navigator.mimeTypes["application/x-shockwave-flash"].enabledPlugin.description.replace(/^.+?([\d\.]+).*$/,"$1"))}catch(t){}return e}({}),sML.Environments=sML.Env=function(e){return["OS","UA"].forEach(function(t){for(var n in sML[t])"Flash"!=n&&sML[t][n]&&e.push(n)}),e}([]),sML.log=function(){try{console.log.apply(console,arguments)}catch(e){}},sML.write=function(){document.open();for(var e=0,t=arguments.length;t>e;e++)document.write(arguments[e]);document.close()},sML.Fill={Prefixes:["webkit","moz","MS","ms","o"],extendElements:function(e){return e},carePrefix:function(e,t){if(t in e)return e[t];t=t[0].toUpperCase()+t.slice(1);for(var n="",i=0,r=this.Prefixes.length;r>i;i++)if(n=this.Prefixes[i]+t,n in e)return e[n];return void 0}},sML.UA.InternetExplorer<9&&(sML.Fill.extendElement=function(e){return e.getElementsByClassName=sML.Fill.getElementsByClassName,e.addEventListener=sML.Fill.addEventListener,e.removeEventListener=sML.Fill.removeEventListener,e},sML.Fill.extendElements=function(e){return sML.Fill.extendElement(e),sML.each(e.getElementsByTagName("*"),function(){sML.Fill.extendElement(this)}),e},sML.Fill.getElementsByClassName=function(e){return this.querySelectorAll("."+e.replace(/^\s+/,"").replace(/\s+$/,"").replace(/\s+/,"."))},sML.Fill.addEventListener=function(e,t){this["FunctionsOn"+e]||(this["FunctionsOn"+e]=[],this["XWrappersOn"+e]=[]);var n=this,i=this["FunctionsOn"+e],r=this["XWrappersOn"+e];if("DOMContentLoaded"==e){var a=function(){"complete"===n.readyState&&t.apply(n,arguments)};e="readystatechange"}else var a=function(){t.apply(n,arguments)};return this.attachEvent("on"+e,a),r.push(a),i.push(t),this},sML.Fill.removeEventListener=function(e,t){for(var n=this["FunctionsOn"+e],i=this["XWrappersOn"+e],r=0,a=n.length;a>r&&n[r]!=t;r++);return"DOMContentLoaded"==e&&(e="readystatechange"),this.detachEvent("on"+e,i[r]),i[r]=n[r]=null,this},window.getComputedStyle=function(e){return e.currentStyle},window.addEventListener=function(e,t){return this.attachEvent("on"+e,t),this},window.removeEventListener=function(e,t){return this.detachEvent("on"+e,t),this},sML.Fill.extendElement(document),document.attachEvent("onreadystatechange",function(){"complete"===document.readyState&&(document.detachEvent("onreadystatechange",arguments.callee),sML.extendElements(document.documentElement))}),window.Event.prototype.stopPropagation=function(){this.cancelBubble=!0},window.Event.prototype.preventDefault=function(){this.returnValue=!1},Array.prototype.map=function(e,t){if("function"!=typeof e)throw new TypeError;for(var n=[],i=0,r=this.length;r>i;i++)n.push(e.call(t,this[i],i,this));return n},Array.prototype.filter=function(e,t){if("function"!=typeof e)throw new TypeError;for(var n=[],i=0,r=this.length;r>i;i++)e.call(t,this[i],i,this)&&n.push(this[i]);return n},Array.prototype.forEach=function(e,t){if("function"!=typeof e)throw new TypeError;for(var n=0,i=this.length;i>n;n++)e.call(t,this[n],n,this)},["section","article","nav","aside","header","footer","figure"].forEach(function(e){document.createElement(e)})),sML.UA.InternetExplorer<=9&&("undefined"==typeof window.console&&(window.console={}),"function"!=typeof window.console.log&&(window.console.log=function(){})),sML.extendElements=sML.Fill.extendElements,window.requestAnimationFrame=sML.Fill.carePrefix(window,"requestAnimationFrame")||function(e){setTimeout(e,1e3/60)},(!window.CustomEvent||"function"!=typeof window.CustomEvent&&-1===window.CustomEvent.toString().indexOf("CustomEventConstructor"))&&(window.CustomEvent=function(e,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),n},window.CustomEvent.prototype=window.Event.prototype),sML.Event={OnRead:{Done:!1,Functions:[]},OnLoad:{Done:!1,Functions:[]},add:function(e,t,n,i){return e.addEventListener(t,n,i?!0:!1),e},remove:function(e,t,n,i){return e.removeEventListener(t,n,i?!0:!1),e},stopPropagation:function(){/*@cc_on @if (@_jscript_version<9) arguments[0]=event; @end @*/return arguments[0].stopPropagation()},preventDefault:function(){/*@cc_on @if (@_jscript_version<9) arguments[0]=event; @end @*/return arguments[0].preventDefault()},set:function(e,t){for(var n in t)e.addEventListener(n,t[n],!1)}},sML.addEventListener=sML.Event.add,sML.removeEventListener=sML.Event.remove,sML.stopPropagation=sML.Event.stopPropagation,sML.preventDefault=sML.Event.preventDefault,sML.Event.OnRead.doOnRead=sML.Event.OnLoad.doOnLoad=function(){if(!this.Done)for(this.Done=!0;this.Functions.length;)this.Functions.shift()()},sML.Event.OnRead.addEventListener=sML.Event.OnLoad.addEventListener=function(e){return this.Done?e():this.Functions.push(e)},sML.onread=sML.ready=function(e){return sML.Event.OnRead.addEventListener(e)},sML.onload=sML.done=function(e){return sML.Event.OnLoad.addEventListener(e)},document.addEventListener("DOMContentLoaded",function(){document.removeEventListener("DOMContentLoaded",arguments.callee,!1),sML.Event.OnRead.doOnRead()},!1),window.addEventListener("load",function(){window.removeEventListener("load",arguments.callee,!1),sML.Event.OnRead.doOnRead(),sML.Event.OnLoad.doOnLoad()},!1),sML.Event.OnResizeFont=sML.onResizeFont=sML.onresizefont={RegularFunctions:[],onZoomInFunctions:[],onZoomOutFunctions:[],addEventListener:function(e,t){t&&t>0?this.onZoomInFunctions.push(e):t&&0>t?this.onZoomOutFunctions.push(e):this.RegularFunctions.push(e)},detect:function(e,t){if(!e)var e=document.body;if(!t)var t=200;this.checker=e,this.timer=setInterval(function(){var e=sML.Coord.getElementSize(sML.onResizeFont.checker).h;if(sML.onResizeFont.prevHeight&&sML.onResizeFont.prevHeight!=e){var t=sML.onResizeFont.RegularFunctions;sML.onResizeFont.prevHeight&&sML.onResizeFont.prevHeight<e?t=t.concat(sML.onResizeFont.onZoomInFunctions):sML.onResizeFont.prevHeight&&sML.onResizeFont.prevHeight>e&&(t=t.concat(sML.onResizeFont.onZoomOutFunctions));for(var n=0,i=t.length;i>n;n++)t[n]()}sML.onResizeFont.prevHeight=e},t)},stopDetect:function(){this.timer&&clearTimeout(this.timer)}},sML.addTouchEventObserver=sML.observeTouch=function(e,t){/*! Requires Hammer.js - http://hammerjs.github.io/ - Copyright (c) Jorik Tangelder - Licensed under the MIT license. */
if(e.addTouchEventListener)return e;if(!window.Hammer)return sML.edit(e,{addTouchEventListener:function(){return!1},removeTouchEventListener:function(){return!1}});var n=new Hammer.Manager(e);return(!t||t.Pan)&&n.add(new Hammer.Pan({threshold:0,pointers:0})),(!t||t.Swipe)&&n.add(new Hammer.Swipe).recognizeWith(n.get("pan")),(!t||t.Rotate)&&n.add(new Hammer.Rotate({threshold:0})).recognizeWith(n.get("pan")),(!t||t.Pinch)&&n.add(new Hammer.Pinch({threshold:0})).recognizeWith([n.get("pan"),n.get("rotate")]),(!t||t.DoubleTap)&&n.add(new Hammer.Tap({event:"doubletap",taps:2})),(!t||t.Tap)&&n.add(new Hammer.Tap),sML.edit(e,{TouchEventObserver:n,TouchEventHandlers:[],addTouchEventListener:function(t,n){var i=function(t){n.apply(e,[t.srcEvent,t])};return e.TouchEventHandlers.push([n,i]),e.TouchEventObserver.on(t,i),e},removeTouchEventListener:function(t,n){if(n&&"function"==typeof n){for(var i=[],r=0,a=e.TouchEventHandlers.length;a>r;r++)e.TouchEventHandlers[r][0]==n?e.TouchEventObserver.off(t,e.TouchEventHandlers[r][1]):i.push(e.TouchEventHandlers[r]);e.TouchEventHandlers=i}else e.TouchEventObserver.off(t);return e}})},sML.Chain=function(){this.Functions=arguments.length?sML.toArray(arguments):[],this.add=function(){for(var e=0,t=arguments.length;t>e;e++)this.Functions.push(arguments[e])},this.start=this.next=function(){var e=this.Functions.shift();"function"==typeof e&&e.apply(null,arguments)},this.skip=function(e){if("number"==typeof e)for(var t=0;e>t;t++)this.Functions.shift()}},sML.Timers={setTimeout:function(){var e=Array.prototype.shift.call(arguments),t=Array.prototype.shift.call(arguments);return Array.prototype.unshift.call(arguments,e),Array.prototype.unshift.call(arguments,t),setTimeout.apply(window,arguments)},setInterval:function(){var e=Array.prototype.shift.call(arguments),t=Array.prototype.shift.call(arguments);return Array.prototype.unshift.call(arguments,e),Array.prototype.unshift.call(arguments,t),setInterval.apply(window,arguments)}},sML.setTimeout=sML.Timers.setTimeout,sML.setInterval=sML.Timers.setInterval,sML.Drawer={draw:function(e,t){e.ToBeDrawn||(requestAnimationFrame(function(){t.apply(e,arguments),e.ToBeDrawn=!1}),e.ToBeDrawn=!0)}},sML.draw=sML.Drawer.draw,sML.getElements=sML.getElementsBySelector=function(){for(var e=1,t=arguments.length;t>e;e++)arguments[0]+=","+arguments[e];return document.querySelectorAll(arguments[0])},sML.cloneObject=function(e){var t=function(){};return t.prototype=e,new t},sML.set=sML.edit=sML.setProperties=sML.setMembers=function(e,t,n,i){if(t){t.ObserveTouch&&(sML.addTouchEventObserver(e),delete t.ObserveTouch);for(var r in t)/^data-/.test(r)?e.setAttribute(r,t[r]):e[r]=t[r]}/*@cc_on @if (@_jscript_version<9) sML.Fill.extendElements(arguments[0]); @end @*/
return n&&sML.CSS.set(e,n),i&&sML.Event.set(e,i),e},sML.create=sML.createElement=function(e,t,n,i){return sML.set(document.createElement(e),t,n,i)},sML.changeClass=sML.changeClassName=function(e,t){return t?e.className=t:e.removeAttribute("class"),e.className},sML.addClass=sML.addClassName=function(e,t){if("string"!=typeof t)return e.className;if(t=t.replace(/ +/g," ").replace(/^ /,"").replace(/ $/,""),!t)return e.className;if(e.className){if((" "+e.className+" ").indexOf(" "+t+" ")>-1)return e.className;t=e.className+" "+t}return sML.changeClass(e,t)},sML.removeClass=sML.removeClassName=function(e,t){return e.className?"string"!=typeof t?e.className:(t=t.replace(/ +/g," ").replace(/^ /,"").replace(/ $/,""))?(" "+e.className+" ").indexOf(" "+t+" ")<0?e.className:(t=(" "+e.className+" ").replace(" "+t+" "," ").replace(/ +/g," ").replace(/^ /,"").replace(/ $/,""),sML.changeClass(e,t)):e.className:""},sML.replaceClass=sML.replaceClassName=function(e,t,n){return sML.removeClass(e,t),sML.addClass(e,n),e.className},sML.appendChildren=function(e,t){if(e.length)for(var n=0,i=e.length;i>n;n++)t.appendChild(e[n]);else t.appendChild(e);return e},sML.insertBefore=function(e,t){return t.parentNode.insertBefore(e,t),t.previousSibling},sML.insertAfter=function(e,t){return t.parentNode.insertBefore(e,t.nextSibling),t.nextSibling},sML.replaceElement=function(e,t){return t.parentNode.insertBefore(e,t),e=t.previousSibling,t.parentNode.removeChild(t),e},sML.removeElement=function(e){e.parentNode.removeChild(e)},sML.deleteElement=function(e){e.parentNode&&e.parentNode.removeChild(e),e.innerHTML="",e=null,delete e},sML.hatch=function(){for(var e="",t=0,n=arguments.length;n>t;t++)e+=arguments[t];var i=document.createElement("div"),r=document.createDocumentFragment(),a=function(){i.innerHTML=e;for(var t=0,n=i.childNodes.length;n>t;t++)r.appendChild(i.firstChild)};return sML.UA.InternetExplorer<9?(document.body.appendChild(i).style.display="none",a(),document.body.removeChild(i)):a(),r},sML.getContentDocument=function(e){return sML.UA.InternetExplorer<8?e.contentWindow.document:e.contentDocument},sML.CSS=sML.S={Prefix:sML.UA.WebKit||sML.UA.Blink?"Webkit":sML.UA.Gecko?"Moz":sML.UA.Trident?"ms":"",TransitionEnd:sML.UA.WebKit||sML.UA.Blink?"webkitTransitionEnd":sML.UA.Gecko?"transitionend":sML.UA.Trident?"MSTransitionEnd":"",AnimationEnd:sML.UA.WebKit||sML.UA.Blink?"webkitAnimationEnd":sML.UA.Gecko?"animationend":sML.UA.Trident?"MSAnimationEnd":"",Catalogue:[],getSFO:function(e){for(var t=0,n=this.Catalogue.length;n>t;t++)if(this.Catalogue[t].Element==e)return this.Catalogue[t];return this.Catalogue[this.Catalogue.push({Element:e})-1]},getComputedStyle:function(e,t){var n=e.currentStyle||document.defaultView.getComputedStyle(e,t?t:"");return n},StyleSheets:[],getStyleSheet:function(e){if(sML.UA.InternetExplorer<9)return e.styleSheets[e.styleSheets.length-1];for(var t=0,n=this.StyleSheets.length;n>t;t++)if(this.StyleSheets[t].StyleFor==e)return this.StyleSheets[t].StyleSheet;var i=e.createElement("style");return i.appendChild(e.createTextNode("")),e.getElementsByTagName("head")[0].appendChild(i),this.StyleSheets.push({StyleFor:e,StyleSheet:i.sheet}),i.sheet},addRule:function(e,t,n){if("function"==typeof t.join)t=t.join(" ");else if("object"==typeof t){var i=[];for(var r in t)i.push(r+": "+t[r]+";");t=i.join(" ")}var a=this.getStyleSheet(n?n:document);if(a){if(a.addRule){var o=a.rules.length;return a.addRule(e,t,o),o}if(a.insertRule)return a.insertRule(e+"{"+t+"}",a.cssRules.length)}return null},addRules:function(e,t){var n=[];if("function"==typeof e.join)for(var i=0,r=e.length/2;r>i;i++)n.push(this.addRule(e[2*i],e[2*i+1],t));else if("object"==typeof e)for(var a in e)n.push(this.addRule(a,e[a],t));return n},add:function(e,t){return this.addRules(e,t)},removeRule:function(e,t){var n=this.getStyleSheet(t?t:document);if(n){if(n.removeRule)n.removeRule(e);else{if(!n.deleteRule)return null;n.deleteRule(e)}return e}return null},removeRules:function(e,t){for(var n=0,i=e.length;i>n;n++)this.removeRule(e[n],t);return e},remove:function(e,t){return this.removeRules(e,t)},setProperty:function(e,t,n,i){return e&&t?(/^(animation|background(-s|S)ize|box|break|column|filter|flow|hyphens|region|shape|transform|transition|writing)/.test(t)?e.style[this.Prefix+t.replace(/(-|^)([a-z])/g,function(e,t,n){return n?n.toUpperCase():""})]=n:"float"==t&&(t=sML.UA.InternetExplorer?"styleFloat":"cssFloat"),e.style[t]=n,e):e},addTransitionEndListener:function(e,t){"function"==typeof t&&(e.sMLTransitionEndListener=t,sML.Event.add(e,this.TransitionEnd,e.sMLTransitionEndListener))},removeTransitionEndListener:function(e){"function"==typeof e.sMLTransitionEndListener&&(sML.Event.remove(e,this.TransitionEnd,e.sMLTransitionEndListener),delete e.sMLTransitionEndListener)},set:function(e,t,n){if(!e||"object"!=typeof t)return e;if(this.removeTransitionEndListener(e),"function"==typeof n&&this.addTransitionEndListener(e,n),!(t instanceof Array)){var i=[];for(var r in t)/^transition/.test(r)?this.setProperty(e,r,t[r]):i[i.push(r)]=t[r];t=i}if(t.length%2<1)for(var a=0,o=t.length/2;o>a;a++)this.setProperty(e,t[2*a],t[2*a+1]);return e},getRGB:function(e){for(var t=e.replace(/rgb\(([\d\., ]+)\)/,"$1").replace(/\s/g,"").split(","),n=0,i=t.length;i>n;n++)t[n]=parseInt(t[n]);return t},getRGBA:function(e){for(var t=e.replace(/rgba?\(([\d\., ]+)\)/,"$1").replace(/\s/g,"").split(","),n=0,i=t.length;i>n;n++)t[n]=parseInt(t[n]);return t[3]||(t[3]=1),t}},sML.style=sML.css=function(e,t,n){return sML.CSS.set(e,t,n)},sML.Easing="object"==typeof window.easing?window.easing:{},sML.Easing.linear=function(e){return e},sML.Easing.getEaser=function(e){return function(t){return t+e/100*(1-t)*t}},sML.Transition=sML.T={Catalogue:[],getSFO:function(e){for(var t=0,n=this.Catalogue.length;n>t;t++)if(this.Catalogue[t].Element==e)return this.Catalogue[t];return this.Catalogue[this.Catalogue.push({Element:e})-1]},begin:function(e,t,n){if(!t)var t={};if(!n)var n={};this.Element=e;var i=this.getSFO(e);i.Timer&&clearTimeout(i.Timer),i.Param={c:0,f:t.f?t.f:10,t:t.t?t.t:10,e:t.e?t.e:null,x:t.x?t.x:null},i.Functions={s:n.s?n.s:null,m:n.m?n.m:null,e:n.e?n.e:null,c:n.c?n.c:null},i.gN=i.getNext=function(e,t,n,r){var a=1,o=i.Param.c/i.Param.f;if(!n&&i.Param.e)var n=i.Param.e;if(!r&&i.Param.x)var r=i.Param.x;return a=n?0==r?o+n/(100*Math.PI)*Math.sin(Math.PI*o):r?(100+r*n)*o/(2*r*n*o+100-r*n):o+n/100*(1-o)*o:o,e+(t-e)*a},i.gC=i.getNextRGBA=function(e,t,n,i){var r=[],a=e.length,o=t.length;4==a&&3==o&&(t[3]=1);for(var s=0;a>s;s++)r[s]=Math.round(this.gN(e[s],t[s]));return r},i.Functions.s&&i.Functions.s.call(e,i),function(){i.Param.c++!=i.Param.f?(i.Functions.m&&i.Functions.m.call(e,i),i.Timer=setTimeout(arguments.callee,i.Param.t)):(i.Functions.e&&i.Functions.e.call(e,i),i.Functions.c&&i.Functions.c.call(e,i))}()}},sML.transition=function(){return sML.Transition.begin.apply(sML.Transition,arguments)},sML.Coord=sML.C={getXY:function(e,t){return{X:e,x:e,Y:t,y:t}},getWH:function(e,t){return{Width:e,W:e,w:e,Height:t,H:t,h:t}},getXYTRBLCMWH:function(e,t,n,i,r,a,o,s,l,d){return{X:e,x:e,Y:t,y:t,Top:n,top:n,T:n,t:n,Right:i,right:i,R:i,r:i,Bottom:r,bottom:r,B:r,b:r,Left:a,left:a,L:a,l:a,Center:o,center:o,C:o,c:o,Middle:s,middle:s,M:s,m:s,Width:l,width:l,W:l,w:l,Height:d,height:d,H:d,h:d}},getScreenSize:function(){return this.getWH(screen.availWidth,screen.availHeight)},getScrollSize:function(e){return e&&e!=window&&e!=document||(e=document.documentElement),this.getWH(e.scrollWidth,e.scrollHeight)},getOffsetSize:function(e){return e&&e!=window||(e=document.documentElement),e==document?this.getScrollSize(document.documentElement):this.getWH(e.offsetWidth,e.offsetHeight)},getClientSize:function(e){return e&&e!=window||(e=document.documentElement),e==document?this.getScrollSize(document.documentElement):this.getWH(e.clientWidth,e.clientHeight)},getDocumentSize:function(){return this.getScrollSize(document.documentElement)},getWindowSize:function(){return this.getOffsetSize(document.documentElement)},getElementSize:function(e){return this.getOffsetSize(e)},getWindowCoord:function(e){return this.getXY(window.screenLeft||window.screenX,window.screenTop||window.screenY)},getElementCoord:function(e,t){var n=e.offsetLeft,i=e.offsetTop;for(t&&(n=n+e.offsetWidth-this.getOffsetSize(document.documentElement).W);e.offsetParent;)e=e.offsetParent,n+=e.offsetLeft,i+=e.offsetTop;return this.getXY(n,i)},getScrollCoord:function(e){return e&&e!=window?this.getXY(e.scrollLeft,e.scrollTop):this.getXY(window.scrollX||window.pageXOffset||document.documentElement.scrollLeft,window.scrollY||window.pageYOffset||document.documentElement.scrollTop)},getScrollLimitCoord:function(e,t){e&&e!=window||(e=document.documentElement);var n=this.getScrollSize(e),i=this.getClientSize(e);return this.getXY((n.W-i.W)*(t?-1:1),n.H-i.H)},getEventCoord:function(e){return e?this.getXY(e.pageX,e.pageY):this.getXY(0,0)},getCoord:function(e,t){if(t)return this.getCoord_RtL(e);if(e==screen)var n=this.getScreenSize(),i={X:0,Y:0},r={X:n.W,Y:n.H};else if(e==window)var n=this.getOffsetSize(document.documentElement),i=this.getScrollCoord(),r={X:i.X+n.W,Y:i.Y+n.H};else if(e==document)var n=this.getScrollSize(document.documentElement),i={X:0,Y:0},r={X:n.W,Y:n.H};else{if(!e.tagName)return{};var n=this.getOffsetSize(e),i=this.getElementCoord(e),r={X:i.X+n.W,Y:i.Y+n.H}}return this.getXYTRBLCMWH(i.X,i.Y,i.Y,r.X,r.Y,i.X,Math.round((i.X+r.X)/2),Math.round((i.Y+r.Y)/2),n.W,n.H)},getCoord_RtL:function(e){if(e==screen)var t=this.getScreenSize(),n={X:t.W,Y:0},i={X:0,Y:t.H};else if(e==window)var t=this.getOffsetSize(document.documentElement),n=this.getScrollCoord(),i={X:n.X-t.W,Y:n.Y+t.H};else if(e==document)var t=this.getScrollSize(document.documentElement),n={X:0,Y:0},i={X:t.W,Y:t.H};else{if(!e.tagName)return{};var t=this.getElementSize(e),n=this.getElementCoord(e,1),i={X:n.X-t.W,Y:n.Y+t.H}}return this.getXYTRBLCMWH(n.X,n.Y,n.Y,n.X,i.Y,i.X,Math.round((i.X+n.X)/2),Math.round((n.Y+i.Y)/2),t.W,t.H)},isInside:function(e,t,n){var i=this.getOffsetSize(document.documentElement);if(n)var r=this.getScrollCoord(),a={T:r.Y,R:r.X,B:r.Y+i.H,L:r.X-i.W};else var o=this.getScrollCoord(),a={T:o.Y,R:o.X+i.W,B:o.Y+i.H,L:o.X};if(e.tagName){var s=this.getElementSize(e);if(n)var l=this.getElementCoord(e,1),d={T:l.Y,R:l.X,B:l.Y+s.H,L:l.X-s.W};else var c=this.getElementCoord(e),d={T:c.Y,R:c.X+s.W,B:c.Y+s.H,L:c.X};d.C=(d.L+d.R)/2,d.M=(d.T+d.B)/2;var u=d.L>=a.L&&d.L<=a.R,g=d.C>=a.L&&d.C<=a.R,p=d.R>=a.L&&d.R<=a.R,f=d.T>=a.T&&d.T<=a.B,h=d.M>=a.T&&d.M<=a.B,m=d.B>=a.T&&d.B<=a.B,S=t?u&&p:u||g||p,L=t?f&&m:f||h||m}else if("object"==typeof e){if("number"==typeof e.X){var S=e.X>=a.L&&e.X<=a.R;if("number"!=typeof e.Y)return S}if("number"==typeof e.Y){var L=e.Y>=a.T&&e.Y<=a.B;if("number"!=typeof e.X)return L}}return S&&L}},sML.getCoord=function(){return sML.Coord.getCoord.apply(sML.Coord,arguments)},sML.Scroller={scrollTo_Legacy:function(e,t,n,i){t||(t={}),n||(n={}),"function"==typeof n&&(n={c:n}),this.SFO={};var r=t.rtl||t.rl||t.vt||t.vertical||/-rl$/.test(t.writingMode?t.writingMode:t["writing-mode"]?t["writing-mode"]:t.wm?t.wm:void 0);sML.Scroller.Timer&&clearTimeout(sML.Scroller.Timer),"number"==typeof e?e={Y:e}:e?e.tagName&&(e=sML.Coord.getElementCoord(e,r)):e={};var a=this.SFO,o=sML.Coord.getScrollCoord(),s=sML.Coord.getScrollLimitCoord(window,r);a.DC={X:"number"==typeof e.x?e.x:o.X,Y:"number"==typeof e.y?e.y:o.Y},r?(a.DC.X<s.X&&(a.DC.X=s.X),a.DC.X>0&&(a.DC.X=0)):(a.DC.X>s.x&&(a.DC.X=s.X),a.DC.X<0&&(a.DC.X=0)),a.DC.Y>s.Y&&(a.DC.Y=s.Y),a.DC.Y<0&&(a.DC.Y=0),a.Param={P:t.p?t.p:.25,T:t.t?t.t:20},a.Functions={start:n.s?n.s:null,middle:n.m?n.m:null,end:n.e?n.e:null,callback:n.c?n.c:null},i&&sML.Scroller.preventUserScrolling(),a.Functions.start&&a.Functions.start(a),function(){a.cC=sML.Coord.getScrollCoord(),a.mV={X:Math.floor((a.DC.X-a.cC.X)*a.Param.P),Y:Math.floor((a.DC.Y-a.cC.Y)*a.Param.P)},Math.abs(a.mV.X)>1||Math.abs(a.mV.Y)>1?(window.scrollBy(a.mV.X,a.mV.Y),a.Functions.middle&&a.Functions.middle(a),sML.Scroller.Timer=setTimeout(arguments.callee,a.Param.T)):(r?window.scrollBy(a.DC.X-a.cC.X,a.DC.Y-a.cC.Y):window.scrollTo(a.DC.X,a.DC.Y),i&&sML.Scroller.allowUserScrolling(),a.Functions.end&&a.Functions.end(a),a.Functions.callback&&a.Functions.callback(a))}(),i||sML.Scroller.addScrollCancelation()},scrollTo:function(e,t,n,i){var r=sML.Coord.getScrollCoord(e);sML.Coord.getScrollLimitCoord(e);if("number"==typeof t)t={X:r.X,Y:t};else if("object"!=typeof t||!t)return;"number"!=typeof t.X&&(t.X=r.X),"number"!=typeof t.Y&&(t.Y=r.Y),n||(n={}),("number"!=typeof n.Duration||n.Duration<0)&&(n.Duration=100);var a=sML.Easing.linear;if("function"==typeof n.Easing)var a=n.Easing;else if("string"==typeof n.Easing)var a=sML.Easing[n.Easing]?sML.Easing[n.Easing]:sML.Easing.linear;else if("number"==typeof n.Easing)var a=sML.Easing.getEaser(n.Easing);"function"==typeof i?i={callback:i}:"object"==typeof i&&i||(i={}),sML.Scroller.Timer&&clearTimeout(sML.Scroller.Timer),n.ForceScroll?sML.Scroller.preventUserScrolling():sML.Scroller.addScrollCancelation(),"function"==typeof i.start&&i.start();var o=e==window?window.scrollTo:function(t,n){e.scrollLeft=t,e.scrollTop=n};!function(e,t,n,i){var r=n.Duration?((new Date).getTime()-e.Time)/n.Duration:1;if(1>r){var s=a(r);o(Math.round(e.X+(t.X-e.X)*s),Math.round(e.Y+(t.Y-e.Y)*s)),"function"==typeof i.middle&&i.middle();var l=arguments.callee;sML.Scroller.Timer=setTimeout(function(){l(e,t,n,i)},10)}else o(t.X,t.Y),"function"==typeof i.end&&i.end(),"function"==typeof i.callback&&i.callback(),n.ForceScroll&&sML.Scroller.allowUserScrolling()}({X:r.X,Y:r.Y,Time:(new Date).getTime()},t,n,i)},addScrollCancelation:function(){sML.addEventListener(document,"mousedown",sML.Scroller.cancelScrolling),sML.addEventListener(document,"keydown",sML.Scroller.cancelScrolling),sML.addEventListener(document,"mousewheel",sML.Scroller.cancelScrolling),sML.addEventListener(document,"DOMMouseScroll",sML.Scroller.cancelScrolling)},cancelScrolling:function(){sML.removeEventListener(document,"mousedown",sML.Scroller.cancelScrolling),sML.removeEventListener(document,"keydown",sML.Scroller.cancelScrolling),sML.removeEventListener(document,"mousewheel",sML.Scroller.cancelScrolling),sML.removeEventListener(document,"DOMMouseScroll",sML.Scroller.cancelScrolling)},preventUserScrolling:function(){sML.addEventListener(document,"mousedown",sML.preventDefault),sML.addEventListener(document,"keydown",sML.preventDefault),sML.addEventListener(document,"mousewheel",sML.preventDefault),sML.addEventListener(document,"DOMMouseScroll",sML.preventDefault)},allowUserScrolling:function(){sML.removeEventListener(document,"mousedown",sML.preventDefault),sML.removeEventListener(document,"keydown",sML.preventDefault),sML.removeEventListener(document,"mousewheel",sML.preventDefault),sML.removeEventListener(document,"DOMMouseScroll",sML.preventDefault)}},sML.scrollTo=function(){var e,t,n,i;return arguments[0]==window||arguments[0].tagName?(e=arguments[0],t=arguments[1],n=arguments[2],i=arguments[3]):(e=window,t=arguments[0],n=arguments[1],i=arguments[2]),"object"==typeof t&&("number"==typeof t.x||"number"==typeof t.y)||"object"==typeof n&&("number"==typeof n.p||"number"==typeof n.t)?sML.Scroller.scrollTo_Legacy.apply(sML.Scroller,arguments):sML.Scroller.scrollTo.apply(sML.Scroller,[e,t,n,i])},sML.Ajax=sML.A={open:function(e){try{var t=new XMLHttpRequest}catch(n){try{var t=new ActiveXObject("Msxml2.XMLHTTP")}catch(n){try{var t=new ActiveXObject("Microsoft.XMLHTTP")}catch(n){}}}if(!t)return sML.log("sML.ShipBuilder could not find XHR.");if("object"!=typeof e||"string"!=typeof e.URI||"function"!=typeof e.onsuccess)return!1;e.Query||(e.Query=null),e.Auth||(e.Auth=["",""]),e.MimeType||(e.MimeType=null),e.onsuccess||(e.onsuccess=function(){}),e.onfailed||(e.onfailed=function(){sML.each(arguments,function(){sML.log(this+"")})}),e.ontimeout||(e.ontimeout=e.onfailed),e.Async!==!1&&(e.Async=!0),e.Method=e.Method&&/^POST$/i.test(e.Method)?"POST":"GET";var i="";if(e.Query)for(var r in e.Query)i+="&"+r+"="+encodeURIComponent(e.Query[r]);return i&&("GET"==e.method?(e.URI=e.URI+(e.URI.indexOf("?")>0?i:i.replace(/^&/,"?")),i=null):"POST"==e.Method&&(i=i.replace(/^&/,""))),t.sMLAjaxTimeout=0,t.sMLAjaxTimeoutTimer=setTimeout(function(){t.sMLAjaxTimeout=1,e.ontimeout("sML.AJAX.get Timeout: "+e.URI)},1e4),e.onstate4=function(n,i){t.sMLAjaxTimeout||(clearTimeout(t.sMLAjaxTimeoutTimer),200==t.status||0==t.status?e.onsuccess(n,i):e.onfailed("sML.AJAX.get Failed: ("+t.status+") "+URL),delete t)},t.onreadystatechange=function(){switch(this.readyState){case 4:return e.onstate4.call(this,this.responseText,this.responseXML)}},e.MimeType&&t.overrideMimeType(e.MimeType),t.open(e.Method,e.URI,e.Async,e.Auth[0],e.Auth[1]),"POST"==e.Method&&t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(i),t}},sML.ajax=function(){var e={};if("object"==typeof arguments[0]){if(e=arguments[0],"string"!=typeof e.URI)return!1}else{if("string"!=typeof arguments[0])return!1;"object"==typeof arguments[1]&&(e=arguments[1]),e.URI=arguments[0]}if("function"!=typeof e.onsuccess){if("function"!=typeof arguments[1])return!1;e.onsuccess=arguments[1],"function"==typeof arguments[2]&&(e.onfailed=arguments[2]),"function"==typeof arguments[3]&&(e.ontimeout=arguments[3])}return sML.Ajax.open(e)},sML.Location=sML.Loc={RE:new RegExp("^((([a-z]+)://([^/\\?#]+))(/[^\\?#]*))(\\?[^\\?#]*)?(#[^#]*)?$"),getFile:function(e){return(e?e:location.href).replace(this.RE,"$1")},getOrigin:function(e){return(e?e:location.href).replace(this.RE,"$2")},getProtocol:function(e){return(e?e:location.href).replace(this.RE,"$3")},getHost:function(e){return(e?e:location.href).replace(this.RE,"$4")},getPathname:function(e){return(e?e:location.href).replace(this.RE,"$5")},getSearch:function(e){return(e?e:location.href).replace(this.RE,"$6")},getHash:function(e){return(e?e:location.href).replace(this.RE,"$7")},getDirectory:function(e){return this.getFile(e).replace(/\/[^\/]*$/,"")},getId:function(e){return this.getHash(e).replace("#","")},getQueries:function(e){var t=(e?e:location.href).split("?");if(2!=t.length)return{};for(var n={},i=t[1].replace(/#.*$/,"").split("&"),r=0,a=i.length;a>r;r++)if(i[r]){var o=i[r].split("=");o.length<2?o[1]=null:o.length>2&&(o[1]=i[r].replace(o[0]+"=","")),n[o[0]]=o[1]}return n},isIndexFile:function(e){return/index\.(x?html?|php|cgi|[ja]spx?)$/.test(this.getPathname(e))},isSameFile:function(e,t){return this.getFile(e)==(t?this.getOrigin(t):location.protocol+"//"+location.host+location.pathname)},isSameOrigin:function(e,t){return this.getOrigin(e)==(t?this.getOrigin(t):location.protocol+"//"+location.host)},isSameProtocol:function(e,t){return this.getProtocol(e)==(t?this.getProtocol(t):location.protocol)},isSameHost:function(e,t){return this.getHost(e)==(t?this.getHost(t):location.host)},isSameHash:function(e,t){return this.getHash(e)==(t?this.getHash(t):location.hash)},isSameDirectory:function(e,t){return this.getDirectory(e)==(t?this.getDirectory(t):(location.protocol+"//"+location.host+location.pathname).replace(/\/[^\/]*$/,""))},isSameId:function(e,t){return this.getId(e)==(t?this.getId(t):location.hash.replace("#",""))}},sML.getQueries=sML.Location.getQueries,sML.Cookies=sML.cookies={put:function(e,t,n){if(!n)var n=1;var i=new Date;return document.cookie=e+"="+t+"; path=/; expires="+i.toGMTString(i.setTime(i.getTime()+864e5*n)),document.cookie},del:function(e){var t=new Date;return document.cookie=e+"=%00; path=/; expires="+t.toGMTString(t.setTime(t.getTime()-864e5)),document.cookie},get:function(e){for(var t=document.cookie.split("; "),n="",i=0,r=t.length;r>i;i++)if(t[i].substr(0,e.length+1)==e+"="){n=t[i].substr(e.length+1,t[i].length);break}return n}},sML.CookieMonster={Cookies:{},set:function(e,t,n){return this.Cookies[e]||(this.Cookies[e]=this.get(e)),null==n?"undefined"!=typeof this.Cookies[e][t]&&delete this.Cookies[e][t]:this.Cookies[e][t]=n,this.Cookies[e]},put:function(e,t){if(!sML.getLength(this.Cookies[e]))return sML.Cookies.del(e),this.del(e);var n="";for(var i in this.Cookies[e])n+='"'+i+'":"'+this.Cookies[e][i]+'",';return n=encodeURIComponent("{"+n.replace(/\,$/,"")+"}"),sML.Cookies.put(e,n,t),this.Cookies},del:function(e){return this.Cookies[e]&&(sML.Cookies.del(e),delete this.Cookies[e]),this.Cookies},get:function(N,K){if(!this.Cookies[N]){var V="";try{V=eval("("+decodeURIComponent(sML.Cookies.get(N))+")")}catch(e){}this.Cookies[N]="object"==typeof V?V:{}}return K?"undefined"==typeof this.Cookies[N][K]?"":this.Cookies[N][K]:this.Cookies[N]}},sML.map=function(e,t){return Array.prototype.map.call(e,t)},sML.filter=function(e,t){return Array.prototype.filter.call(e,t)},sML.forEach=function(e,t){return Array.prototype.forEach.call(e,t)},sML.foreach=function(e,t,n){for(var i=0,r=e.length;r>i&&t.call(n,e[i],i,e)!==!1;i++);return e},sML.each=function(e,t,n,i){for(var r=n?n:0,a=i?i+1:e.length;a>r&&t.call(e[r],r,e)!==!1;r++);return e},sML.toArray=function(){for(var e=[],t=0,n=arguments.length;n>t;t++)if("undefined"==typeof arguments[t].length||"string"==typeof arguments[t])e.push(arguments[t]);else for(var i=0,r=arguments[t].length;r>i;i++)e.push(arguments[t][i]);return e},sML.firstOf=function(e){return e.length?e[0]:null},sML.lastOf=function(e){return e.length?e[e.length-1]:null},sML.Math={sum:function(){for(var e=0,t=0,n=arguments.length;n>t;t++){var i=0;"number"==typeof arguments[t]?i=arguments[t]:"string"==typeof arguments[t]&&(i=arguments[t].length),e+=i}return e},random:function(e,t){isNaN(e)&&isNaN(t)?(e=0,t=1):isNaN(e)?e=0:isNaN(t)&&(t=0);var n=Math.min(e,t),i=Math.max(e,t);return Math.floor(Math.random()*(i-n+1))+n}},sML.String={pad:function(e,t,n){if(e+="",e.length>=t)return e;"string"!=typeof n&&(n="0");for(var i="";i.length<t;)i+=n;return(i+e).slice(-t)},insertZeroWidthSpace:function(e){return e.replace(/(?=\w)/g,"&#x200B;")},replace:function(e,t){if(t.length%2)return this;for(var n=0,i=t.length/2;i>n;n++)e=e.replace(t[2*n],t[2*n+1]);return e}},sML.getLength=function(e){if("object"==typeof e){if(e instanceof Array)return e.length;var t=0;for(var n in e)t++;return t}return"string"==typeof e?e.length:"number"==typeof e?(""+e).length:null},sML.padZero=sML.zeroPadding=sML.String.padZero=sML.String.pad,sML.insertZeroWidthSpace=sML.String.insertZeroWidthSpace,sML.Range={getRange:function(e,t){if(!e)return null;t||(t=e.Start.Node.ownerDocument);var n=t.createRange();return n.setStart(e.Start.Node,"number"==typeof e.Start.Index?e.Start.Index:e.Start.Node.textContent.indexOf(e.Start.Text)),n.setEnd(e.End.Node,"number"==typeof e.End.Index?e.End.Index:e.End.Node.textContent.indexOf(e.End.Text)+e.End.Text.length),n},flat:function(e){return e.replace(/[\r\n]/g,"")},escape:function(e){return this.flat(e).replace(/([\(\)\{\}\[\]\,\.\-\+\*\?\!\:\^\$\/\\])/g,"\\$1")},distill:function(e,t,n){for(var i="",r=t;n>=r;r++)i+=e[r];return i},find:function(e,t){if(t||(t=document.body),"string"!=typeof e||!e||this.flat(t.textContent).indexOf(e)<0)return null;if(3==t.nodeType)return{Start:{Node:t,Text:e},End:{Node:t,Text:e}};for(var n=[],i=0,r=t.childNodes.length-1,a="",o={},s=0;r>=s;s++){if(this.flat(t.childNodes[s].textContent).indexOf(e)>=0)return this.find(e,t.childNodes[s]);n.push(t.childNodes[s].textContent)}for(a=this.distill(n,i+1,r);a&&this.flat(a).indexOf(e)>=0;)i++,a=this.distill(n,i+1,r);var l=t.childNodes[i],d=0,c=l.textContent.length-1,u="";for(a=this.distill(l.textContent,d,c);this.flat(a)&&!new RegExp("^"+this.escape(a)).test(e);)d++,a=this.distill(l.textContent,d,c);for(u=this.flat(a);3!=l.nodeType;)o=this.find(u,l),l=o.Start.Node,u=o.Start.Text;for(a=this.distill(n,i,r-1);a&&this.flat(a).indexOf(e)>=0;)r--,a=this.distill(n,i,r-1);var g=t.childNodes[r],p=0,f=g.textContent.length-1,h="";for(a=this.distill(g.textContent,p,f);this.flat(a)&&!new RegExp(this.escape(a)+"$").test(e);)f--,a=this.distill(g.textContent,p,f);for(h=this.flat(a);3!=g.nodeType;)o=this.find(h,g),g=o.End.Node,h=o.End.Text;return{Start:{Node:l,Text:u},End:{Node:g,Text:h}}}},sML.Selection={selectRange:function(e){if(!e)return null;var t=window.getSelection();return t.removeAllRanges(),t.addRange(e),e},getSelectedText:sML.UA.InternetExplorer<9?function(){var e=""+document.selection.createRange().text;return e?e:""}:function(){var e=""+window.getSelection();return e?e:""}},sML.getSelection=function(){return sML.Selection.getSelectedText()},sML.select=function(e,t){return sML.Selection.selectRange(sML.Range.getRange(e,t))},sML.find=function(e,t){return sML.Selection.selectRange(sML.Range.getRange(sML.Range.find(e,t)))},sML.Fullscreen={Enabled:function(e){return e.fullscreenEnabled||e.fullScreenEnabled||e.webkitFullscreenEnabled||e.webkitFullScreenEnabled||e.mozFullscreenEnabled||e.mozFullScreenEnabled||e.msFullscreenEnabled||e.msFullScreenEnabled}(document),request:function(e){var t=function(t){return function(n){return n||(n=e),n[t]()}};return e.requestFullscreen?t("requestFullscreen"):e.requestFullScreen?t("requestFullScreen"):e.webkitRequestFullscreen?t("webkitRequestFullscreen"):e.webkitRequestFullScreen?t("webkitRequestFullScreen"):e.mozRequestFullscreen?t("mozRequestFullscreen"):e.mozRequestFullScreen?t("mozRequestFullScreen"):e.msRequestFullscreen?t("msRequestFullscreen"):e.msRequestFullScreen?t("msRequestFullScreen"):function(){return!1}}(document.documentElement),exit:function(e){var t=function(t){return function(n){return n||(n=e),n[t]()}};return e.exitFullscreen?t("exitFullscreen"):e.cencelFullScreen?t("cencelFullScreen"):e.webkitExitFullscreen?t("webkitExitFullscreen"):e.webkitCancelFullScreen?t("webkitCancelFullScreen"):e.mozExitFullscreen?t("mozExitFullscreen"):e.mozCancelFullScreen?t("mozCancelFullScreen"):e.msExitFullscreen?t("msExitFullscreen"):e.msCancelFullScreen?t("msCancelFullScreen"):function(){return!1}}(document),getElement:function(e){var t=function(t){return function(n){return n||(n=e),n[t]}};return"undefined"!=typeof e.fullscreenElement?t("fullscreenElement"):"undefined"!=typeof e.fullScreenElement?t("fullScreenElement"):"undefined"!=typeof e.webkitFullscreenElement?t("webkitFullscreenElement"):"undefined"!=typeof e.webkitFullScreenElement?t("webkitFullScreenElement"):"undefined"!=typeof e.mozFullscreenElement?t("mozFullscreenElement"):"undefined"!=typeof e.mozFullScreenElement?t("mozFullScreenElement"):"undefined"!=typeof e.msFullscreenElement?t("msFullscreenElement"):"undefined"!=typeof e.msFullScreenElement?t("msFullScreenElement"):function(){return null}}(document)},sML.FullscreenEnabled=sML.Fullscreen.Enbabled,sML.requestFullscreen=sML.Fullscreen.request,sML.exitFullscreen=sML.Fullscreen.exit,sML.getFullscreenElement=sML.Fullscreen.getElement,sML.SML={each:function(e){return sML.each(this,e),this},set:function(e,t){return this.each(function(){var n=this;sML.set(n,e,t)})},style:function(e){return this.each(function(){var t=this;sML.style(t,e)})},appendChild:function(e){return this.each(function(){var t=this;sML.each(e,function(){t.appendChild(this)})})},preppendChild:function(e){return this.each(function(){var e=this;sML.each(Es,function(){e.insertBefore(this,S.firstChild)})})},insertBefore:function(e,t){return this.each(function(){var e=this;sML.each(Es,function(){e.insertBefore(this,t)})})},insertAfter:function(e,t){return this.each(function(){var e=this;sML.each(Es,function(){e.insertBefore(this,t.nextSibling)})})},addClass:function(e){return this.each(function(){var t=this;sML.addClass(t,e)})},removeClass:function(e){return this.each(function(){var t=this;sML.removeClass(t,e)})},replaceClass:function(e,t){return this.each(function(){var n=this;sML.replaceClass(n,e,t)})}},window.addEventListener("unload",function(){window.sML=null,delete window.sML}),sML}(),/*!
 *
 * # BiB/i (core)
 *
 * - "Heart of BiB/i"
 * - Copyright (c) Satoru MATSUSHIMA - http://bibi.epub.link/ or https://github.com/satorumurmur/bibi
 * - Licensed under the MIT license. - http://www.opensource.org/licenses/mit-license.php
 */
Bibi={version:"0.999.0",build:20160126.1416},B={},C={},E={},L={},M={},N={},O={},P={},R={},S={},U={},X={},Bibi.welcome=function(){O.log(1,"Welcome to BiB/i v"+Bibi.version+" - http://bibi.epub.link/"),O.stamp("Welcome!"),O.HTML=document.documentElement,O.HTML.className=sML.Environments.join(" "),O.Head=document.head,O.Body=document.body,O.Info=document.getElementById("bibi-info"),O.Title=document.getElementsByTagName("title")[0],(sML.OS.iOS||sML.OS.Android)&&(O.SmartPhone=!0,O.HTML.className=O.HTML.className+" Touch",O.setOrientation=function(){sML.removeClass(O.HTML,"orientation-"+(0==window.orientation?"landscape":"portrait")),sML.addClass(O.HTML,"orientation-"+(0==window.orientation?"portrait":"landscape"))},window.addEventListener("orientationchange",O.setOrientation),O.setOrientation(),sML.OS.iOS&&(O.Head.appendChild(sML.create("meta",{name:"apple-mobile-web-app-capable",content:"yes"})),O.Head.appendChild(sML.create("meta",{name:"apple-mobile-web-app-status-bar-style",content:"white"})))),window.parent==window?(O.WindowEmbedded=0,O.WindowEmbeddedDetail="Direct Opened: "+location.origin+location.pathname+location.search,O.HTML.className=O.HTML.className+" window-not-embedded"):(O.HTML.className=O.HTML.className+" window-embedded",location.host==parent.location.host?(O.WindowEmbedded=1,O.WindowEmbeddedDetail="Embedded in: "+parent.location.origin+parent.location.pathname+parent.location.search,O.HTML.className=O.HTML.className+" window-embedded-sameorigin"):(O.WindowEmbedded=-1,O.WindowEmbeddedDetail="Embedded in: Cross-Origin Parent",O.HTML.className=O.HTML.className+" window-embedded-crossorigin")),function(){return document.body.requestFullscreen||document.body.requestFullScreen?!0:document.body.webkitRequestFullscreen||document.body.webkitRequestFullScreen?!0:document.body.mozRequestFullscreen||document.body.mozRequestFullScreen?!0:document.body.msRequestFullscreen?!0:!1}()?(O.FullscreenEnabled=!0,O.HTML.className=O.HTML.className+" fullscreen-enabled"):(O.FullscreenEnabled=!1,O.HTML.className=O.HTML.className+" fullscreen-not-enabled");var e=getComputedStyle(O.HTML);O.WritingModeProperty=function(){return/^(vertical|horizontal)-/.test(e["-webkit-writing-mode"])?"-webkit-writing-mode":/^(vertical|horizontal)-/.test(e["writing-mode"])||sML.UA.InternetExplorer?"writing-mode":void 0}();var t=document.body.appendChild(sML.create("div",{id:"checker"}));t.Child=t.appendChild(sML.create("p",{innerHTML:"aAあ亜"})),t.Child.offsetWidth<t.Child.offsetHeight?(O.HTML.className=O.HTML.className+" vertical-text-enabled",O.VerticalTextEnabled=!0):(O.HTML.className=O.HTML.className+" vertical-text-not-enabled",O.VerticalTextEnabled=!1),O.DefaultFontSize=Math.min(t.Child.offsetWidth,t.Child.offsetHeight),document.body.removeChild(t),delete t,R.Main=O.Body.insertBefore(sML.create("div",{id:"main"}),O.Body.firstElementChild),R.Sub=O.Body.insertBefore(sML.create("div",{id:"sub"}),R.Main.nextSibling),R.Main.Book=R.Main.appendChild(sML.create("div",{id:"book"})),R.Frame=R.Main,U.initialize(),S.initialize(),S.poster&&(sML.addClass(O.HTML,"with-poster"),O.Body.style.backgroundImage="url("+S.poster+")");var n=[];for(var i in X)X[i]&&"object"==typeof X[i]&&X[i].name&&n.push(X[i].name);return n.length&&O.log(2,"Extention"+(n.length>=2?"s":"")+": "+n.join(", ")),N.createBoard(),C.createVeil(),C.createPanel(),sML.UA.InternetExplorer<11?Bibi.byebye():(N.note("Welcome!"),E.add("bibi:command:move",function(e){R.move(e)}),E.add("bibi:command:focus",function(e){R.focus(e)}),E.add("bibi:command:changeView",function(e){R.changeView(e)}),E.add("bibi:command:togglePanel",function(e){C.Panel.toggle()}),window.addEventListener(O.SmartPhone?"orientationchange":"resize",R.onresize),R.Frame.addEventListener("scroll",R.onscroll),E.dispatch("bibi:welcome"),window.addEventListener("message",M.gate,!1),M.post("bibi:welcome"),void setTimeout(function(){U.book?(B.initialize(U.book),S.autostart||!B.Zipped?B.load():(E.dispatch("bibi:wait"),N.note(""))):O.ZippedEPUBEnabled&&window.File&&!O.SmartPhone?B.dropOrClick():O.WindowEmbedded?N.note("Tell me EPUB name via embedding tag."):N.note("Tell me EPUB name via URI.")},sML.OS.iOS||sML.OS.Android?999:1))},Bibi.byebye=function(){var e={En:"<span>I'm so Sorry....</span> <span>Your Browser Is</span> <span>Not Compatible with BiB/i.</span>",Ja:"<span>ごめんなさい……</span> <span>お使いのブラウザでは、</span><span>ビビは動きません。</span>"};C.Veil.ByeBye=C.Veil.appendChild(sML.createElement("p",{id:"bibi-veil-byebye",innerHTML:['<span lang="en">',e.En,"</span>",'<span lang="ja">',e.Ja,"</span>"].join("").replace(/(BiB\/i|ビビ)/g,'<a href="http://bibi.epub.link/" target="_blank">$1</a>')})),E.dispatch("bibi:byebye"),O.log(1,e.En.replace(/<[^>]*>/g,""))},B.initialize=function(e){if(delete B.name,delete B.Path,delete B.PathDelimiter,delete B.Zipped,delete B.Local,delete B.File,delete B.Files,O.apply({Title:"",Creator:"",Publisher:"",Language:"",WritingMode:"",Container:{Path:"META-INF/container.xml"},Package:{Path:"",Dir:"",Metadata:{titles:[],creators:[],publishers:[],languages:[]},Manifest:{items:{},nav:{},"toc-ncx":{},"cover-image":{}},Spine:{itemrefs:[]}},FileDigit:3},B),"string"==typeof e)B.name=e,B.Path=function(){return/^([\w\d]+:)?\/\//.test(B.name)?B.name:/^\//.test(B.name)?location.origin+B.name:P.bookshelf+B.name}(),/\.epub$/i.test(B.name)&&(B.Zipped=!0);else{if("object"!=typeof e||!e)return!1;if(!e.size||"string"!=typeof e.name||!/\.epub$/i.test(e.name))return N.note("Give me <strong>EPUB</strong>."),!1;B.name=B.Path=e.name,B.Zipped=!0,B.Local=!0,B.File=e}B.PathDelimiter=B.Zipped?" > ":"/",E.dispatch("bibi:B.initialize")},B.load=function(){O.startLoading(),R.initialize(),B.Zipped?O.ZippedEPUBEnabled&&B.loadZippedEPUB():(O.log(2,"EPUB: "+B.Path+" (Online Folder)"),B.open())},B.open=function(){E.dispatch("bibi:open"),O.openDocument(B.Container.Path,{then:L.readContainer})},L.readContainer=function(e){O.log(2,"Reading Container XML..."),O.log(3,B.Path+B.PathDelimiter+B.Container.Path),B.Package.Path=e.getElementsByTagName("rootfile")[0].getAttribute("full-path"),B.Package.Dir=B.Package.Path.replace(/\/?[^\/]+$/,""),E.dispatch("bibi:readContainer"),O.log(2,"Container XML Read.","Show"),O.openDocument(B.Package.Path,{then:L.readPackageDocument})},L.readPackageDocument=function(e){O.log(2,"Reading Package Document..."),O.log(3,B.Path+B.PathDelimiter+B.Package.Path);var t=e.getElementsByTagName("metadata")[0],n=e.getElementsByTagName("manifest")[0],i=e.getElementsByTagName("spine")[0],r=n.getElementsByTagName("item"),a=i.getElementsByTagName("itemref");if(r.length<=0)return O.log(0,'"'+B.Package.Path+'" has no <item> in <manifest>.');if(a.length<=0)return O.log(0,'"'+B.Package.Path+'" has no <itemref> in <spine>.');sML.each(t.getElementsByTagName("meta"),function(){if(!this.getAttribute("refines")){if(this.getAttribute("property")){var e=this.getAttribute("property").replace(/^dcterms:/,"");/^(title|creator|publisher|language)$/.test(e)?B.Package.Metadata[e+"s"].push(this.textContent):B.Package.Metadata[e]||(B.Package.Metadata[e]=this.textContent)}this.getAttribute("name")&&this.getAttribute("content")&&(B.Package.Metadata[this.getAttribute("name")]=this.getAttribute("content"))}}),B.Package.Metadata.titles.length||sML.each(e.getElementsByTagName("dc:title"),function(){return B.Package.Metadata.titles.push(this.textContent),!1}),B.Package.Metadata.creators.length||sML.each(e.getElementsByTagName("dc:creator"),function(){B.Package.Metadata.creators.push(this.textContent)}),B.Package.Metadata.publishers.length||sML.each(e.getElementsByTagName("dc:publisher"),function(){B.Package.Metadata.publishers.push(this.textContent)}),B.Package.Metadata.languages.length||sML.each(e.getElementsByTagName("dc:language"),function(){B.Package.Metadata.languages.push(this.textContent)}),B.Package.Metadata.languages.length||(B.Package.Metadata.languages[0]="en"),B.Package.Metadata.cover||(B.Package.Metadata.cover=""),B.Package.Metadata["rendition:layout"]||(B.Package.Metadata["rendition:layout"]="reflowable"),B.Package.Metadata["rendition:orientation"]||(B.Package.Metadata["rendition:orientation"]="auto"),B.Package.Metadata["rendition:spread"]||(B.Package.Metadata["rendition:spread"]="auto"),"auto"==B.Package.Metadata["rendition:orientation"]&&(B.Package.Metadata["rendition:orientation"]="portrait"),"auto"==B.Package.Metadata["rendition:spread"]&&(B.Package.Metadata["rendition:spread"]="landscape"),delete e;var o=i.getAttribute("toc");sML.each(r,function(){var e={id:this.getAttribute("id")||"",href:this.getAttribute("href")||"","media-type":this.getAttribute("media-type")||"",properties:this.getAttribute("properties")||"",fallback:this.getAttribute("fallback")||""};e.id&&e.href&&(B.Package.Manifest.items[e.id]=e,function(t){/ nav /.test(t)&&(B.Package.Manifest.nav.Path=O.getPath(B.Package.Dir,e.href)),/ cover-image /.test(t)&&(B.Package.Manifest["cover-image"].Path=O.getPath(B.Package.Dir,e.href))}(" "+e.properties+" "),o&&e.id==o&&(B.Package.Manifest["toc-ncx"].Path=O.getPath(B.Package.Dir,e.href)))}),B.Package.Spine["page-progression-direction"]=i.getAttribute("page-progression-direction"),B.Package.Spine["page-progression-direction"]&&/^(ltr|rtl)$/.test(B.Package.Spine["page-progression-direction"])||(B.Package.Spine["page-progression-direction"]="ltr"),B.PPD=B.Package.Spine["page-progression-direction"];var s=[/(page-spread)-(.+)/,/(rendition:layout)-(.+)/,/(rendition:orientation)-(.+)/,/(rendition:spread)-(.+)/,/(rendition:page-spread)-(.+)/,/(bibi:[a-z]+)-(.+)/];sML.each(a,function(e){var t={idref:this.getAttribute("idref")||"",linear:this.getAttribute("linear")||"",properties:this.getAttribute("properties")||"","page-spread":"","rendition:layout":B.Package.Metadata["rendition:layout"],"rendition:orientation":B.Package.Metadata["rendition:orientation"],"rendition:spread":B.Package.Metadata["rendition:spread"]};"no"!=t.linear&&(t.linear="yes"),t.properties=t.properties.replace(/^\s+/,"").replace(/\s+$/,"").replace(/\s+/g," ").split(" "),s.forEach(function(e){t.properties.forEach(function(n){return e.test(n)?(t[n.replace(e,"$1")]=n.replace(e,"$2").replace("rendition:",""),!1):void 0})}),t["rendition:page-spread"]&&(t["page-spread"]=t["rendition:page-spread"]),t["rendition:page-spread"]=t["page-spread"],t.viewport={content:null,width:null,height:null},t.viewBox={content:null,width:null,height:null},B.Package.Spine.itemrefs.push(t)}),B.Title=B.Package.Metadata.titles.join(", "),B.Creator=B.Package.Metadata.creators.join(", "),B.Publisher=B.Package.Metadata.publishers.join(", "),B.Language=B.Package.Metadata.languages[0].split("-")[0],/^(zho?|chi|kor?|ja|jpn)$/.test(B.Language)?B.WritingMode="rtl"==B.PPD?"tb-rl":"lr-tb":/^(aze?|ara?|ui?g|urd?|kk|kaz|ka?s|ky|kir|kur?|sn?d|ta?t|pu?s|bal|pan?|fas?|per|ber|msa?|may|yid?|heb?|arc|syr|di?v)$/.test(B.Language)?B.WritingMode="rl-tb":/^(mo?n)$/.test(B.Language)?B.WritingMode="tb-lr":B.WritingMode="lr-tb";var l=[];B.Title&&(l.push(B.Title),O.log(3,"title: "+B.Title)),B.Creator&&(l.push(B.Creator),O.log(3,"creator: "+B.Creator)),B.Publisher&&(l.push(B.Publisher),O.log(3,"publisher: "+B.Publisher)),l.length&&(O.Title.innerHTML="",O.Title.appendChild(document.createTextNode("BiB/i | "+l.join(" - ").replace(/&amp;?/gi,"&").replace(/&lt;?/gi,"<").replace(/&gt;?/gi,">")))),S.update(),E.dispatch("bibi:readPackageDocument"),O.log(2,"Package Document Read.","Show"),L.prepareSpine()},L.prepareSpine=function(){if(O.log(2,"Preparing Spine...","Show"),"rtl"==B.PPD)var e="right",t="left";else var e="left",t="right";sML.each(B.Package.Spine.itemrefs,function(){var n=this;if("yes"==n.linear){var i=sML.create("iframe",{className:"item",scrolling:"no",allowtransparency:"true"});if(i.ItemRef=n,i.Path=O.getPath(B.Package.Dir,B.Package.Manifest.items[n.idref].href),i.Dir=i.Path.replace(/\/?[^\/]+$/,""),R.Items.length&&n["page-spread"]==t){var r=R.Items[R.Items.length-1];r.ItemRef["page-spread"]==e&&(i.Pair=r,r.Pair=i)}if(i.Pair)var a=i.Pair.Spread,o=a.SpreadBox;else{var o=R.Main.Book.appendChild(sML.create("div",{className:"spread-box"})),a=o.appendChild(sML.create("div",{className:"spread"}));a.SpreadBox=o,a.Items=[],a.Pages=[],a.SpreadIndex=R.Spreads.length,a.id="spread-"+sML.String.padZero(a.SpreadIndex,B.FileDigit),R.Spreads.push(a)}var s=a.appendChild(sML.create("div",{className:"item-box"}));i.Spread=a,i.ItemBox=s,i.Pages=[],i.ItemIndexInSpread=a.Items.length,i.ItemIndex=R.Items.length,i.id="item-"+sML.String.padZero(i.ItemIndex,B.FileDigit),a.Items.push(i),[o,a,s,i].forEach(function(e){e.RenditionLayout=n["rendition:layout"],e.PrePaginated="pre-paginated"==e.RenditionLayout,sML.addClass(e,n["rendition:layout"])}),[s,i].forEach(function(e){n["page-spread"]&&sML.addClass(e,"page-spread-"+n["page-spread"]),n["bibi:layout"]&&sML.addClass(e,"layout-"+n["bibi:layout"])}),R.Items.push(i)}}),O.log(3,sML.String.padZero(R.Items.length,B.FileDigit)+" Items"),E.dispatch("bibi:prepareSpine"),O.log(2,"Spine Prepared.","Show"),L.createCover()},L.createCover=function(){O.log(2,"Creating Cover...","Show"),C.Veil.Cover.innerHTML=C.Panel.BookInfo.Cover.innerHTML="",B.Package.Manifest["cover-image"].Path&&(R.CoverImage.Path=B.Package.Manifest["cover-image"].Path);var e=function(){var e=[];return B.Title&&e.push("<strong>"+B.Title+"</strong>"),B.Creator&&e.push("<em>"+B.Creator+"</em>"),B.Publisher&&e.push("<span>"+B.Publisher+"</span>"),e.join(" ")}();C.Veil.Cover.Info=C.Veil.Cover.appendChild(sML.create("p",{id:"bibi-veil-cover-info",innerHTML:e})),C.Panel.BookInfo.Cover.Info=C.Panel.BookInfo.Cover.appendChild(sML.create("p",{id:"bibi-panel-bookinfo-cover-info",innerHTML:e})),R.CoverImage.Path?(O.log(3,B.Path+B.PathDelimiter+R.CoverImage.Path),C.Veil.Cover.className="with-cover-image",sML.create("img",{onload:function(){sML.style(C.Veil.Cover,{backgroundImage:"url("+this.src+")",opacity:1}),C.Panel.BookInfo.Cover.insertBefore(this,C.Panel.BookInfo.Cover.Info),C.Panel.BookInfo.Cover.className="with-cover-image",E.dispatch("bibi:createCover",R.CoverImage.Path),O.log(2,"Cover Created.","Show"),L.createNavigation()}}).src=function(){return B.Zipped?B.getDataURI(R.CoverImage.Path):B.Path+"/"+R.CoverImage.Path}()):(O.log(3,"No Cover Image."),C.Veil.Cover.className="without-cover-image",C.Panel.BookInfo.Cover.className="without-cover-image",E.dispatch("bibi:createCover",""),O.log(2,"Cover Created.","Show"),L.createNavigation())},L.createNavigation=function(e){if(!e){if(O.log(2,"Creating Navigation...","Show"),B.Package.Manifest.nav.Path)C.Panel.BookInfo.Navigation.Path=B.Package.Manifest.nav.Path,C.Panel.BookInfo.Navigation.Type="NavigationDocument";else{if(O.log(2,"No Navigation Document."),!B.Package.Manifest["toc-ncx"].Path)return O.log(2,"No TOC-NCX."),E.dispatch("bibi:createNavigation",""),O.log(2,"Navigation Made Nothing.","Show"),L.loadSpreads();C.Panel.BookInfo.Navigation.Path=B.Package.Manifest["toc-ncx"].Path,C.Panel.BookInfo.Navigation.Type="TOC-NCX"}return O.log(3,B.Path+B.PathDelimiter+C.Panel.BookInfo.Navigation.Path),O.openDocument(C.Panel.BookInfo.Navigation.Path,{then:L.createNavigation})}C.Panel.BookInfo.Navigation.innerHTML="";var t=document.createDocumentFragment();if("NavigationDocument"==C.Panel.BookInfo.Navigation.Type)sML.each(e.querySelectorAll("nav"),function(){switch(this.getAttribute("epub:type")){case"toc":sML.addClass(this,"bibi-nav-toc");break;case"landmarks":sML.addClass(this,"bibi-nav-landmarks");break;case"page-list":sML.addClass(this,"bibi-nav-page-list")}sML.each(this.querySelectorAll("*"),function(){this.removeAttribute("style")}),t.appendChild(this)});else{var n=e.getElementsByTagName("navMap")[0];sML.each(n.getElementsByTagName("navPoint"),function(){sML.insertBefore(sML.create("a",{href:this.getElementsByTagName("content")[0].getAttribute("src"),innerHTML:this.getElementsByTagName("text")[0].innerHTML}),this.getElementsByTagName("navLabel")[0]),sML.removeElement(this.getElementsByTagName("navLabel")[0]),sML.removeElement(this.getElementsByTagName("content")[0]);var e=sML.create("li");e.setAttribute("id",this.getAttribute("id")),e.setAttribute("playorder",this.getAttribute("playorder")),sML.insertBefore(e,this).appendChild(this),e.previousSibling&&e.previousSibling.tagName&&!/^a$/i.test(e.previousSibling.tagName)?e.previousSibling.appendChild(e):sML.insertBefore(sML.create("ul"),e).appendChild(e)}),t.appendChild(document.createElement("nav")).innerHTML=n.innerHTML.replace(/<(bibi_)?navPoint( [^>]+)?>/gi,"").replace(/<\/(bibi_)?navPoint>/gi,"")}C.Panel.BookInfo.Navigation.appendChild(t),C.Panel.BookInfo.Navigation.Body=C.Panel.BookInfo.Navigation,delete t,delete e,L.postprocessItem.coordinateLinkages(C.Panel.BookInfo.Navigation,"InNav"),R.resetNavigation(),E.dispatch("bibi:createNavigation",C.Panel.BookInfo.Navigation.Path),O.log(2,"Navigation Created.","Show"),S.autostart||B.Local||B.Zipped?L.loadSpreads():(O.stopLoading(),E.dispatch("bibi:wait"))},L.play=function(){return O.SmartPhone?window.open(location.href.replace(/&wait=[^&]+/g,"")):(O.startLoading(),B.name?L.loadSpreads():B.load({Name:U.book}),void E.dispatch("bibi:play"))},L.loadSpreads=function(){O.log(2,"Loading "+R.Items.length+" Items in "+R.Spreads.length+" Spreads...","Show"),O.stamp("Load Spreads"),O.Body.style.backgroundImage="none",sML.removeClass(O.HTML,"with-poster"),R.resetStage(),R.LoadedItems=0,R.LoadedSpreads=0,R.ToRelayout=!1,L.listenResizingWhileLoading=function(){R.ToRelayout=!0},window.addEventListener("resize",L.listenResizingWhileLoading),E.remove("bibi:postprocessItem",L.onLoadItem),E.add("bibi:postprocessItem",L.onLoadItem),R.Spreads.forEach(function(e){e.Loaded=!1,e.LoadedItems=0,e.Items.forEach(function(e){e.Loaded=!1,O.log(3,"Item: "+sML.String.padZero(e.ItemIndex+1,B.FileDigit)+"/"+sML.String.padZero(B.Package.Spine.itemrefs.length,B.FileDigit)+" - "+(e.Path?B.Path+B.PathDelimiter+e.Path:"... Not Found.")),L.loadItem(e)})})},L.onLoadSpread=function(e){R.LoadedSpreads++,E.dispatch("bibi:loadSpread",e),R.ToRelayout||R.resetSpread(e),R.LoadedSpreads==R.Spreads.length&&(delete B.Files,document.body.style.display="",R.resetPages(),E.dispatch("bibi:loadSpreads"),O.log(2,"Spreads Loaded.","Show"),O.stamp("Spreads Loaded"),L.start(),E.remove("bibi:postprocessItem",L.onLoadItem))},L.loadItem=function(e){var t=e.Path;if(e.TimeCard={},e.stamp=function(t){O.stamp(t,e.TimeCard)},/\.(x?html?)$/i.test(t))B.Zipped?(L.writeItemHTML(e,B.Files[t]),setTimeout(L.postprocessItem,0,e)):(e.src=B.Path+"/"+t,e.onload=function(){setTimeout(L.postprocessItem,0,e)},e.ItemBox.appendChild(e));else if(/\.(svg)$/i.test(t))if(e.IsSVG=!0,B.Zipped)L.writeItemHTML(e,!1,"",B.Files[t].replace(/<\?xml-stylesheet (.+?)[ \t]?\?>/g,'<link rel="stylesheet" $1 />'));else{var n=B.Path+"/"+t;O.download(n).then(function(t){L.writeItemHTML(e,!1,'<base href="'+n+'" />',t.responseText.replace(/<\?xml-stylesheet (.+?)[ \t]?\?>/g,'<link rel="stylesheet" $1 />'))})}else/\.(gif|jpe?g|png)$/i.test(t)?(e.IsBitmap=!0,L.writeItemHTML(e,!1,"",'<img alt="" src="'+(B.Zipped?B.getDataURI(t):B.Path+"/"+t)+'" />')):/\.(pdf)$/i.test(t)&&(e.IsPDF=!0,L.writeItemHTML(e,!1,"",'<iframe     src="'+(B.Zipped?B.getDataURI(t):B.Path+"/"+t)+'" />'))},L.onLoadItem=function(e){e.Loaded=!0,R.LoadedItems++,E.dispatch("bibi:loadItem",e),e.stamp("Loaded");var t=e.Spread;t.LoadedItems++,t.LoadedItems==t.Items.length&&L.onLoadSpread(t),N.note("Loading... ("+R.LoadedItems+"/"+R.Items.length+" Items Loaded.)")},L.writeItemHTML=function(e,t,n,i){e.ItemBox.appendChild(e),e.contentDocument.open(),e.contentDocument.write(t?t:["<html>","<head>"+n+"</head>",'<body onload="parent.L.postprocessItem(parent.R.Items['+e.ItemIndex+"]); document.body.removeAttribute('onload'); return false;\">"+i+"</body>","</html>"].join("")),e.contentDocument.close()},L.postprocessItem=function(e){e.stamp("Postprocess"),e.HTML=sML.edit(e.contentDocument.getElementsByTagName("html")[0],{Item:e}),e.Head=sML.edit(e.contentDocument.getElementsByTagName("head")[0],{Item:e}),e.Body=sML.edit(e.contentDocument.getElementsByTagName("body")[0],{Item:e}),sML.addClass(e.HTML,sML.Environments.join(" ")),sML.each(e.Body.querySelectorAll("link"),function(){e.Head.appendChild(this)}),S["epub-additional-stylesheet"]&&e.Head.appendChild(sML.create("link",{rel:"stylesheet",href:S["epub-additional-stylesheet"]})),S["epub-additional-script"]&&e.Head.appendChild(sML.create("script",{src:S["epub-additional-script"]})),e.StyleSheets=[],sML.CSS.add({html:"-webkit-text-size-adjust: 100%;"},e.contentDocument),sML.each(e.HTML.querySelectorAll("link, style"),function(){if(/^link$/i.test(this.tagName)){if(!/^(alternate )?stylesheet$/.test(this.rel))return;if((sML.UA.Safari||sML.OS.iOS)&&"alternate stylesheet"==this.rel)return}e.StyleSheets.push(this)}),e.BibiProperties={};var t=e.HTML.getAttribute("data-bibi-properties");t&&t.replace(/[\s\t\r\n]+/g," ").split(" ").forEach(function(t){t&&(e.BibiProperties[t]=!0)});var n=e.contentDocument.querySelectorAll("body>*");if(n&&n.length){for(var i=0,r=0,a=n.length;a>r;r++)/^(script|style)$/i.test(n[r].tagName)||i++;1==i&&(/^svg$/i.test(e.Body.firstElementChild.tagName)?(e.Outsourcing=!0,e.ImageItem=!0,e.SingleSVGOnlyItem=!0):/^img$/i.test(e.Body.firstElementChild.tagName)?(e.Outsourcing=!0,e.ImageItem=!0,e.SingleIMGOnlyItem=!0):/^iframe$/i.test(e.Body.firstElementChild.tagName)?(e.Outsourcing=!0,e.FrameItem=!0,e.SingleFrameOnlyItem=!0):O.getElementInnerText(e.Body)||(e.Body.querySelectorAll("img, svg, video, audio").length-e.Body.querySelectorAll("svg img, video img, audio img").length==1?(e.Outsourcing=!0,e.ImageItem=!0):1==e.Body.getElementsByTagName("iframe").length&&(e.Outsourcing=!0,e.FrameItem=!0)))}E.dispatch("bibi:before:postprocessItem",e),L.postprocessItem.processImages(e),L.postprocessItem.defineViewport(e),L.postprocessItem.coordinateLinkages(e),setTimeout(function(){return e.contentDocument.styleSheets.length<e.StyleSheets.length?setTimeout(arguments.callee,100):(L.postprocessItem.patchWritingModeStyle(e),L.postprocessItem.applyBackgroundStyle(e),void E.dispatch("bibi:postprocessItem",e))},100)},L.postprocessItem.processImages=function(e){sML.each(e.Body.getElementsByTagName("img"),function(){this.Bibi={DefaultStyle:{margin:this.style.margin?this.style.margin:"",width:this.style.width?this.style.width:"",height:this.style.height?this.style.height:"","vertical-align":this.style.verticalAlign?this.style.verticalAlign:"","page-break-before":this.style.pageBreakBefore?this.style.pageBreakBefore:"","page-break-after":this.style.pageBreakAfter?this.style.pageBreakAfter:""}}}),sML.UA.InternetExplorer&&sML.each(e.Body.getElementsByTagName("svg"),function(){var e=this.getElementsByTagName("image");if(1==e.length){var t=e[0];t.getAttribute("width")&&t.getAttribute("height")&&(this.setAttribute("width",t.getAttribute("width")),this.setAttribute("height",t.getAttribute("height")))}})},L.postprocessItem.defineViewport=function(e){var t=e.ItemRef;if(sML.each(e.Head.getElementsByTagName("meta"),function(){if("viewport"==this.name&&(t.viewport.content=this.getAttribute("content"),t.viewport.content)){var e=1*t.viewport.content.replace(/^.*?width=([^\, ]+).*$/,"$1"),n=1*t.viewport.content.replace(/^.*?height=([^\, ]+).*$/,"$1");isNaN(e)||isNaN(n)||(t.viewport.width=e,t.viewport.height=n)}}),"pre-paginated"==t["rendition:layout"]&&!(t.viewport.width*t.viewport.height)){var n=e.Body.firstElementChild;if(e.SingleSVGOnlyItem){if(n.getAttribute("viewBox")){t.viewBox.content=n.getAttribute("viewBox");var i=t.viewBox.content.split(" ");if(4==i.length){var r=1*i[2]-1*i[0],a=1*i[3]-1*i[1];r&&a&&("100%"!=n.getAttribute("width")&&n.setAttribute("width","100%"),"100%"!=n.getAttribute("height")&&n.setAttribute("height","100%"),t.viewport.width=t.viewBox.width=r,t.viewport.height=t.viewBox.height=a)}}}else e.SingleIMGOnlyItem&&(t.viewport.width=parseInt(getComputedStyle(n).width),t.viewport.height=parseInt(getComputedStyle(n).height))}},L.postprocessItem.coordinateLinkages=function(e,t){var n=e.Path,i=e.Body;sML.each(i.getElementsByTagName("a"),function(e){var i=this;i.NavANumber=e+1;var r=i.getAttribute("href");if(!r)return void(t&&(i.addEventListener("click",function(e){return e.preventDefault(),e.stopPropagation(),!1}),sML.addClass(i,"bibi-bookinfo-inactive-link")));if(/^[a-zA-Z]+:/.test(r)){if(r.split("#")[0]!=location.href.split("#")[0])return i.setAttribute("target",i.getAttribute("target")||"_blank");var a=r.split("#")[1];r=a?"#"+a:R.Items[0].Path}var o=O.getPath(n.replace(/\/?([^\/]+)$/,""),(/^\.*\/+/.test(r)?"":"./")+(/^#/.test(r)?n.replace(/^.+?([^\/]+)$/,"$1"):"")+r),s=o.split("#"),l=s[0]?s[0]:n,d=s[1]?s[1]:"";R.Items.forEach(function(e){return l==e.Path?(i.setAttribute("data-bibi-original-href",r),i.setAttribute("href","bibi://"+B.Path.replace(/^\w+:\/\//,"")+"/"+r),i.InNav=t,i.Target={Item:e,ElementSelector:d?"#"+d:void 0},void i.addEventListener("click",L.postprocessItem.coordinateLinkages.jump)):void 0}),d&&/^epubcfi\(.+\)$/.test(d)&&(i.setAttribute("data-bibi-original-href",r),i.setAttribute("href","bibi://"+B.Path.replace(/^\w+:\/\//,"")+"/#"+d),i.InNav=t,i.Target=U.getEPUBCFITarget(d),i.addEventListener("click",L.postprocessItem.coordinateLinkages.jump)),t&&typeof S.nav==e+1&&i.Target&&(S.to=i.Target)})},L.postprocessItem.coordinateLinkages.jump=function(e){if(e.preventDefault(),e.stopPropagation(),this.Target){var t=this,n=R.Started?function(){R.focus(t.Target)}:function(){if(O.SmartPhone){var e=location.href;return"number"==typeof t.NavANumber&&(e+=(/#/.test(e)?",":"#")+"pipi(nav:"+t.NavANumber+")"),window.open(e)}S.to=t.Target,L.play()};t.InNav?C.Panel.toggle(n):n()}return!1},L.postprocessItem.patchWritingModeStyle=function(e){(sML.UA.Gecko||sML.UA.InternetExplorer)&&sML.each(e.contentDocument.styleSheets,function(){for(var e=this,t=e.cssRules.length,n=0;t>n;n++){var i=this.cssRules[n];i.cssRules?arguments.callee.call(i):i.styleSheet?arguments.callee.call(i.styleSheet):O.translateWritingMode(i)}});var t=getComputedStyle(e.HTML),n=getComputedStyle(e.Body);t[O.WritingModeProperty]!=n[O.WritingModeProperty]&&sML.style(e.HTML,{"writing-mode":n[O.WritingModeProperty]}),e.HTML.WritingMode=O.getWritingMode(e.HTML),sML.addClass(e.HTML,"writing-mode-"+e.HTML.WritingMode),/-rl$/.test(e.HTML.WritingMode)&&(n.marginLeft!=n.marginRight?e.Body.style.marginLeft=n.marginRight:/-lr$/.test(e.HTML.WritingMode)&&(n.marginRight!=n.marginLeft?e.Body.style.marginRight=n.marginLeft:n.marginBottom!=n.marginTop&&(e.Body.style.marginBottom=n.marginTop)))},L.postprocessItem.applyBackgroundStyle=function(e){e.HTML.style&&(sML.style(e.ItemBox,L.postprocessItem.applyBackgroundStyle.getBackgroundStyle(e.HTML)),e.HTML.style.background="transparent"),e.Body.style&&(sML.style(e,L.postprocessItem.applyBackgroundStyle.getBackgroundStyle(e.Body)),e.Body.style.background="transparent")},L.postprocessItem.applyBackgroundStyle.getBackgroundStyle=function(e){var t=getComputedStyle(e);return{backgroundColor:t.backgroundColor,backgroundImage:t.backgroundImage,backgroundRepeat:t.backgroundRepeat,backgroundPosition:t.backgroundPosition,backgroundSize:t.backgroundSize}},L.start=function(){O.stopLoading(),R.layout({Target:S.to?S.to:"head"}),window.removeEventListener("resize",L.listenResizingWhileLoading),delete L.listenResizingWhileLoading,setTimeout(function(){sML.removeClass(O.HTML,"preparing"),C.Veil.close(function(){setTimeout(function(){document.body.click()},500)}),E.dispatch("bibi:start"),M.post("bibi:start"),O.log(1,"Enjoy Readings!"),O.stamp("Enjoy"),R.Started=!0},1)},R.initialize=function(){sML.addClass(O.HTML,"preparing"),R.Main.Book.innerHTML=R.Sub.innerHTML="",R.Spreads=[],R.Items=[],R.Pages=[],R.CoverImage={Path:""},R.Current={}},R.resetStage=function(){R.Stage={},R.Stage.Width=Math.min(window.innerWidth,O.HTML.clientWidth),R.Stage.Height=Math.min(window.innerHeight,O.HTML.clientHeight),R.Stage.Width=R.Main.offsetWidth,R.Stage.Height=R.Main.offsetHeight,R.Stage.Orientation=R.Stage.Width/R.Stage.Height>1.4?"landscape":"portrait",R.Stage.PageGap="paged"==S.RVM?0:S["spread-gap"],R.Stage.Breadth=R.Stage[S.SIZE.B]-("paged"==S.RVM?0:S["spread-margin-start"]+S["spread-margin-end"]),R.Stage.BunkoLength=Math.floor(R.Stage.Breadth*R.DefaultPageRatio[S.AXIS.L]/R.DefaultPageRatio[S.AXIS.B]),R.Stage.Length=R.Stage[S.SIZE.L]-("paged"==S.RVM?0:2*S["spread-gap"]),R.Main.Book.style.padding=R.Main.Book.style.width=R.Main.Book.style.height="",R.Main.Book.style["padding"+S.BASE.S]=R.Main.Book.style["padding"+S.BASE.E]="paged"==S.RVM?0:S["spread-margin-start"]+"px",R.Columned=!1,S["book-background"]&&(O.HTML.style.background=S["book-background"])},R.resetSpread=function(e){O.stamp("Reset Spread "+e.SpreadIndex+" Start"),e.Items.forEach(function(e){R.resetItem(e)});var t=e.SpreadBox;if(t.style["margin"+S.BASE.B]=t.style["margin"+S.BASE.A]="",t.style["margin"+S.BASE.E]=t.style["margin"+S.BASE.S]="auto",t.style.padding=t.style.width=t.style.height="","reflowable"==e.RenditionLayout||"reflowable"==S.BRL&&"vertical"==S.SLA)if(2==e.Items.length)if(R.Stage.Width>e.Items[0].ItemBox.offsetWidth+e.Items[1].ItemBox.offsetWidth)var n=e.Items[0].ItemBox.offsetWidth+e.Items[1].ItemBox.offsetWidth,i=Math.max(e.Items[0].ItemBox.offsetHeight,e.Items[1].ItemBox.style.offsetHeight);else var n=Math.max(e.Items[0].ItemBox.offsetWidth,e.Items[1].ItemBox.offsetWidth),i=e.Items[0].ItemBox.offsetHeight+e.Items[1].ItemBox.offsetHeight;else var n=e.Items[0].ItemBox.offsetWidth,i=e.Items[0].ItemBox.offsetHeight;else if(2==e.Items.length)var n=e.Items[0].ItemBox.offsetWidth+e.Items[1].ItemBox.offsetWidth,i=Math.max(e.Items[0].ItemBox.offsetHeight,e.Items[1].ItemBox.style.offsetHeight);else var n=e.Items[0].ItemBox.offsetWidth*("left"==e.Items[0].ItemRef["page-spread"]||"right"==e.Items[0].ItemRef["page-spread"]?2:1),i=e.Items[0].ItemBox.offsetHeight;t.style.width=Math.ceil(n)+"px",t.style.height=Math.ceil(i)+"px",e.style["border-radius"]=S["spread-border-radius"],e.style["box-shadow"]=S["spread-box-shadow"],O.stamp("Reset Spread "+e.SpreadIndex+" End")},R.DefaultPageRatio={X:103,Y:148},R.resetItem=function(e){O.stamp("Reset Item "+e.ItemIndex+" Start"),O.stamp("Reset Start",e.TimeCard),E.dispatch("bibi:before:resetItem",e),e.Reset=!1,e.Pages=[],e.scrolling="no",e.Spreaded=!1,e.style.margin=e.style.padding=e.style.width=e.style.height="",e.HTML.style[S.SIZE.b]=e.HTML.style[S.SIZE.l]="",sML.style(e.HTML,{"transform-origin":"",transformOrigin:"",transform:"","column-width":"","column-gap":"","column-rule":""}),e.Columned=!1,e.ColumnBreadth=0,e.ColumnLength=0,e.ColumnGap=0,e.PrePaginated?R.resetItem.asPrePaginatedItem(e):e.Outsourcing?R.resetItem.asReflowableOutsourcingItem(e):R.resetItem.asReflowableItem(e),e.Reset=!0,E.dispatch("bibi:resetItem",e),O.stamp("Reset End",e.TimeCard),O.stamp("Reset Item "+e.ItemIndex+" End")},R.resetItem.asReflowableItem=function(e){var t=(e.ItemIndex,e.ItemRef),n=e.ItemBox,i=e.Spread,r=R.Stage.Breadth,a=R.Stage.Length,o=R.Stage.PageGap;/fill/.test(t["bibi:layout"])||(r-=S["item-padding-"+S.BASE.s]+S["item-padding-"+S.BASE.e],a-=S["item-padding-"+S.BASE.b]+S["item-padding-"+S.BASE.a],o+=S["item-padding-"+S.BASE.b]+S["item-padding-"+S.BASE.a],e.style["padding-"+S.BASE.b]=S["item-padding-"+S.BASE.b]+"px",e.style["padding-"+S.BASE.a]=S["item-padding-"+S.BASE.a]+"px",e.style["padding-"+S.BASE.s]=S["item-padding-"+S.BASE.s]+"px",e.style["padding-"+S.BASE.e]=S["item-padding-"+S.BASE.e]+"px");var s=r,l=a;if("horizontal"==S.SLA&&!/fill-spread/.test(t["bibi:layout"])){var d=Math.floor(s*R.DefaultPageRatio[S.AXIS.L]/R.DefaultPageRatio[S.AXIS.B]),c=Math.floor((a-o)/2);c>=d&&(e.Spreaded=!0,l=c)}e.style[S.SIZE.b]=s+"px",e.style[S.SIZE.l]=l+"px",R.resetItem.asReflowableItem.adjustContent(e,s,l,o);var u=sML.UA.InternetExplorer?e.Body["client"+S.SIZE.L]:e.HTML["scroll"+S.SIZE.L],g=Math.ceil((u+o)/(l+o));u=(l+o)*g-o,e.style[S.SIZE.l]=u+"px";var p=s,f=u+("paged"==S.RVM&&e.Spreaded&&g%2?o+l:0);/fill/.test(t["bibi:layout"])||(p+=S["item-padding-"+S.BASE.s]+S["item-padding-"+S.BASE.e],f+=S["item-padding-"+S.BASE.b]+S["item-padding-"+S.BASE.a]),n.style[S.SIZE.b]=p+"px",n.style[S.SIZE.l]=f+"px";
for(var h=0;g>h;h++){var m=n.appendChild(sML.create("span",{className:"page"}));/fill/.test(t["bibi:layout"])||(m.style["padding"+S.BASE.B]=S["item-padding-"+S.BASE.b]+"px",m.style["padding"+S.BASE.A]=S["item-padding-"+S.BASE.a]+"px",m.style["padding"+S.BASE.S]=S["item-padding-"+S.BASE.s]+"px",m.style["padding"+S.BASE.E]=S["item-padding-"+S.BASE.e]+"px"),m.style[S.SIZE.b]=s+"px",m.style[S.SIZE.l]=l+"px",m.style[S.BASE.b]=(l+o)*h+"px",m.Item=e,m.Spread=i,m.PageIndexInItem=e.Pages.length,e.Pages.push(m)}return e},R.resetItem.asReflowableItem.adjustContent=function(e,t,n,i){E.dispatch("bibi:before:resetItem.asReflowableItem.adjustContent",e);var r=sML.CSS.addRule("*","word-wrap: break-word;",e.contentDocument);R.resetItem.asReflowableItem.adjustContent.fitImages(e,t,n),R.resetItem.asReflowableItem.adjustContent.columify(e,t,n,i),S["page-breaking"]&&R.resetItem.asReflowableItem.adjustContent.breakPages(e,t),sML.CSS.removeRule(r,e.contentDocument)},R.resetItem.asReflowableItem.adjustContent.fitImages=function(e,t,n){sML.each(e.Body.getElementsByTagName("img"),function(){if(this.Bibi&&this.Bibi.DefaultStyle){this.style.width=this.Bibi.DefaultStyle.width,this.style.height=this.Bibi.DefaultStyle.height;var i=parseFloat(getComputedStyle(this)[S.SIZE.b]),r=parseFloat(getComputedStyle(this)[S.SIZE.l]),a=Math.floor(Math.min(parseFloat(getComputedStyle(e.Body)[S.SIZE.b]),t)),o=Math.floor(Math.min(parseFloat(getComputedStyle(e.Body)[S.SIZE.l]),n));(i>a||r>o)&&(this.style[S.SIZE.b]=Math.floor(parseFloat(getComputedStyle(this)[S.SIZE.b])*Math.min(a/i,o/r))+"px",this.style[S.SIZE.l]="auto")}})},R.resetItem.asReflowableItem.adjustContent.columify=function(e,t,n,i){("paged"==S.RVM||e.HTML["offset"+S.SIZE.B]>t)&&(R.Columned=e.Columned=!0,e.ColumnBreadth=t,e.ColumnLength=n,e.ColumnGap=i,e.HTML.style[S.SIZE.b]=t+"px",e.HTML.style[S.SIZE.l]=n+"px",sML.style(e.HTML,{"column-fill":"auto","column-width":e.ColumnLength+"px","column-gap":e.ColumnGap+"px","column-rule":""}))},R.resetItem.asReflowableItem.adjustContent.breakPages=function(e,t){var n;n=e.Body["offset"+S.SIZE.B]<=t?["vertical"==S.SLA?"Top":"Left",window["inner"+S.SIZE.L],S.SIZE.L,S.SIZE.l,S.BASE.a]:["vertical"==S.SLA?"Left":"Top",t,S.SIZE.B,S.SIZE.b,S.BASE.e],sML.each(e.contentDocument.querySelectorAll("html>body *"),function(){var e=getComputedStyle(this);if("always"==e.pageBreakBefore||"always"==e.pageBreakAfter){this.BibiPageBreakerBefore&&(this.BibiPageBreakerBefore.style[n[3]]=""),this.BibiPageBreakerAfter&&(this.BibiPageBreakerAfter.style[n[3]]="");for(var t=this,i=t["offset"+n[0]],r=0;t.offsetParent;)t=t.offsetParent,i+=t["offset"+n[0]];"rtl"==S.SLD&&(i=window.innerWidth+-1*i-this["offset"+n[2]]),"always"==e.pageBreakBefore&&(this.BibiPageBreakerBefore||(this.BibiPageBreakerBefore=sML.insertBefore(sML.create("span",{className:"bibi-page-breaker-before"},{display:"block"}),this)),r=n[1]-i%n[1],r==n[1]&&(r=0),this.BibiPageBreakerBefore.style[n[3]]=r+"px"),"always"==e.pageBreakAfter&&(i+=r+this["offset"+n[2]],this.style["margin-"+n[4]]=0,this.BibiPageBreakerAfter||(this.BibiPageBreakerAfter=sML.insertAfter(sML.create("span",{className:"bibi-page-breaker-after"},{display:"block"}),this)),r=n[1]-i%n[1],r==n[1]&&(r=0),this.BibiPageBreakerAfter.style[n[3]]=r+"px")}})},R.resetItem.asReflowableOutsourcingItem=function(e,t){var n=(e.ItemIndex,e.ItemRef),i=e.ItemBox,r=e.Spread;e.style.margin="auto",e.style.padding=0;var a=R.Stage.Breadth,o=R.Stage.Length,s=R.Stage.PageGap,l=a,d=o;if("horizontal"==S.SLA&&!/fill-spread/.test(n["bibi:layout"])){var c=Math.floor(l*R.DefaultPageRatio[S.AXIS.L]/R.DefaultPageRatio[S.AXIS.B]),u=Math.floor((o-s)/2);u>c&&(e.Spreaded=!0,d=u)}if(e.style[S.SIZE.b]=i.style[S.SIZE.b]=l+"px",e.style[S.SIZE.l]=i.style[S.SIZE.l]=d+"px",e.ImageItem){if(e.Body["scroll"+S.SIZE.B]<=l&&e.Body["scroll"+S.SIZE.L]<=d){var g=getComputedStyle(e.Body);e.style.width=e.Body.offsetWidth+parseFloat(g.marginLeft)+parseFloat(g.marginRight)+"px"}else{if("ttb"==S.SLD&&e.Body["scroll"+S.SIZE.B]>l||"horizontal"==S.SLA&&e.Body["scroll"+S.SIZE.L]>d)var p=/rl/.test(e.HTML.WritingMode)?"100% 0":"0 0";else var p="50% 0";var f=Math.floor(100*Math.min(l/e.Body["scroll"+S.SIZE.B],d/e.Body["scroll"+S.SIZE.L]))/100;sML.style(e.HTML,{"transform-origin":p,transform:"scale("+f+")"})}sML.each(e.Body.getElementsByTagName("img"),function(){var e=this;e.style.maxWidth="none",setTimeout(function(){e.style.maxWidth=""},0)})}else if(e.FrameItem){var h=e.Body.getElementsByTagName("iframe")[0];h.style[S.SIZE.b]=h.style[S.SIZE.l]="100%"}var m=i.appendChild(sML.create("span",{className:"page"}));return m.style[S.SIZE.b]=l+"px",m.style[S.SIZE.l]=d+"px",m.style[S.BASE.b]=0,m.Item=e,m.Spread=r,m.PageIndexInItem=e.Pages.length,e.Pages.push(m),e},R.resetItem.asPrePaginatedItem=function(e){var t=(e.ItemIndex,e.ItemRef),n=e.ItemBox,i=e.Spread;e.HTML.style.margin=e.HTML.style.padding=e.Body.style.margin=e.Body.style.padding=0;var r=R.Stage.Breadth,a=R.Stage.Length,o=r,s=a;if(e.style.padding=0,e.Scale){var l=e.Scale;delete e.Scale}else{var l=1;if("pre-paginated"==S.BRL&&"vertical"==S.SLA||R.Stage.Orientation==t["rendition:spread"]||"both"==t["rendition:spread"]){var d={width:t.viewport.width,height:t.viewport.height};e.Pair?d.width+=e.Pair.ItemRef.viewport.width:("right"==t["page-spread"]||"left"==t["page-spread"])&&(d.width+=d.width),l=Math.min(o/d[S.SIZE.b],s/d[S.SIZE.l])}else l=Math.min(o/t.viewport[S.SIZE.b],s/t.viewport[S.SIZE.l]);e.Pair&&(e.Pair.Scale=l)}s=Math.floor(t.viewport[S.SIZE.l]*l),o=Math.floor(t.viewport[S.SIZE.b]*(s/t.viewport[S.SIZE.l])),n.style[S.SIZE.l]=e.style[S.SIZE.l]=s+"px",n.style[S.SIZE.b]=e.style[S.SIZE.b]=o+"px";var c=/rl/.test(e.HTML.WritingMode)?"100% 0":"0 0";sML.style(e.HTML,{width:t.viewport.width+"px",height:t.viewport.height+"px","transform-origin":c,transformOrigin:c,transform:"scale("+l+")"});var u=n.appendChild(sML.create("span",{className:"page"}));return"right"==t["page-spread"]?u.style.right=0:u.style.left=0,u.style[S.SIZE.b]=o+"px",u.style[S.SIZE.l]=s+"px",u.Item=e,u.Spread=i,u.PageIndexInItem=e.Pages.length,e.Pages.push(u),e},R.resetPages=function(){return R.Pages.forEach(function(e){e.parentNode.removeChild(e),delete e}),R.Pages=[],R.Spreads.forEach(function(e){e.Pages=[],e.Items.forEach(function(t){t.Pages.forEach(function(t){t.PageIndexInSpread=e.Pages.length,e.Pages.push(t),t.PageIndex=R.Pages.length,R.Pages.push(t),t.id="page-"+sML.String.padZero(t.PageIndex,B.FileDigit)})})}),R.Pages},R.resetNavigation=function(){},R.layoutSpread=function(e){O.stamp("Layout Spread "+e.SpreadIndex+" Start");var t=e.SpreadBox;t.style.padding="";var n=0,i=0,r="paged"==S.RVM?0:S["spread-gap"];if("horizontal"==S.SLA&&t.offsetHeight<R.Stage.Breadth&&(SpreadBoxPaddingTop=Math.floor((R.Stage.Breadth-t.offsetHeight)/2),SpreadBoxPaddingBottom=R.Stage.Breadth-(SpreadBoxPaddingTop+t.offsetHeight),t.style.paddingTop=SpreadBoxPaddingTop+"px",t.style.paddingBottom=SpreadBoxPaddingBottom+"px"),0==e.SpreadIndex){var a=Math.floor((window["inner"+S.SIZE.L]-t["offset"+S.SIZE.L])/2);n=a,"paged"==S.RVM&&(i=a)}else n="reflowable"==S.BRL?r:Math.floor(R.Stage.Length/4);r>n&&(n=r),e.SpreadIndex==R.Spreads.length-1&&(i+=Math.ceil((R.Stage.Length-t["offset"+S.SIZE.L])/2),r>i&&(i=r)),n&&(t.style["padding"+S.BASE.B]=n+"px"),i&&(t.style["padding"+S.BASE.A]=i+"px");var o=0;R.Spreads.forEach(function(e){o+=e.SpreadBox["offset"+S.SIZE.L]}),R.Main.Book.style[S.SIZE.b]="",R.Main.Book.style[S.SIZE.l]=o+"px",O.stamp("Layout Spread "+e.SpreadIndex+" End")},R.layout=function(e){if(R.Layouted&&R.ToRelayout||O.log(2,"Laying Out..."),O.stamp("Layout Start"),R.Layouted=!0,window.removeEventListener(O.SmartPhone?"orientationchange":"resize",R.onresize),R.Frame.removeEventListener("scroll",R.onscroll),e||(e={}),!e.Target){var t=R.getCurrentPages().StartPage;e.Target={SpreadIndex:t.Spread.SpreadIndex,PageProgressInSpread:t.PageIndexInSpread/t.Spread.Pages.length}}e.Setting&&S.update(e.Setting),e.Reset||R.ToRelayout?(R.ToRelayout=!1,R.resetStage(),R.Spreads.forEach(function(e){R.resetSpread(e),R.layoutSpread(e)}),R.resetPages(),R.resetNavigation()):R.Spreads.forEach(function(e){R.layoutSpread(e)}),R.Columned=!1;for(var n=0,i=R.Items.length;i>n;n++){var r=R.Items[n].HTML.style;if(r["-webkit-column-width"]||r["-moz-column-width"]||r["-ms-column-width"]||r["column-width"]){R.Columned=!0;break}}return setTimeout(function(){R.focus(e.Target,{Duration:0,Easing:0})},100),O.log(3,"rendition:layout: "+S.BRL),O.log(3,"page-progression-direction: "+S.PPD),O.log(3,"reader-view-mode: "+S.RVM),"function"==typeof doAfter&&doAfter(),window.addEventListener(O.SmartPhone?"orientationchange":"resize",R.onresize),R.Frame.addEventListener("scroll",R.onscroll),E.dispatch("bibi:layout"),O.stamp("Layout End"),O.log(2,"Laid Out."),S},R.Relayouting=0,R.relayout=function(e){if(!R.Relayouting){N.note("Relaying Out..."),O.stamp("Relayout Start"),R.Relayouting++;var t=R.getCurrentPages(),n=t.StartPage?{SpreadIndex:t.StartPage.Spread.SpreadIndex,PageProgressInSpread:t.StartPage.PageIndexInSpread/t.StartPage.Spread.Pages.length}:{SpreadIndex:0,PageProgressInSpread:0};setTimeout(function(){window.removeEventListener(O.SmartPhone?"orientationchange":"resize",R.onresize),R.Frame.removeEventListener("scroll",R.onscroll),sML.addClass(O.HTML,"preparing"),setTimeout(function(){R.layout({Target:n,Reset:!0,Setting:e&&e.Setting?e.Setting:void 0}),R.Relayouting--,R.Relayouting||setTimeout(function(){sML.removeClass(O.HTML,"preparing"),window.addEventListener(O.SmartPhone?"orientationchange":"resize",R.onresize),R.Frame.addEventListener("scroll",R.onscroll),e&&"function"==typeof e.callback&&e.callback(),E.dispatch("bibi:relayout"),O.stamp("Relayout End"),N.note("")},100)},100)},222)}},R.onscroll=function(){R.Started&&(clearTimeout(R.Timer_onscroll),R.Timer_onscroll=setTimeout(R.onscrolled,123))},R.onscrolled=function(){R.getCurrent(),E.dispatch("bibi:scrolled")},R.onresize=function(){R.Started&&(clearTimeout(R.Timer_onresize),R.Timer_onresize=setTimeout(R.onresized,888))},R.onresized=function(){R.relayout(),E.dispatch("bibi:resized")},R.changeView=function(e){return S["reader-view-mode-fixed"]||"string"!=typeof e||S.RVM==e?!1:R.Started?("paged"!=e&&R.Spreads.forEach(function(e){e.style.opacity=""}),void R.relayout({Setting:{"reader-view-mode":e},callback:function(){E.dispatch("bibi:changeView",e)}})):(S.update({"reader-view-mode":e}),L.play())},R.getCurrentPages=function(){var e=sML.Coord.getScrollCoord(R.Frame),t=sML.Coord.getClientSize(R.Frame);e={Left:e.X,Right:e.X+t.Width,Top:e.Y,Bottom:e.Y+t.Height},e.Before=e[S.BASE.B]/R.Scale,e.After=e[S.BASE.A]/R.Scale;for(var n=[],i=[],r=[],a=0,o=0,s=R.Pages.length;s>o;o++){var l=sML.getCoord(R.Pages[o]);l.Before=l[S.BASE.B],l.After=l[S.BASE.A];var d=Math.min(e.After*S.AXIS.PM,l.After*S.AXIS.PM)-Math.max(e.Before*S.AXIS.PM,l.Before*S.AXIS.PM),c=0>=d||!l[S.SIZE.L]||isNaN(d)?0:Math.round(d/l[S.SIZE.L]*100);if(0>=c){if(n.length)break}else c>a?(n[0]=R.Pages[o],i[0]=c,r[0]=R.getCurrentPages.getStatus(c,l,e),a=c):c==a&&(n.push(R.Pages[o]),i.push(c),r.push(R.getCurrentPages.getStatus(c,l,e)))}return{Pages:n,Ratio:i,Status:r,StartPage:n[0],StartPageRatio:i[0],StartPageStatus:r[0],EndPage:n[n.length-1],EndPageRatio:i[i.length-1],EndPageStatus:r[r.length-1]}},R.getCurrentPages.getStatus=function(e,t,n){if(e>=100)return"including";var i=[];window["inner"+S.SIZE.L]<t[S.SIZE.L]&&i.push("oversize");var r=n.Before-S["spread-gap"]/2,a=n.After+S["spread-gap"]/2;return r*S.AXIS.PM<t.Before*S.AXIS.PM&&i.push("entering"),r*S.AXIS.PM==t.Before*S.AXIS.PM&&i.push("entered"),a*S.AXIS.PM==t.After*S.AXIS.PM&&i.push("passsing"),a*S.AXIS.PM>t.After*S.AXIS.PM&&i.push("passed"),i.join(" ")},R.getCurrent=function(){return R.Current.Pages=R.getCurrentPages(),R.Current.Page=R.Current.Pages.EndPage,R.Current.PageNumber=R.Current.Page.PageIndex+1,R.Current.Item=R.Current.Page.Item,R.Current.ItemNumber=R.Current.Item.ItemIndex+1,R.Current.Percent=Math.round(R.Current.PageNumber/R.Pages.length*100),R.Current},R.focus=function(e,t){if(e=R.focus.hatchTarget(e),!e)return!1;var n=0;"reflowable"==S["book-rendition-layout"]?"head"==e.Edge?n="rtl"!=S.SLD?0:R.Main.Book["offset"+[S.SIZE.L]]-sML.Coord.getClientSize(R.Frame)[S.SIZE.L]:"foot"==e.Edge?n="rtl"==S.SLD?0:R.Main.Book["offset"+[S.SIZE.L]]-sML.Coord.getClientSize(R.Frame)[S.SIZE.L]:(n=O.getElementCoord(e.Page)[S.AXIS.L],"after"==e.Side?n+=(e.Page["offset"+S.SIZE.L]+S["spread-gap"]-window["inner"+S.SIZE.L])*S.AXIS.PM:n-=S["spread-gap"]*S.AXIS.PM,"rtl"==S.SLD&&(n+=e.Page.offsetWidth-window.innerWidth)):window["inner"+S.SIZE.L]>e.Page.Spread["offset"+S.SIZE.L]?(n=O.getElementCoord(e.Page.Spread)[S.AXIS.L],n-=Math.floor((window["inner"+S.SIZE.L]-e.Page.Spread["offset"+S.SIZE.L])/2)):(n=O.getElementCoord(e.Page)[S.AXIS.L],window["inner"+S.SIZE.L]>e.Page["offset"+S.SIZE.L]&&(n-=Math.floor((window["inner"+S.SIZE.L]-e.Page["offset"+S.SIZE.L])/2))),"number"==typeof e.TextNodeIndex&&R.selectTextLocation(e);var i={X:0,Y:0};return i[S.AXIS.L]=n*R.Scale,"paged"==S.RVM?sML.scrollTo(R.Frame,i,{Duration:1}):sML.scrollTo(R.Frame,i,t),!1},R.focus.hatchTarget=function(e){return e?("number"==typeof e||"string"==typeof e&&/^\d+$/.test(e)?e=U.getBibiToTarget(e):"string"==typeof e?e="head"==e||"foot"==e?{Edge:e}:U.getEPUBCFITarget(e):e.tagName&&(e="number"==typeof e.PageIndex?{Page:e}:"number"==typeof e.ItemIndex?{Item:e}:"number"==typeof e.SpreadIndex?{Spread:e}:{Element:e}),e.Page&&!e.Page.parentElement&&delete e.Page,e.Item&&!e.Item.parentElement&&delete e.Item,e.Spread&&!e.Spread.parentElement&&delete e.Spread,e.Element&&!e.Element.parentElement&&delete e.Element,"string"==typeof e.Edge?"head"==e.Edge?e.Page=R.Pages[0]:(e.Page=R.Pages[R.Pages.length-1],e.Edge="foot"):(e.Element||(e.Item||("number"==typeof e.ItemIndex?e.Item=R.Items[e.ItemIndex]:(e.Spread||"number"!=typeof e.SpreadIndex||(e.Spread=R.Spreads[e.SpreadIndex]),e.Spread&&("number"==typeof e.PageIndexInSpread?e.Page=e.Spread.Pages[e.PageIndexInSpread]:"number"==typeof e.ItemIndexInSpread?e.Item=e.Spread.Items[e.ItemIndexInSpread]:e.Item=e.Spread.Items[0]))),e.Item&&"string"==typeof e.ElementSelector&&(e.Element=e.Item.contentDocument.querySelector(e.ElementSelector))),e.Element?e.Page=R.focus.getNearestPageOfElement(e.Element):e.Page||("number"==typeof e.PageIndexInSpread?e.Page=e.Spread.Pages[e.PageIndexInSpread]:"number"==typeof e.PageProgressInSpread?e.Page=e.Spread.Pages[Math.floor(e.Spread.Pages.length*e.PageProgressInSpread)]:e.Page=e.Item.Pages[0])),e.Page?(e.Item=e.Page.Item,e.Spread=e.Page.Spread,e):null):null},R.focus.getNearestPageOfElement=function(e){var t=e.ownerDocument.body.Item;if(!t)return R.Pages[0];if(t.Columned){sML.style(t.HTML,{"column-width":""});var n=O.getElementCoord(e)[S.AXIS.B];"rtl"==S.PPD&&"vertical"==S.SLA&&(n=t.offsetWidth-(S["item-padding-left"]+S["item-padding-right"])-n-e.offsetWidth),sML.style(t.HTML,{"column-width":t.ColumnLength+"px"});var i=t.Pages[Math.ceil(n/t.ColumnBreadth-1)]}else{var n=O.getElementCoord(e)[S.AXIS.L];"rtl"==S.SLD&&"horizontal"==S.SLA&&(n=t.HTML.offsetWidth-n-e.offsetWidth);for(var i=t.Pages[0],r=0,a=t.Pages.length;a>r;r++)if(n-=t.Pages[r]["offset"+S.SIZE.L],0>=n){i=t.Pages[r];break}}return i},R.selectTextLocation=function(e){if("number"==typeof e.TextNodeIndex){var t=e.Element.childNodes[e.TextNodeIndex];if(t&&t.textContent){var n={Start:{Node:t,Index:0},End:{Node:t,Index:t.textContent.length}};if(e.TermStep)if(e.TermStep.Preceding||e.TermStep.Following){if(n.Start.Index=e.TermStep.Index,n.End.Index=e.TermStep.Index,e.TermStep.Preceding&&(n.Start.Index-=e.TermStep.Preceding.length),e.TermStep.Following&&(n.End.Index+=e.TermStep.Following.length),n.Start.Index<0||t.textContent.length<n.End.Index)return;if(t.textContent.substr(n.Start.Index,n.End.Index-n.Start.Index)!=e.TermStep.Preceding+e.TermStep.Following)return}else if(e.TermStep.Side&&"a"==e.TermStep.Side){for(n.Start.Node=t.parentNode.firstChild;n.Start.Node.childNodes.length;)n.Start.Node=n.Start.Node.firstChild;n.End.Index=e.TermStep.Index-1}else{for(n.Start.Index=e.TermStep.Index,n.End.Node=t.parentNode.lastChild;n.End.Node.childNodes.length;)n.End.Node=n.End.Node.lastChild;n.End.Index=n.End.Node.textContent.length}return sML.select(n)}}},R.move=function(e){if(R.Started&&!isNaN(e)){if(e*=1,-1!=e&&(e=1),e>0)var t="EndPage",n="before";else var t="StartPage",n="after";R.Current.Pages=R.getCurrentPages();var i=R.Current.Pages[t];if(R.Columned||"pre-paginated"==S.BRL||1==i.Item.Pages.length||i.Item.PrePaginated||i.Item.Outsourcing){var r=R.Current.Pages[t+"Status"],a=R.Current.Pages[t+"Ratio"];/(oversize)/.test(r)?e>0?a>=90?n="before":/entering/.test(r)?(n="before",e=0):/entered/.test(r)&&(n="after",e=0):a>=90?n="after":/passing/.test(r)?(n="before",e=0):/passed/.test(r)&&(n="after",e=0):e>0?/enter/.test(r)&&(n="before",e=0):/pass/.test(r)&&(n="after",e=0);var o=i.PageIndex+e;0>o?o=0:o>R.Pages.length-1&&(o=R.Pages.length-1);var s=R.Pages[o];"pre-paginated"==S.BRL&&s.Item.Pair&&"horizontal"==S.SLA&&window["inner"+S.SIZE.L]>s.Spread["offset"+S.SIZE.L]&&(0>e&&0==s.PageIndexInSpread&&(s=s.Spread.Pages[1]),e>0&&1==s.PageIndexInSpread&&(s=s.Spread.Pages[0])),R.focus({Page:s,Side:n})}else sML.scrollTo(R.Frame,function(t){switch(S.SLD){case"ttb":return{Y:t.Y+(window.innerHeight-S["spread-gap"])*e};case"ltr":return{X:t.X+(window.innerWidth-S["spread-gap"])*e};case"rtl":return{X:t.X+(window.innerWidth-S["spread-gap"])*e*-1}}}(sML.Coord.getScrollCoord(R.Frame)));E.dispatch("bibi:move",e)}},R.page=R.scroll=R.move,R.to=function(e){return R.focus(U.getBibiToTarget(e))},R.Scale=1,R.zoom=function(e){("number"!=typeof e||0>=e)&&(e=1),R.Current.Pages=R.getCurrentPages();var t=R.Current.Pages.StartPage;sML.style(R.Main.Book,{"transform-origin":"rtl"==S.SLD?"100% 0":"0 0"}),1==e?(O.HTML.style.overflow="",sML.style(R.Main.Book,{transform:""})):(sML.style(R.Main.Book,{transform:"scale("+e+")"}),O.HTML.style.overflow="auto"),setTimeout(function(){R.focus({Page:t},{Duration:0,Easing:0})},0),R.Scale=e},N.createBoard=function(){N.Board=O.Body.appendChild(sML.create("div",{className:"hidden",id:"bibi-notifier-board"}))},N.note=function(e,t){t=e?"number"==typeof t?t:3210:0,N.Board.innerHTML="<p>"+e+"</p>",clearTimeout(N.hide_Timer),N.Board.style.display="block",setTimeout(function(){N.Board.className="",setTimeout(function(){N.hide_Timer=setTimeout(function(){N.Board.className="hidden",setTimeout(function(){N.Board.style.display="none"},200)},t)},0)},0),O.SmartPhone||(O.statusClearer&&clearTimeout(O.statusClearer),window.status="BiB/i: "+e,O.statusClearer=setTimeout(function(){window.status=""},t))},C.createVeil=function(){C.Veil=O.Body.appendChild(sML.create("div",{id:"bibi-veil",State:1,open:function(e){return 1==this.State?"function"==typeof e?e():this.State:(this.State=1,this.style.display="block",this.style.zIndex=100,sML.style(this,{transition:"0.5s ease-out",transform:"",opacity:.75},function(){"function"==typeof e&&e()}),this.State)},close:function(e){if(0==this.State)return"function"==typeof e?e():this.State;this.State=0;var t=function(e){if("vertical"!=S.RVM)var t="X",n="ltr"==S.PPD?-1:1;else var t="Y",n=-1;return"translate"+t+"("+e*n+"%)"};return sML.style(this,{transition:"0.5s ease-in",transform:t(240),opacity:0},function(){sML.style(this,{transition:"none",transform:t(-240)}),this.style.zIndex=1,this.style.display="none","function"==typeof e&&e()}),this.State},toggle:function(e){return 0==this.State?this.open(e):this.close(e)}})),C.Veil.Cover=C.Veil.appendChild(sML.create("div",{id:"bibi-veil-cover"})),C.Veil.Mark=C.Veil.appendChild(sML.create("div",{id:"bibi-veil-mark"}));for(var e=1;12>=e;e++)C.Veil.Mark.appendChild(sML.create("span"));C.Veil.Powered=C.Veil.appendChild(sML.create("p",{id:"bibi-veil-powered",innerHTML:O.getLogo({Color:"white",Linkify:!0})})),E.add("bibi:startLoading",function(){sML.addClass(O.HTML,"loading"),N.note("Loading...")}),E.add("bibi:stopLoading",function(){sML.removeClass(O.HTML,"loading"),N.note("")}),E.add("bibi:wait",function(){var e=(sML.OS.iOS||sML.OS.Android?"Tap":"Click")+" to Open";C.Veil.PlayButton=C.Veil.appendChild(sML.create("p",{id:"bibi-veil-playbutton",title:e,innerHTML:'<span class="non-visual">'+e+"</span>",play:function(e){e.stopPropagation(),L.play(),M.post("bibi:play:button:"+location.href),E.dispatch("bibi:play:button")},hide:function(){this.removeEventListener("click",C.Veil.PlayButton.play),sML.style(this,{opacity:0,cursor:"default"})}})),C.Veil.PlayButton.addEventListener("click",C.Veil.PlayButton.play),E.add("bibi:play",function(){C.Veil.PlayButton.hide()})}),E.dispatch("bibi:createVeil")},C.createPanel=function(){C.Panel=O.Body.appendChild(sML.create("div",{id:"bibi-panel",State:0,open:function(e){return 1==this.State?("function"==typeof e&&e(),1):(this.State=1,sML.addClass(O.HTML,"panel-opened"),E.dispatch("bibi:openPanel"),this.callback(e),this.State)},close:function(e){return 0==this.State?("function"==typeof e&&e(),0):(this.State=0,sML.removeClass(O.HTML,"panel-opened"),E.dispatch("bibi:closePanel"),this.callback(e),this.State)},toggle:function(e){return this.State?this.close():this.open(),E.dispatch("bibi:togglePanel",this.State),this.callback(e),this.State},callback:function(e){"function"==typeof e&&setTimeout(e,250)}})),C.Panel.addEventListener("click",function(){C.Panel.toggle()}),C.Panel.Powered=C.Panel.appendChild(sML.create("div",{id:"bibi-panel-powered",innerHTML:O.getLogo({Color:"black",Linkify:!0})})),C.Panel.BookInfo=C.Panel.appendChild(sML.create("div",{id:"bibi-panel-bookinfo"})),C.Panel.BookInfo.Box=C.Panel.BookInfo.appendChild(sML.create("div",{id:"bibi-panel-bookinfo-box"})),C.Panel.BookInfo.Navigation=C.Panel.BookInfo.Box.appendChild(sML.create("div",{id:"bibi-panel-bookinfo-navigation"})),C.Panel.BookInfo.Cover=C.Panel.BookInfo.Box.appendChild(sML.create("div",{id:"bibi-panel-bookinfo-cover"})),C.Panel.Menus=C.menu=C.Panel.appendChild(sML.create("div",{id:"bibi-panel-menus"})),C.Panel.Menus.addEventListener("click",function(e){e.stopPropagation()}),C.Switches=C["switch"]=O.Body.appendChild(sML.create("div",{id:"bibi-switches"},{transition:"opacity 0.75s linear"})),C.Switches.addEventListener("click",function(e){e.stopPropagation()}),C.Switches.Panel=C.addButton({id:"bibi-switch-panel",Category:"switch",Group:"panel",Labels:[{ja:"メニューを開く",en:"Open Menu"},{ja:"メニューを閉じる",en:"Close Menu"}],IconHTML:'<span class="bibi-icon bibi-switch bibi-switch-panel"></span>'},function(){C.Panel.toggle()}),E.add("bibi:openPanel",function(){C.setLabel(C.Switches.Panel,1)}),E.add("bibi:closePanel",function(){C.setLabel(C.Switches.Panel,0)}),E.add("bibi:start",function(){sML.style(C.Switches.Panel,{display:"block"})}),E.dispatch("bibi:createPanel")},C.setLabel=function(e,t){"number"!=typeof t&&(t=0);var n="ja"==B.Package.Metadata.languages[0].split("-")[0],i=e.Labels[e.Labels.length>1?t:0];return e.title=e.Label.innerHTML=(n?i.ja+" / ":"")+i.en,t},C.addButton=function(e,t){if("string"!=typeof e.Category||"string"!=typeof e.Group)return!1;C[e.Category][e.Group]||(C[e.Category][e.Group]=C[e.Category].appendChild(sML.create("ul")));var n=C[e.Category][e.Group].appendChild(sML.create("li",{className:"bibi-button",innerHTML:("string"==typeof e.IconHTML?e.IconHTML:'<span class="bibi-icon"></span>')+'<span class="bibi-button-label non-visual"></span>',Category:e.Category,Group:e.Group,Labels:e.Labels}));("string"==typeof e.id||/^[a-zA-Z_][a-zA-Z0-9_\-]*$/.test(e.id))&&(n.id=e.id),n.Label=n.querySelector(".bibi-icon").appendChild(sML.create("span",{className:"non-visual"})),n.addEventListener("click",function(){t()}),C[e.Category][e.Group].style.display="block";try{C.setLabel(n,0)}catch(i){E.add("bibi:readPackageDocument",function(){C.setLabel(n,0)})}return n},C.removeButton=function(e){if("string"==typeof e&&(e=document.getElementById(e)),!e)return!1;var t=e.parentNode;return t.removeChild(e),t.getElementsByTagName("li").length||(t.style.display="none"),!0},P.initialize=function(e){O.apply(e,P),/^(horizontal|vertical|paged)$/.test(P["reader-view-mode"])||(P["reader-view-mode"]="horizontal"),["spread-gap","spread-margin-start","spread-margin-end","item-padding-left","item-padding-right","item-padding-top","item-padding-bottom"].forEach(function(e){P[e]="number"!=typeof P[e]||P[e]<0?0:Math.round(P[e])}),P["spread-gap"]%2&&P["spread-gap"]++,/^([\w\d]+:)?\/+/.test(P.bookshelf)||(P.bookshelf=O.getPath(location.href.split("?")[0].replace(/[^\/]*$/,"")+P.bookshelf)),P["trustworthy-origins"]instanceof Array||(P["trustworthy-origins"]=[]),P["trustworthy-origins"][0]!=location.origin&&P["trustworthy-origins"].unshift(location.origin)},U.initialize=function(){var e=U.parseQuery(location.search),t=U.parseHash(location.hash);U.book=function(){var t=e.book?e.book:O.Body.getAttribute("data-bibi-book");return"string"!=typeof t?void 0:/^([\w\d]+:)?\/\//.test(t)&&(/^\/\//.test(t)&&(t=location.protocol+t),t.replace(/^([\w\d]+:\/\/[^\/]+).*$/,"$1")!=location.origin)?void 0:t}(),t.epubcfi&&(U.epubcfi=t.epubcfi,U.to=U.getEPUBCFITarget(t.epubcfi));var n=function(e){return"string"!=typeof e?{}:void e.replace(" ","").split(",").forEach(function(e){if(e=e.split(":"),e[0]){if(e[1])switch(e[0]){case"parent-uri":e[1]=U.decode(e[1]);break;case"parent-origin":e[1]=U.decode(e[1]);break;case"poster":e[1]=U.decode(e[1]);break;case"autostart":e[1]=/^(undefined|autostart|yes|true)?$/.test(e[1]);break;case"reader-view-mode":e[1]=/^(horizontal|vertical|paged)$/.test(e[1])?e[1]:void 0;break;case"to":e[1]=U.getBibiToTarget(e[1]);break;case"nav":e[1]=/^[1-9]\d*$/.test(e[1])?1*e[1]:void 0;break;case"view":e[1]=/^fixed$/.test(e[1])?e[1]:void 0;break;case"arrows":e[1]=/^hidden$/.test(e[1])?e[1]:void 0;break;case"preset":break;default:e[0]=void 0}else switch(e[0]){case"horizontal":case"vertical":case"paged":e[1]=e[0],e[0]="reader-view-mode";break;case"autostart":e[1]=!0;break;default:e[0]=void 0}e[0]&&"undefined"!=typeof e[1]&&(U[e[0]]=e[1])}})};t.bibi&&n(t.bibi),t.pipi&&(n(t.pipi),U["parent-origin"]&&U["parent-origin"]!=location.origin&&P["trustworthy-origins"].push(U["parent-origin"]),history.replaceState&&history.replaceState(null,null,location.href.replace(/[\,#]pipi\([^\)]*\)$/g,"")))},U.decode=function(e){return decodeURIComponent(e.replace("_BibiKakkoClose_",")").replace("_BibiKakkoOpen_","("))},U.parseQuery=function(e){if("string"!=typeof e)return{};e=e.replace(/^\?/,"");var t={};return e.split("&").forEach(function(e){e=e.split("="),/^[a-z]+$/.test(e[0])&&(t[e[0]]=e[1])}),t},U.parseHash=function(e){if("string"!=typeof e)return{};e=e.replace(/^#/,"");var t={},n=0,i=function(){for(var i=n,r="";/[a-z_]/.test(e.charAt(n));)n++;if("("!=e.charAt(n))return{};for(r=e.substr(i,n-1-i+1),n++;")"!=e.charAt(n);)n++;r&&(t[r]=e.substr(i,n-i+1).replace(/^[a-z_]+\(/,"").replace(/\)$/,"")),n++};for(i();","==e.charAt(n);)n++,i();return t},U.getBibiToTarget=function(e){if("number"==typeof e&&(e=""+e),"string"!=typeof e||!/^[1-9][0-9]*(-[1-9][0-9]*(\.[1-9][0-9]*)*)?$/.test(e))return null;var t="",n=e.split("-"),i=parseInt(n[0]),r=n[1]?n[1]:null;return r&&r.split(".").forEach(function(e){t+=">*:nth-child("+e+")"}),{BibitoString:e,ItemIndex:i-1,ElementSelector:t?"body"+t:void 0}},U.getEPUBCFITarget=function(e){if(!X.EPUBCFI)return null;var t=X.EPUBCFI.parse(e);if(!t||t.Path.Steps.length<2||!t.Path.Steps[1].Index||t.Path.Steps[1].Index%2==1)return null;var n=t.Path.Steps[1].Index/2-1,i=null,r=null,a=null,o=null;return t.Path.Steps[2]&&t.Path.Steps[2].Steps&&(i="",t.Path.Steps[2].Steps.forEach(function(e,n){return"IndirectPath"==e.Type?(o=e,!1):"TermStep"==e.Type?(a=e,!1):e.Index%2==1&&(r=e.Index-1,n!=t.Path.Steps[2].Steps.length-2)?!1:void(null===r&&(i=e.ID?"#"+e.ID:i+">*:nth-child("+e.Index/2+")"))}),i&&/^>/.test(i)&&(i="html"+i),i||(i=null)),{CFI:t,CFIString:e,ItemIndex:n,ElementSelector:i,TextNodeIndex:r,TermStep:a,IndirectPath:o}},S.initialize=function(){S.reset(),"undefined"==typeof S.autostart&&(S.autostart=!O.WindowEmbedded)},S.reset=function(){for(var e in S)"function"!=typeof S[e]&&delete S[e];O.apply(P,S),O.apply(U,S),delete S.book,delete S.bookshelf},S.update=function(e){var t=S.BRL,n=S.RVM,i=S.PPD,r=S.SLA,a=S.SLD;if("object"==typeof e)for(var o in e)"function"!=typeof S[o]&&(S[o]=e[o]);S.BRL=S["book-rendition-layout"]=B.Package.Metadata["rendition:layout"],S.BWM=S["book-writing-mode"]=/^tb/.test(B.WritingMode)&&!O.VerticalTextEnabled?"lr-tb":B.WritingMode,S.FontFamilyStyleIndex&&sML.CSS.removeRule(S.FontFamilyStyleIndex),S["ui-font-family"]&&(S.FontFamilyStyleIndex=sML.CSS.addRule("html","font-family: "+S["ui-font-family"]+" !important;")),S.RVM=S["reader-view-mode"],"reflowable"==S.BRL?"tb-rl"==S.BWM?(S.PPD=S["page-progression-direction"]="rtl",S.SLA=S["spread-layout-axis"]="paged"==S.RVM?"vertical":S.RVM):"tb-lr"==S.BWM?(S.PPD=S["page-progression-direction"]="ltr",S.SLA=S["spread-layout-axis"]="paged"==S.RVM?"vertical":S.RVM):"rl-tb"==S.BWM?(S.PPD=S["page-progression-direction"]="rtl",S.SLA=S["spread-layout-axis"]="paged"==S.RVM?"horizontal":S.RVM):(S.PPD=S["page-progression-direction"]="ltr",S.SLA=S["spread-layout-axis"]="paged"==S.RVM?"horizontal":S.RVM):(S.PPD=S["page-progression-direction"]="rtl"==B.PPD?"rtl":"ltr",S.SLA=S["spread-layout-axis"]="paged"==S.RVM?"horizontal":S.RVM),S.SLD=S["spread-layout-direction"]="vertical"==S["spread-layout-axis"]?"ttb":S["page-progression-direction"],"horizontal"==S.SLA?(S.SIZE={b:"height",B:"Height",l:"width",L:"Width",w:"length",W:"Length",h:"breadth",H:"Breadth"},"ltr"==S.PPD?(S.AXIS={B:"Y",L:"X",PM:1},S.BASE={b:"left",B:"Left",a:"right",A:"Right",s:"top",S:"Top",e:"bottom",E:"Bottom",c:"middle",m:"center"}):(S.AXIS={B:"Y",L:"X",PM:-1},S.BASE={b:"right",B:"Right",a:"left",A:"Left",s:"top",S:"Top",e:"bottom",E:"Bottom",c:"middle",m:"center"})):(S.SIZE={b:"width",B:"Width",l:"height",L:"Height",w:"breadth",W:"Breadth",h:"length",H:"Length"},S.AXIS={B:"X",L:"Y",PM:1},"ltr"==S.PPD?S.BASE={b:"top",B:"Top",a:"bottom",A:"Bottom",s:"left",S:"Left",e:"right",E:"Right",c:"center",m:"middle"}:S.BASE={b:"top",B:"Top",a:"bottom",A:"Bottom",s:"right",S:"Right",e:"left",E:"Left",c:"center",m:"middle"}),t!=S.BRL&&sML.replaceClass(O.HTML,"book-"+t,"book-"+S.BRL),n!=S.RVM&&sML.replaceClass(O.HTML,"view-"+n,"view-"+S.RVM),i!=S.PPD&&sML.replaceClass(O.HTML,"page-"+i,"page-"+S.PPD),r!=S.SLA&&sML.replaceClass(O.HTML,"spread-"+r,"spread-"+S.SLA),a!=S.SLD&&sML.replaceClass(O.HTML,"spread-"+a,"spread-"+S.SLD)},O.Log=(!parent||parent==window)&&console&&console.log,O.log=function(e,t){if(O.Log&&t&&"string"==typeof t){switch(e){case 0:t="[ERROR] "+t;break;case 1:t="-------- "+t+" --------";break;case 2:t=t;break;case 3:t=" - "+t;break;case 4:t="   . "+t}console.log("BiB/i: "+t)}},O.startLoading=function(){sML.addClass(O.HTML,"wait-please"),E.dispatch("bibi:startLoading")},O.stopLoading=function(){sML.removeClass(O.HTML,"wait-please"),E.dispatch("bibi:stopLoading")},O.error=function(e){O.stopLoading(),O.log(0,e),E.dispatch("bibi:error",e)},O.apply=function(e,t){for(var n in e)"function"!=typeof t[n]&&"function"!=typeof e[n]&&(t[n]=e[n])},O.download=function(e,t){return new Promise(function(n,i){var r=new XMLHttpRequest;t&&r.overrideMimeType(t),r.open("GET",e,!0),r.onloadend=function(){if(200!==r.status){var t="XHR HTTP status: "+r.status+' "'+e+'"';return O.error(t),void i(new Error(t))}n(r)},r.send(null)})},O.requestDocument=function(e){var t,n,i=/\.(xml|opf|ncx)$/i.test(e);return(B.Zipped?Promise.resolve(n):O.download(B.Path+"/"+e).then(function(e){return t=e,i||(n=t.responseXML),n})).then(function(n){if(n)return n;var r=B.Zipped?B.Files[e]:t.responseText;return n=sML.create("object",{innerHTML:i?O.toBibiXML(r):r}),i&&sML.each([n].concat(sML.toArray(n.getElementsByTagName("*"))),function(){this.getElementsByTagName=function(e){return this.querySelectorAll("bibi_"+e.replace(/:/g,"_"))}}),n&&n.childNodes&&n.childNodes.length?n:O.error('Invalid Content. - "'+e+'"')})},O.openDocument=function(e,t){t&&"object"==typeof t&&"function"==typeof t.then||(t={then:function(){return!1}}),O.requestDocument(e).then(t.then)},O.translateWritingMode=function(e){
sML.UA.Gecko?/ (-(webkit|epub)-)?writing-mode: vertical-rl; /.test(e.cssText)?e.style.writingMode="vertical-rl":/ (-(webkit|epub)-)?writing-mode: vertical-lr; /.test(e.cssText)?e.style.writingMode="vertical-lr":/ (-(webkit|epub)-)?writing-mode: horizontal-tb; /.test(e.cssText)&&(e.style.writingMode="horizontal-tb"):sML.UA.InternetExplorer&&(/ (-(webkit|epub)-)?writing-mode: vertical-rl; /.test(e.cssText)?e.style.writingMode=/ direction: rtl; /.test(e.cssText)?"bt-rl":"tb-rl":/ (-(webkit|epub)-)?writing-mode: vertical-lr; /.test(e.cssText)?e.style.writingMode=/ direction: rtl; /.test(e.cssText)?"bt-lr":"tb-lr":/ (-(webkit|epub)-)?writing-mode: horizontal-tb; /.test(e.cssText)&&(e.style.writingMode=/ direction: rtl; /.test(e.cssText)?"rl-tb":"lr-tb"))},O.getWritingMode=function(e){var t=getComputedStyle(e);return O.WritingModeProperty?/^vertical-/.test(t[O.WritingModeProperty])?("rtl"==t.direction?"bt":"tb")+"-"+(/-lr$/.test(t[O.WritingModeProperty])?"lr":"rl"):/^horizontal-/.test(t[O.WritingModeProperty])?("rtl"==t.direction?"rl":"lr")+"-"+(/-bt$/.test(t[O.WritingModeProperty])?"bt":"tb"):/^(lr|rl|tb|bt)-/.test(t[O.WritingModeProperty])?t[O.WritingModeProperty]:void 0:"rtl"==t.direction?"rl-tb":"lr-tb"},O.getElementInnerText=function(e){var t="InnerText",n=document.createElement("div");return n.innerHTML=e.innerHTML.replace(/ (src(set)?|source|(xlink:)?href)=/g," data-$1="),sML.each(n.querySelectorAll("svg"),function(){this.parentNode.removeChild(this)}),sML.each(n.querySelectorAll("video"),function(){this.parentNode.removeChild(this)}),sML.each(n.querySelectorAll("audio"),function(){this.parentNode.removeChild(this)}),sML.each(n.querySelectorAll("img"),function(){this.parentNode.removeChild(this)}),sML.each(n.querySelectorAll("script"),function(){this.parentNode.removeChild(this)}),sML.each(n.querySelectorAll("style"),function(){this.parentNode.removeChild(this)}),"undefined"!=typeof n.textContent?t=n.textContent:"undefined"!=typeof n.innerText&&(t=n.innerText),t.replace(/[\r\n\s\t ]/g,"")},O.getElementCoord=function(e){for(var t={X:e.offsetLeft,Y:e.offsetTop};e.offsetParent;)e=e.offsetParent,t.X+=e.offsetLeft,t.Y+=e.offsetTop;return t},O.getLogo=function(e){var t='<img alt="BiB/i" src="../../bib/i/res/images/bibi-logo_'+e.Color+'.png" />';return["<",e.Linkify?"a":"span",' class="bibi-logo"',e.Linkify?' href="http://bibi.epub.link/" target="_blank" title="BiB/i | Web Site"':"",">",t,"</",e.Linkify?"a":"span",">"].join("")},O.getPath=function(){var e;if(2==arguments.length&&/^[\w\d]+:\/\//.test(arguments[1]))arguments[0]=arguments[1],arguments[1]="";else for(var t=1;t<arguments.length;t++)arguments[0]+="/"+arguments[t];for(arguments[0].replace(/^([a-zA-Z]+:\/\/[^\/]+)?\/*(.*)$/,function(){e=[arguments[1],arguments[2]]});/([^:\/])\/{2,}/.test(e[1]);)e[1]=e[1].replace(/([^:\/])\/{2,}/g,"$1/");for(;/\/\.\//.test(e[1]);)e[1]=e[1].replace(/\/\.\//g,"/");for(;/[^\/]+\/\.\.\//.test(e[1]);)e[1]=e[1].replace(/[^\/]+\/\.\.\//g,"");return e[1]=e[1].replace(/^(\.\/)+/g,""),e[0]?e.join("/"):e[1]},O.toBibiXML=function(e){return e.replace(/<\?[^>]*?\?>/g,"").replace(/<(\/?)([\w\d]+):/g,"<$1$2_").replace(/<(\/?)(opf_)?([^!\?\/ >]+)/g,"<$1bibi_$3").replace(/<([\w\d_]+) ([^>]+?)\/>/g,"<$1 $2></$1>")},O.TimeCard={Origin:Date.now()},O.stamp=function(e,t){t||(t=O.TimeCard);var n=Date.now()-O.TimeCard.Origin;t[n]&&(e=t[n]+" -&- "+e),t[n]=e},E.Binded={},E.add=function(e,t,n){return"string"==typeof e&&/^bibi:/.test(e)&&"function"==typeof t?(t.bibiEventListener||(t.bibiEventListener=function(e){return t.call(document,e.detail)}),document.addEventListener(e,t.bibiEventListener,n),t):!1},E.remove=function(e,t){return"string"==typeof e&&/^bibi:/.test(e)&&"function"==typeof t&&"function"==typeof t.bibiEventListener?(document.removeEventListener(e,t.bibiEventListener),!0):!1},E.bind=function(e,t){return"string"!=typeof e||"function"!=typeof t?!1:(E.Binded[e]instanceof Array||(E.Binded[e]=[]),E.Binded[e].push(t),{Name:e,Index:E.Binded[e].length-1,Function:t})},E.unbind=function(e){if(!e)return!1;if("string"==typeof arguments[0]&&"function"==typeof arguments[1]&&(e={Name:arguments[0],Function:arguments[1]}),"object"!=typeof e||"string"!=typeof e.Name||!(E.Binded[e.Name]instanceof Array))return!1;if("number"==typeof e.Index)return"function"!=typeof E.Binded[e.Name][e.Index]?!1:(E.Binded[e.Name][e.Index]=void 0,!0);if("function"==typeof e.Function){for(var t=!1,n=0,i=E.Binded[e.Name].length;i>n;n++)E.Binded[e.Name][n]==e.Function&&(E.Binded[e.Name][n]=void 0,t=!0);return t}return delete E.Binded[e.Name]},E.dispatch=function(e,t){if(E.Binded[e]instanceof Array)for(var n=0,i=E.Binded[e].length;i>n;n++)"function"==typeof E.Binded[e][n]&&E.Binded[e][n].call(Bibi,t);return document.dispatchEvent(new CustomEvent(e,{detail:t}))},M.post=function(e,t){return O.WindowEmbedded&&"string"==typeof e&&e?("string"==typeof t&&t||(t="*"),window.parent.postMessage(e,t)):!1},M.receive=function(e){try{if(e=JSON.parse(e),"object"!=typeof e||!e)return!1;for(var t in e)E.dispatch((/^bibi:command:[\w\d]+$/.test(t)?"":"bibi:command:")+t,e[t]);return!0}catch(n){return!1}},M.gate=function(e){if(e&&e.data)for(var t=0,n=S["trustworthy-origins"].length;n>t;t++)if(S["trustworthy-origins"][t]==e.origin)return M.receive(e.data)},X.add=function(e){return e&&"object"==typeof e?"string"!=typeof e.name?function(){E.bind("bibi:welcome",function(){O.error("Extention name is invalid.")})}:X[e.name]?function(){E.bind("bibi:welcome",function(){O.error('Extention name "'+e.name+'" is reserved or already taken.')})}:("string"!=typeof e.description&&(e.decription=""),"string"!=typeof e.author&&(e.author=""),"string"!=typeof e.version&&(e.version=""),"string"!=typeof e.build&&(e.build=""),X[e.name]=e,function(t){E.bind("bibi:welcome",function(){t.call(e)})}):function(){return!1}},Bibi.x=X.add,sML.ready(Bibi.welcome);
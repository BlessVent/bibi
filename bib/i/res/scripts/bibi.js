/*!
 *
 * # BiB/i: Scripts
 *
 * 1. bib/i/res/scripts/src/bibi.core.js
 * 2. bib/i/res/scripts/src/bibi.epubcfi.js
 *
 * - 2014/06/27
 */
Bibi={/*!
 *
 *  # BiB/i (core)
 *
 *  - "EPUB Reader on Your Web Site."
 *  - (c) Satoru MATSUSHIMA - http://sarasa.la/bib/i
 *  - Licensed under the MIT license. - http://www.opensource.org/licenses/mit-license.php
 *
 *  - Sun June 22 23:59:59 2014 +0900
 */
Version:.996,Build:20140622},A={},B={},C={},H={},L={},N={},O={},P={},Q={},R={},S={},X={},O.welcome=function(){O.log(1,"Welcome !"),O.HTML=document.getElementsByTagName("html")[0],O.Head=document.getElementsByTagName("head")[0],O.Body=document.getElementsByTagName("body")[0],(sML.OS.iOS||sML.OS.Android)&&(O.SmartPhone=!0,O.setOrientation=function(){window.scrollBy(1,1),sML.removeClass(O.HTML,"orientation-"+(0==window.orientation?"landscape":"portrait")),sML.addClass(O.HTML,"orientation-"+(0==window.orientation?"portrait":"landscape")),O.HTML.style.minHeight=window.innerHeight+"px"},window.addEventListener("orientationchange",O.setOrientation),O.setOrientation(),setTimeout(O.setOrientation,1),setTimeout(O.setOrientation,100),setTimeout(O.setOrientation,800)),sML.OS.iOS&&(O.Head.appendChild(sML.create("meta",{name:"apple-mobile-web-app-capable",content:"yes"})),O.Head.appendChild(sML.create("meta",{name:"apple-mobile-web-app-status-bar-style",content:"black"})));var a=["preparing"];for(var b in sML.OS)sML.OS[b]&&a.push(b);for(var c in sML.UA)sML.UA[c]&&c.length>2&&"Flash"!=c&&a.push(c);O.HTML.className=a.join(" "),R.Contents=O.Body.appendChild(sML.create("div",{id:"epub-contents"})),N.arise(),O.initialize(),L.getBook(Q.book)},O.initialize=function(){O.log(2,"Initializing BiB/i..."),L.FileDigit=3,R.Contents.innerHTML="",R.Contents.style.opacity=0,B={Container:{Path:"META-INF/container.xml"},Package:{}},O.readExtra();var a="string"==typeof X.Preset&&X.Preset&&!/\//.test(X.Preset)?X.Preset.replace(/(\.js)?$/,".js"):"default.js",b=function(){sML.each(["spread-gap","spread-margin-start","spread-margin-end","item-padding-left","item-padding-right","item-padding-top","item-padding-bottom"],function(){P[this]="number"!=typeof P[this]||P[this]<0?0:Math.round(P[this])}),P["spread-gap"]%2&&P["spread-gap"]++,X.BDM&&/^(all|each)$/.test(X.BDM)&&(P["book-display-mode"]=X.BDM),X.SLA&&/^(horizontal|vertical)$/.test(X.SLA)&&(P["spread-layout-axis"]=X.SLA),X.PSF&&/^(portrait|landscape|window)$/.test(X.PSF)&&(P["page-size-format"]=X.PSF),(sML.UA.InternetExplorer<11||sML.UA.Gecko||sML.UA.Opera<15)&&(P["book-display-mode"]="all",P["spread-layout-axis"]="vertical",P["page-size-format"]="window")};P.FileName||"default.js"!=a?P.FileName!=a&&(P.loaded=!1,document.getElementById("bibi-preset")&&sML.removeElement(document.getElementById("bibi-preset")),sML.insertAfter(sML.create("script",{id:"bibi-preset",onload:b}),document.getElementById("bibi-script")).src="../presets/"+a,P.FileName=a):(b(),P.FileName="default.js"),O.log(3,'preset: "'+a+'"'),O.log(2,"Initialized.")},O.update=function(a){if(!a||"object"!=typeof a)return S;var b=S.BDM,c=S.SLA,d=S.SLD,e=S.PSF,f=S.PPD;if(a.Reset){for(var g in S)delete S[g];for(var g in P)S[g]=P[g];S["page-progression-direction"]=B.Package.Spine["page-progression-direction"],"default"==S["page-progression-direction"]&&(S["page-progression-direction"]=P["page-progression-direction"]),delete a.Reset}for(var g in a)S[g]=a[g];return"auto"==S["spread-layout-axis"]&&(S["spread-layout-axis"]=B.Package.Spine["page-progression-direction"]),"default"==S["spread-layout-axis"]&&(S["spread-layout-axis"]="pre-paginated"==B.Package.Metadata["rendition:layout"]?S["page-progression-direction"]:"vertical"),"vertical"!=S["spread-layout-axis"]&&(S["spread-layout-axis"]="horizontal"),"vertical"==S["spread-layout-axis"]&&(S["spread-layout-direction"]="ttb"),"horizontal"==S["spread-layout-axis"]&&(S["spread-layout-direction"]="rtl"!=S["page-progression-direction"]?"ltr":"rtl"),S.BDM=S["book-display-mode"],S.SLA=S["spread-layout-axis"],S.SLD=S["spread-layout-direction"],S.PPD=S["page-progression-direction"],S.PSF=S["page-size-format"],"vertical"==S.SLA?(S.SIZE={b:"width",B:"Width",l:"height",L:"Height"},S.AXIS={XY:"Y",YX:"X",PM:1},S.BASE="ltr"==S.PPD?{b:"top",B:"Top",a:"bottom",A:"Bottom",s:"left",S:"Left",e:"right",E:"Right",c:"center",m:"middle"}:{b:"top",B:"Top",a:"bottom",A:"Bottom",s:"right",S:"Right",e:"left",E:"Left",c:"center",m:"middle"}):(S.SIZE={b:"height",B:"Height",l:"width",L:"Width"},"ltr"==S.PPD?(S.AXIS={XY:"X",YX:"Y",PM:1},S.BASE={b:"left",B:"Left",a:"right",A:"Right",s:"top",S:"Top",e:"bottom",E:"Bottom",c:"middle",m:"center"}):(S.AXIS={XY:"X",YX:"Y",PM:-1},S.BASE={b:"right",B:"Right",a:"left",A:"Left",s:"top",S:"Top",e:"bottom",E:"Bottom",c:"middle",m:"center"})),sML.each([O.HTML,C.Navigation.Item.HTML],function(){b!=S.BDM&&sML.replaceClass(this,"display-"+b,"display-"+S.BDM),c!=S.SLA&&sML.replaceClass(this,"spread-"+c,"spread-"+S.SLA),d!=S.SLD&&sML.replaceClass(this,"spread-"+d,"spread-"+S.SLD),e!=S.PSF&&sML.replaceClass(this,"page-"+e,"page-"+S.PSF),f!=S.PPD&&sML.replaceClass(this,"page-"+f,"page-"+S.PPD)}),S},L.getBook=function(a){if("string"!=typeof a||!a||/\//.test(a))window.File?(N.Drop=N.Panel.appendChild(sML.create("p",{id:"bibi-notifier-drop",innerHTML:"<span>Drop Me an EPUB!</span>"})),N.note("Drop an EPUB File into This Window."),N.Panel.addEventListener("dragenter",function(a){a.preventDefault(),O.Body.style.opacity=.9},1),N.Panel.addEventListener("dragover",function(a){a.preventDefault(),O.Body.style.opacity=.9},1),N.Panel.addEventListener("dragleave",function(a){a.preventDefault(),O.Body.style.opacity=1},1),N.Panel.addEventListener("drop",function(a){a.preventDefault(),O.Body.style.opacity=1;var b=a.dataTransfer.files[0];b.size&&/\.epub$/i.test(b.name)?(sML.addClass(N.Panel,"animate"),N.note("Loading ..."),O.log(2,"Fetching EPUB..."),O.log(3,'"'+b.name+'"'),sML.edit(new FileReader,{onerror:function(){O.Body.style.opacity=1,N.note("Error. Something trouble...")},onload:function(){O.log(2,"Fetched."),L.preprocessEPUB(this.result),B.Name=b.name.replace(/\.epub$/i,""),B.Format="EPUB",B.Zipped=!0,L.readContainer()}}).readAsArrayBuffer(b)):N.note('Give me <span style="color:rgb(128,128,128);">EPUB</span>. Drop into this window.')},1)):N.note("Tell me EPUB name via URL in address-bar.");else if(/\.epub$/i.test(a)){var b=function(){L.play(),O.log(2,"Fetching EPUB..."),O.log(3,'"'+a+'"'),sML.ajax("../bookshelf/"+a,{mimetype:"text/plain;charset=x-user-defined",onsuccess:function(b){O.log(2,"Fetched."),L.preprocessEPUB(b),B.Name=a.replace(/\.epub$/i,""),B.Format="EPUB",B.Zipped=!0,L.readContainer()},onfailed:function(){O.log(2,"Failed to Load EPUB."),sML.removeClass(N.Panel,"animate"),N.note("Failed. Check and try again, or Drop an EPUB into this window.")}})};X.Wait?(N.createPlayButton({onplay:function(){b(),delete X.Wait}}),N.note("")):b()}else L.play(),B.Name=a,B.Format="EPUB",L.readContainer()},L.play=function(){sML.addClass(O.HTML,"wait-please"),sML.addClass(N.Panel,"animate"),N.note("Loading ...")},L.preprocessEPUB=function(a){O.log(2,"Preprocessing EPUB..."),A={Files:{},FileCount:{All:0,HTML:0,CSS:0,SVG:0,Bitmap:0,Font:0,Audio:0,Video:0,PDF:0},getDataURI:function(a){for(var b in O.ContentTypeList)if(O.ContentTypeList[b].test(a))return"data:"+b+";base64,"+(O.isBin(a)?btoa(A.Files[a]):Base64.encode(A.Files[a]));return""}},a=(new JSZip).load(a);for(var b in a.files)a.files[b]._data&&(A.FileCount.All++,/\.(x?html?)$/i.test(b)?A.FileCount.HTML++:/\.(css)$/i.test(b)?A.FileCount.CSS++:/\.(svg)$/i.test(b)?A.FileCount.SVG++:/\.(gif|jpe?g|png)$/i.test(b)?A.FileCount.Bitmap++:/\.(woff|otf|ttf)$/i.test(b)?A.FileCount.Font++:/\.(m4a|aac|mp3|ogg)$/i.test(b)?A.FileCount.Audio++:/\.(mp4|m4v|ogv|webm)$/i.test(b)?A.FileCount.Video++:/\.(pdf)$/i.test(b)&&A.FileCount.PDF++,A.Files[b]=O.isBin(b)?a.file(b).asBinary():Base64.btou(a.file(b).asText()));L.FileDigit=(A.FileCount.All+"").length,A.FileCount.All&&O.log(3,sML.String.padZero(A.FileCount.All,L.FileDigit)+" Files"),A.FileCount.HTML&&O.log(4,sML.String.padZero(A.FileCount.HTML,L.FileDigit)+" HTML"),A.FileCount.CSS&&O.log(4,sML.String.padZero(A.FileCount.CSS,L.FileDigit)+" CSS"),A.FileCount.SVG&&O.log(4,sML.String.padZero(A.FileCount.SVG,L.FileDigit)+" SVG"),A.FileCount.Bitmap&&O.log(4,sML.String.padZero(A.FileCount.Bitmap,L.FileDigit)+" Bitmap"),A.FileCount.Font&&O.log(4,sML.String.padZero(A.FileCount.Font,L.FileDigit)+" Font"),A.FileCount.Audio&&O.log(4,sML.String.padZero(A.FileCount.Audio,L.FileDigit)+" Audio"),A.FileCount.Video&&O.log(4,sML.String.padZero(A.FileCount.Video,L.FileDigit)+" Video"),A.FileCount.PDF&&O.log(4,sML.String.padZero(A.FileCount.PDF,L.FileDigit)+" PDF"),delete a;var c=replaceResourceRefferences=function(a,b,c){"function"!=typeof c&&(c=function(a){return new RegExp("<\\??[a-zA-Z1-6:-]+[^>]*? "+a+'[ 	]*=[ 	]*[\'"](?!(?:https?|data):)([^"]+?)[\'"]',"g")});var d=A.Files[a].replace(/[\r\n]/g,"\n").replace(/\r/g,"\n"),e=a.replace(/\/?[^\/]+$/,"");for(var f in b){var g=c(f),h=d.match(g);if(h){var i=new RegExp("."+b[f]+"$","i");sML.each(h,function(){var b=this.replace(g,"$1"),c=O.getPath(e,(/^(\.*\/+|#)/.test(b)?"":"./")+b),f=c.split("#"),h=f[0]?f[0]:a,j=f[1]?f[1]:"";i.test(h)&&A.Files[h]&&(d=d.replace(this,this.replace(b,A.getDataURI(h)+(j?"#"+j:""))))})}}return d},d={CSS:0,SVG:0,HTML:0};for(var e in A.Files)/\.css$/.test(e)&&(A.Files[e]=function(a){var b=arguments.callee;if(!A.Files[a])return"";var d=/@import[ \t]*(?:url\()?["']?(?!(?:https?|data):)(.+?)['"]?(?:\))?[ \t]*;/g,e=A.Files[a].match(d);return e&&sML.each(e,function(){var c=O.getPath(a.replace(/[^\/]+$/,""),this.replace(d,"$1"));A.Files[c]&&(A.Files[a]=A.Files[a].replace(this,b(c)))}),A.Files[a]=c(a,{url:"gif|png|jpe?g|svg|ttf|otf|woff"},function(){return/url\(["']?(?!(?:https?|data):)(.+?)['"]?\)/g}),A.Files[a]}(e),d.CSS++);d.CSS&&O.log(3,sML.String.padZero(d.CSS,L.FileDigit)+" CSS");for(var e in A.Files)/\.svg$/.test(e)&&(A.Files[e]=c(e,{href:"css",src:"gif|png|jpe?g|svg|js","xlink:href":"gif|png|jpe?g"}),d.SVG++);d.SVG&&O.log(3,sML.String.padZero(d.SVG,L.FileDigit)+" SVG");for(var e in A.Files)/\.x?html?$/.test(e)&&(A.Files[e]=c(e,{href:"css",src:"gif|png|jpe?g|svg|js","xlink:href":"gif|png|jpe?g"}));for(var e in A.Files)/\.x?html?$/.test(e)&&(A.Files[e]=c(e,{src:"x?html?"}),d.HTML++);d.HTML&&O.log(3,sML.String.padZero(d.HTML,L.FileDigit)+" HTML"),O.log(2,"Preprocessed.")},L.readContainer=function(a){if(B.Zipped)var a=A.Files[B.Container.Path];else if(!a)return sML.ajax("../bookshelf/"+B.Name+"/"+B.Container.Path,{onsuccess:function(a){L.readContainer(a)},onfailed:function(){O.log(2,"Failed to Load Container XML."),sML.removeClass(O.HTML,"wait-please"),sML.removeClass(N.Panel,"animate"),N.note("Failed. Check and try again, or drop an EPUB into this window.")}});O.log(2,"Reading Container XML..."),O.log(3,B.Container.Path);var b=O.Body.appendChild(sML.create("div"));b.innerHTML=O.toBibiXML(a),B.Package.Path=b.getElementsByTagName("bibi:rootfile")[0].getAttribute("full-path"),B.Package.Dir=B.Package.Path.replace(/\/?[^\/]+$/,""),sML.deleteElement(b),O.log(2,"Read."),L.readPackageDocument()},L.readPackageDocument=function(a){if(B.Zipped)var a=A.Files[B.Package.Path];else if(!a)return sML.ajax("../bookshelf/"+B.Name+"/"+B.Package.Path,{onsuccess:function(a){L.readPackageDocument(a)},onfailed:function(){O.log(2,"Failed to Load Package Document."),sML.removeClass(O.HTML,"wait-please"),sML.removeClass(N.Panel,"animate"),N.note("Failed. Check and try again, or drop an EPUB into this window.")}});O.log(2,"Reading Package Document..."),O.log(3,B.Package.Path);var b=O.Body.appendChild(sML.create("div"));b.innerHTML=O.toBibiXML(a);var c=b.getElementsByTagName("bibi:metadata")[0],d=b.getElementsByTagName("bibi:manifest")[0],e=b.getElementsByTagName("bibi:spine")[0],f=d.getElementsByTagName("bibi:item"),g=e.getElementsByTagName("bibi:itemref");if(f.length<=0)return O.log(0,'"'+B.Package.Path+'" has no <item> in <manifest>.');if(g.length<=0)return O.log(0,'"'+B.Package.Path+'" has no <itemref> in <spine>.');B.Package.Metadata={title:"",creator:"",publisher:"",language:"",titles:[],creators:[],publishers:[],languages:[]},B.Package.Manifest={items:{},nav:{},"cover-image":{},"toc-ncx":{}},B.Package.Spine={itemrefs:[]},sML.each(c.getElementsByTagName("bibi:meta"),function(){if(!this.getAttribute("refines")){if(this.getAttribute("property")){var a=this.getAttribute("property").replace(/^dcterms:/,"");/^(title|creator|publisher)$/.test(a)?B.Package.Metadata[a+"s"].push(this.innerHTML):B.Package.Metadata[a]||(B.Package.Metadata[a]=this.innerHTML)}this.getAttribute("name")&&this.getAttribute("content")&&(B.Package.Metadata[this.getAttribute("name")]=this.getAttribute("content"))}}),B.Package.Metadata.titles.length||sML.each(b.getElementsByTagName("bibi:dc:title"),function(){return B.Package.Metadata.titles.push(this.innerHTML),!1}),B.Package.Metadata.creators.length||sML.each(b.getElementsByTagName("bibi:dc:creator"),function(){B.Package.Metadata.creators.push(this.innerHTML)}),B.Package.Metadata.publishers.length||sML.each(b.getElementsByTagName("bibi:dc:publisher"),function(){B.Package.Metadata.publishers.push(this.innerHTML)}),B.Package.Metadata.languages.length||sML.each(b.getElementsByTagName("bibi:dc:language"),function(){B.Package.Metadata.languages.push(this.innerHTML)}),B.Package.Metadata.languages.length||(B.Package.Metadata.languages[0]="en"),B.Package.Metadata.title=B.Package.Metadata.titles.join(", "),B.Package.Metadata.creator=B.Package.Metadata.creators.join(", "),B.Package.Metadata.publisher=B.Package.Metadata.publishers.join(", "),B.Package.Metadata.language=B.Package.Metadata.languages.join(", "),B.Package.Metadata["rendition:layout"]||(B.Package.Metadata["rendition:layout"]="reflowable"),B.Package.Metadata["rendition:orientation"]||(B.Package.Metadata["rendition:orientation"]="auto"),B.Package.Metadata["rendition:spread"]||(B.Package.Metadata["rendition:spread"]="auto"),B.Package.Metadata.cover||(B.Package.Metadata.cover="");var h=e.getAttribute("toc");sML.each(f,function(){var a={id:this.getAttribute("id")||"",href:this.getAttribute("href")||"","media-type":this.getAttribute("media-type")||"",properties:this.getAttribute("properties")||"",fallback:this.getAttribute("fallback")||""};a.id&&a.href&&(B.Package.Manifest.items[a.id]=a,function(b){/ nav /.test(b)&&(B.Package.Manifest.nav.Path=O.getPath(B.Package.Dir,a.href)),/ cover-image /.test(b)&&(B.Package.Manifest["cover-image"].Path=O.getPath(B.Package.Dir,a.href))}(" "+a.properties+" "),h&&a.id==h&&(B.Package.Manifest["toc-ncx"].Path=O.getPath(B.Package.Dir,a.href)))}),B.Package.Spine["page-progression-direction"]=e.getAttribute("page-progression-direction"),B.Package.Spine["page-progression-direction"]&&/^(ltr|rtl)$/.test(B.Package.Spine["page-progression-direction"])||(B.Package.Spine["page-progression-direction"]="default");var i=[/(rendition:layout)-(.+)/,/(rendition:orientation)-(.+)/,/(rendition:spread)-(.+)/,/(rendition:page-spread)-(.+)/,/(page-spread)-(.+)/];sML.each(g,function(){var a={idref:this.getAttribute("idref")||"",linear:this.getAttribute("linear")||"",properties:this.getAttribute("properties")||"","page-spread":"","rendition:layout":B.Package.Metadata["rendition:layout"],"rendition:orientation":B.Package.Metadata["rendition:orientation"],"rendition:spread":B.Package.Metadata["rendition:spread"]};a.properties=a.properties.replace(/^\s+/,"").replace(/\s+$/,"").replace(/\s+/g," ").split(" "),sML.each(i,function(){var b=this;sML.each(a.properties,function(){return b.test(this)?(a[this.replace(b,"$1")]=this.replace(b,"$2").replace("rendition:",""),!1):void 0})}),a["rendition:page-spread"]&&(a["page-spread"]=a["rendition:page-spread"]),a["rendition:page-spread"]=a["page-spread"],a.viewport={content:null,width:null,height:null},a.viewBox={content:null,width:null,height:null},B.Package.Spine.itemrefs.push(a)});var j=[];B.Package.Metadata.title&&(j.push(B.Package.Metadata.title),O.log(3,"title: "+B.Package.Metadata.title)),B.Package.Metadata.creator&&(j.push(B.Package.Metadata.creator),O.log(3,"creator: "+B.Package.Metadata.creator)),B.Package.Metadata.publisher&&(j.push(B.Package.Metadata.publisher),O.log(3,"publisher: "+B.Package.Metadata.publisher)),j.length&&(document.title="BiB/i | "+j.join(" - ")),sML.deleteElement(b),C.arise(),O.log(2,"Read."),O.update({Reset:!0}),L.prepareSpineItems()},L.prepareSpineItems=function(){if(O.log(2,"Preparing Spine Items..."),R.Contents.innerHTML="",R.Spreads=[],R.Boxes=[],R.Items=[],R.Pages=[],"rtl"==S.PPD)var a="right",b="left";else var a="left",b="right";sML.each(B.Package.Spine.itemrefs,function(c){var d=this,e=O.getPath(B.Package.Dir,B.Package.Manifest.items[d.idref].href),f=sML.create("iframe",{className:"item",id:"item-"+sML.String.padZero(c+1,L.FileDigit),Dir:e.replace(/\/?[^\/]+$/,""),Path:e,Ref:d,ItemIndex:c,ItemNumber:c+1,Spread:null,Box:null,Pair:null,IsPrePaginated:"pre-paginated"==d["rendition:layout"],Postprocessed:{Linkage:0,Viewport:0},Loaded:!1});if(f.name=f.id,f.setAttribute("scrolling","no"),"pre-paginated"==d["rendition:layout"]&&c){var g=R.Items[c-1];"pre-paginated"==g.Ref["rendition:layout"]&&(d["page-spread"]==b||""==d["page-spread"]?(""==g.Ref["page-spread"]||g.Ref["page-spread"]==a)&&(f.Pair=g,g.Pair=f,d["page-spread"]=b,g.Ref["page-spread"]=a):(d["page-spread"]==a||"center"==d["page-spread"])&&""==g.Ref["page-spread"]&&(g.Ref["page-spread"]="center")),d["page-spread"]||c!=B.Package.Spine.itemrefs.length-1||(d["page-spread"]="center")}f.Spread=f.Pair?f.Pair.Spread:R.Contents.appendChild(sML.create("div",{className:"spread",Items:[]})),f.ItemIndexInSpread=f.Spread.Items.length,f.Spread.Items.push(f),f.Pair||R.Spreads.push(f.Spread),f.Box=f.Spread.appendChild(sML.create("div",{className:"item-box"})),f.Box.Spread=f.Spread,f.Box.Item=f,R.Boxes.push(f.Box),d["page-spread"]&&(sML.addClass(f.Box,"page-spread-"+d["page-spread"]),sML.addClass(f,"page-spread-"+d["page-spread"])),"pre-paginated"==d["rendition:layout"]&&(sML.addClass(f.Spread,"pre-paginated"),sML.addClass(f.Box,"pre-paginated"),sML.addClass(f,"pre-paginated")),f.Spread.appendChild(f.Box).appendChild(f),R.Items.push(f)}),O.log(3,sML.String.padZero(R.Items.length,L.FileDigit)+" Items"),O.log(2,"Prepared."),L.loadCoverImage()},L.loadCoverImage=function(){if(!R.CoverImage){if(!B.Package.Manifest["cover-image"].Path)return O.log(2,"No Cover Image."),L.loadNavigation();R.CoverImage={Path:B.Package.Manifest["cover-image"].Path}}O.log(2,"Loading Cover Image..."),O.log(3,'"'+R.CoverImage.Path+'"'),sML.create("img",{onload:function(){sML.style(N.Cover,{backgroundImage:"url("+this.src+")",opacity:1}),O.log(2,"Loaded."),L.loadNavigation()}}).src=function(){return B.Zipped?A.getDataURI(R.CoverImage.Path):"../bookshelf/"+B.Name+"/"+R.CoverImage.Path+"?cover-image"}()},L.loadNavigation=function(a){if(!R.Navigation){if(B.Package.Manifest.nav.Path)R.Navigation={Path:B.Package.Manifest.nav.Path,Type:"NavigationDocument"};else{if(O.log(2,"No Navigation Document."),!B.Package.Manifest["toc-ncx"].Path)return O.log(2,"No TOC-NCX."),L.loadSpineItems();R.Navigation={Path:B.Package.Manifest["toc-ncx"].Path,Type:"TOC-NCX"}}if(B.Zipped)var a=A.Files[R.Navigation.Path];else if(!a)return sML.ajax("../bookshelf/"+B.Name+"/"+R.Navigation.Path,{onsuccess:function(a){L.loadNavigation(a)},onfailed:function(){O.log(2,"Failed to Load Navigation."),sML.removeClass(N.Panel,"animate")}})}if(O.log(2,"Loading Navigation..."),O.log(3,'"'+R.Navigation.Path+'"'),"NavigationDocument"==R.Navigation.Type){var b={A:sML.create("div",{innerHTML:a.replace(/^.+<body( [^>]+)?>/,"").replace(/<\/body>.+$/,"")}),B:document.createElement("div")};sML.each(b.A.querySelectorAll("nav"),function(){sML.each(this.querySelectorAll("*"),function(){this.removeAttribute("style")}),b.B.appendChild(this)}),C.Navigation.Item.innerHTML=b.B.innerHTML,sML.deleteElement(b.A),sML.deleteElement(b.B),delete b}else{var c=O.Body.appendChild(sML.create("div"));c.innerHTML=O.toBibiXML(a).replace(/[\r\n]/g,"").replace(/[\t\s]*</g,"<").replace(/>[\t\s]*/g,">").replace(/^.+<bibi:navMap( [^>]+)?>/,"").replace(/<\/bibi:navMap>.+$/,""),sML.each(c.getElementsByTagName("bibi:navPoint"),function(){sML.insertBefore(sML.create("a",{href:this.getElementsByTagName("bibi:content")[0].getAttribute("src"),innerHTML:this.getElementsByTagName("bibi:text")[0].innerHTML}),this.getElementsByTagName("bibi:navLabel")[0]),sML.removeElement(this.getElementsByTagName("bibi:navLabel")[0]),sML.removeElement(this.getElementsByTagName("bibi:content")[0]);var a=sML.create("li");a.setAttribute("id",this.getAttribute("id")),a.setAttribute("playorder",this.getAttribute("playorder")),sML.insertBefore(a,this).appendChild(this),!a.previousSibling||/^a$/i.test(a.previousSibling.tagName)?sML.insertBefore(sML.create("ul"),a).appendChild(a):a.previousSibling.appendChild(a)}),C.Navigation.Item.innerHTML="<nav>"+c.innerHTML.replace(/<bibi:navPoint( [^>]+)?>/gi,"").replace(/<\/bibi:navPoint>/gi,"")+"</nav>",sML.deleteElement(c)}L.postprocessLinkage(R.Navigation.Path,C.Navigation.Item,"inBiBiNavigation"),O.log(2,"Loaded."),X.Wait?(sML.removeClass(O.HTML,"wait-please"),sML.removeClass(N.Panel,"animate"),N.createPlayButton({onplay:function(){L.play(),L.loadSpineItems()}}),N.note("")):L.loadSpineItems()},L.loadSpineItems=function(){O.log(2,"Loading Spine Items..."),L.LoadedItems=0;var a=function(a,b,c,d){a.contentDocument.open(),a.contentDocument.write(b?b:["<html>","<head>"+c+"</head>",'<body onload="parent.L.postprocessItem(parent.R.Items['+a.ItemIndex+"]); document.body.removeAttribute('onload'); return false;\">"+d+"</body>","</html>"].join("")),a.contentDocument.close()};sML.each(R.Items,function(b){var c=this,d=this.Path;/\.(gif|jpe?g|png)$/i.test(d)?(c.IsBitmap=!0,a(c,!1,"",'<img alt="" src="'+(B.Zipped?A.getDataURI(d):"../bookshelf/"+B.Name+"/"+d)+'" />')):/\.(pdf)$/i.test(d)?(c.IsPDF=!0,a(c,!1,"",'<iframe src="'+(B.Zipped?A.getDataURI(d):"../bookshelf/"+B.Name+"/"+d)+'" />')):/\.(svg)$/i.test(d)?(c.IsSVG=!0,B.Zipped?a(c,!1,"",A.Files[d].replace(/<\?xml-stylesheet (.+?)[ \t]?\?>/g,'<link rel="stylesheet" $1 />')):sML.ajax("../bookshelf/"+B.Name+"/"+d,{onsuccess:function(b){a(c,!1,'<base href="../bookshelf/'+B.Name+"/"+d+'" />',b.replace(/<\?xml-stylesheet (.+?)[ \t]?\?>/g,'<link rel="stylesheet" $1 />'))},onfailed:function(){}})):B.Zipped?(a(c,A.Files[d]),setTimeout(L.postprocessItem,10,c)):(c.onload=function(){L.postprocessItem(c)},c.src="../bookshelf/"+B.Name+"/"+d),O.log(3,sML.String.padZero(b+1,L.FileDigit)+"/"+sML.String.padZero(B.Package.Spine.itemrefs.length,L.FileDigit)+" "+(d?'"'+d+'"':"... Not Found."))}),L.CountDown=25,function(){if(L.CountDown<=0)O.log(0,"Loaded "+L.LoadedItems+"/"+R.Items.length+" Items, But Failed to Load All Items at Once. Please Reload.");else{if(L.LoadedItems<R.Items.length)return L.CountDown--,setTimeout(arguments.callee,400);delete L.CountDown,delete L.LoadedItems,O.log(2,"Loaded."),R.start()}}()},L.postprocessItem=function(a){var b=(a.Box,a.Ref);a.HTML=sML.edit(a.contentDocument.getElementsByTagName("html")[0],{Item:a}),a.Head=sML.edit(a.contentDocument.getElementsByTagName("head")[0],{Item:a}),a.Body=sML.edit(a.contentDocument.getElementsByTagName("body")[0],{Item:a}),sML.each(a.Body.getElementsByTagName("link"),function(){a.Head.appendChild(this)}),S["epub-additional-stylesheet"]&&a.Head.appendChild(sML.create("link",{rel:"stylesheet",href:S["epub-additional-stylesheet"]})),sML.each([a.HTML,a.Body],function(){this.BiBi={DefaultStyle:{margin:this.style&&this.style.margin?this.style.margin:"",padding:this.style&&this.style.padding?this.style.padding:""}}}),sML.UA.Gecko||sML.CSS.add({html:"-webkit-text-size-adjust: none;","::selection":"background: rgba(255,192,0,0.5);"},a.contentDocument);var c=a.contentDocument.querySelectorAll("body>*");if(1==c.length&&(/^svg$/i.test(c[0].tagName)?a.SingleSVG=!0:/^img$/i.test(c[0].tagName)&&(a.SingleIMG=!0)),sML.each(a.Body.getElementsByTagName("img"),function(){this.BiBi={DefaultStyle:{margin:this.style.margin?this.style.margin:"",width:this.style.width?this.style.width:"",height:this.style.height?this.style.height:"",maxWidth:this.style.maxWidth?this.style.maxWidth:"",maxHeight:this.style.maxHeight?this.style.maxHeight:""}}}),sML.each(a.Head.getElementsByTagName("meta"),function(){if("viewport"==this.name&&(b.viewport.content=this.getAttribute("content"),b.viewport.content)){var c=1*b.viewport.content.replace(/^.*?width=([^\, ]+).*$/,"$1"),d=1*b.viewport.content.replace(/^.*?height=([^\, ]+).*$/,"$1");isNaN(c)||isNaN(d)||(b.viewport.width=c,b.viewport.height=d,a.Postprocessed.Viewport)}}),"pre-paginated"==b["rendition:layout"]&&!(b.viewport.width*b.viewport.height))if(a.SingleSVG){if(c[0].getAttribute("viewBox")){b.viewBox.content=c[0].getAttribute("viewBox");var d=b.viewBox.content.split(" ");if(4==d.length){var e=1*d[2]-1*d[0],f=1*d[3]-1*d[1];e&&f&&("100%"!=c[0].getAttribute("width")&&c[0].setAttribute("width","100%"),"100%"!=c[0].getAttribute("height")&&c[0].setAttribute("height","100%"),b.viewport.width=b.viewBox.width=e,b.viewport.height=b.viewBox.height=f,a.Postprocessed.Viewport++)}}}else a.SingleIMG&&(b.viewport.width=parseInt(getComputedStyle(c[0]).width),b.viewport.height=parseInt(getComputedStyle(c[0]).height),a.Postprocessed.Viewport++);a.Postprocessed.Linkage=L.postprocessLinkage(a.Path,a.Body),L.LoadedItems++,a.Loaded=!0},L.postprocessLinkage=function(a,b,c){var d=0,e=a.replace(/\/?([^\/]+)$/,""),f=a.replace(/^.+?([^\/]+)$/,"$1");return sML.each(b.getElementsByTagName("a"),function(b){var g=this;g.NavAIndex=b;var h=g.getAttribute("href");if(h){if(/^[a-zA-Z]+:/.test(h))return g.setAttribute("target","_blank");var i=O.getPath(e,(/^\.*\/+/.test(h)?"":"./")+(/^#/.test(h)?f:"")+h),j=i.split("#"),k=j[0]?j[0]:a,l=j[1]?j[1]:"";sML.each(R.Items,function(){var a=this;return k==a.Path?(g.setAttribute("data-bibi-original-href",h),g.setAttribute("href","bibi://"+B.Name+"/"+h),g.inBiBiNavigation=c,g.Target={Item:a,Element:l?"#"+l:null},g.onclick=function(a){return R.Started?(this.inBiBiNavigation&&sML.stopPropagation(a),R.focus(this.Target,{p:.75,t:20})):N.PlayButton.play(this.Target,this.NavAIndex),!1},void d++):void 0}),l&&/^epubcfi\(.+\)$/.test(l)&&(g.setAttribute("data-bibi-original-href",h),g.setAttribute("href","bibi://"+B.Name+"/#"+l),g.inBiBiNavigation=c,g.Target=O.getEPUBCFITarget(l),g.onclick=function(a){return this.Target?(R.Started?(this.inBiBiNavigation&&sML.stopPropagation(a),R.focus(this.Target,{p:.75,t:20})):N.PlayButton.play(this.Target,this.NavAIndex),!1):!1},d++),c&&"number"==typeof X.Nav&&b==X.Nav&&g.Target&&(X.To=g.Target)}}),d},R.start=function(){R.LayoutCanceled=0,R.ResizeTriggerCanceled=0,window.addEventListener(O.SmartPhone?"orientationchange":"resize",function(){R.layoutTimer&&clearTimeout(R.layoutTimer),R.layoutTimer=setTimeout(function(){R.ResizeTriggerCanceled||R.layout({Reflesh:!0})},sML.OS.iOS||sML.OS.Android?888:444)}),sML.removeClass(O.HTML,"preparing"),R.layout({Reflesh:!0},X.To?X.To:"head",function(){sML.each(R.Items,function(){this.Box.style.background=this.contentDocument.defaultView.getComputedStyle(this.HTML).background,this.HTML.style.background="",this.style.background=this.contentDocument.defaultView.getComputedStyle(this.Body).background,this.Body.style.background=""}),sML.style(R.Contents,{transition:"opacity 0.75s ease-in-out"}),sML.each([R.Contents,C.Go],function(){sML.style(this,{opacity:1})}),sML.style(C.Switch.Bar,{display:"block"}),X.To&&sML.style(C.Go.Back,{opacity:1}),sML.style(C.Go.Forward,{opacity:1}),setTimeout(function(){N.close(function(){setTimeout(function(){sML.each([C.Go.Back,C.Go.Forward],function(){sML.style(this,{opacity:""})})},888)})},444),R.Started=!0,sML.removeClass(O.HTML,"wait-please"),O.log(1,"Enjoy!")})},R.layout=function(a,b,c){if(!R.LayoutCanceled){R.LayoutCanceled++,R.ResizeTriggerCanceled++;var d=null,e=null;if(a&&a.Reflesh&&(d=!0,delete a.Reflesh),a&&a.NoLog&&(e=!0,delete a.NoLog),e||O.log(2,"Laying Out..."),!b)if(R.Layouted){var f=R.getCurrentPages().Start;b={Item:f.Item,PageProgressInItem:f.PageIndexInItem/f.Item.Pages.length}}else b={Edge:"head"};if(O.update(a),e||O.log(3,"( BDM: "+S["book-display-mode"]+", SLA: "+S["spread-layout-axis"]+", PSF: "+S["page-size-format"]+" )"),sML.each(R.Spreads,function(a){this.style.display="",this.style["margin"+S.BASE.B]=a?S["spread-gap"]+"px":"",this.style["margin"+S.BASE.A]="",this.style["margin"+S.BASE.S]=S["spread-margin-start"]+"px",this.style["margin"+S.BASE.E]=""}),d&&(S.Paged=!1,sML.OS.iOS&&sML.UA.Sa&&(O.Body.style.height="ttb"==S["spread-layout-direction"]?"100%":window.innerHeight+"px"),sML.each(R.Pages,function(){sML.removeElement(this)}),R.Pages=[],R.Contents.style["padding"+S.BASE.B]=R.Contents.style["padding"+S.BASE.A]=S["spread-gap"]/2+"px",R.Contents.style["padding"+S.BASE.S]=R.Contents.style["padding"+S.BASE.E]=0,R.Contents.style.background=S["book-background"],sML.each(R.Spreads,function(){this.Pages=[],this.style.width=this.style.height="",this.style["border-radius"]=S["spread-border-radius"],this.style["box-shadow"]=S["spread-box-shadow"]}),R.StageSize={Reflowable:{Breadth:O.Body["client"+S.SIZE.B]-(S["item-padding-"+S.BASE.s]+S["item-padding-"+S.BASE.e]+S["spread-margin-start"]+S["spread-margin-end"]),Length:O.Body["client"+S.SIZE.L]-(S["item-padding-"+S.BASE.b]+S["item-padding-"+S.BASE.a]+S["spread-gap"])},PrePagenated:{Breadth:O.Body["client"+S.SIZE.B]-(S["spread-margin-start"]+S["spread-margin-end"]),Length:O.Body["client"+S.SIZE.L]-S["spread-gap"]}},R.MaxSpreadWidth=0,sML.each(R.Items,function(a){var b=this.Spread,c=this.Box,d=this,e=this.Ref;if(d.Pages=[],"pre-paginated"==e["rendition:layout"]&&e.viewport[S.SIZE.b]&&e.viewport[S.SIZE.l]){S.Paged=!0,d.HTML.style.margin=d.HTML.style.padding=d.Body.style.margin=d.Body.style.padding=0;var f=R.StageSize.PrePagenated.Breadth,g=R.StageSize.PrePagenated.Length;d.style["padding"+S.BASE.B]=d.style["padding"+S.BASE.A]=d.style["padding"+S.BASE.S]=d.style["padding"+S.BASE.E]=0,"ttb"!=S["spread-layout-direction"]||"right"!=e["page-spread"]&&"left"!=e["page-spread"]||(f/=2);var h=Math.min(Math.min(e.viewport[S.SIZE.b],f)/e.viewport[S.SIZE.b],Math.min(e.viewport[S.SIZE.l],g)/e.viewport[S.SIZE.l]);g=Math.floor(e.viewport[S.SIZE.l]*h),f=Math.floor(e.viewport[S.SIZE.b]*(g/e.viewport[S.SIZE.l])),d.style[S.SIZE.l]=c.style[S.SIZE.l]=g+"px",d.style[S.SIZE.b]=c.style[S.SIZE.b]=f+"px",sML.style(d.HTML,{width:e.viewport.width+"px",height:e.viewport.height+"px",transformOrigin:"0 0",transform:"scale("+h+")"}),a&&d.Pair&&d.Pair==R.Items[a-1]?"ttb"!=S["spread-layout-direction"]?b.style[S.SIZE.l]=parseInt(b.style[S.SIZE.l])+g+"px":b.style[S.SIZE.b]=parseInt(b.style[S.SIZE.b])+f+"px":(b.MarginMore=0,"ttb"!=S["spread-layout-direction"]?(b.style[S.SIZE.b]=f+"px",b.style[S.SIZE.l]=g+"px"):(b.style[S.SIZE.b]=f+"px",b.style[S.SIZE.l]=g+"px",d.Pair||("right"==e["page-spread"]?b.MarginMore=f:"center"==e["page-spread"]&&(b.MarginMore=Math.floor(f/2))))),R.MaxSpreadWidth=Math.max(R.MaxSpreadWidth,b.offsetWidth);var i=c.appendChild(sML.create("span",{className:"page"}));"right"==e["page-spread"]?i.style.right=S["spread-gap"]/2*-1+"px":i.style.left=S["spread-gap"]/2*-1+"px",i.style.paddingLeft=i.style.paddingRight=S["spread-gap"]/2+"px",i.style[S.SIZE.b]=f+"px",i.style[S.SIZE.l]=g+"px",i.PageIndex=R.Pages.length,R.Pages.push(i),i.PageIndexInItem=d.Pages.length,d.Pages.push(i),i.PageIndexInSpread=b.Pages.length,b.Pages.push(i),i.Item=d,i.Box=c,i.Spread=b}else{d.scrolling="no";var j=""==d.HTML.innerText&&1==d.Body.getElementsByTagName("img").length,k=""==d.HTML.innerText&&1==d.Body.getElementsByTagName("iframe").length,l=(R.StageSize.Reflowable.Breadth,R.StageSize.Reflowable.Length),f=R.StageSize.Reflowable.Breadth,g=R.StageSize.Reflowable.Length,m=S["item-padding-"+S.BASE.a]+S["spread-gap"]+S["item-padding-"+S.BASE.b];if("portrait"==S["page-size-format"]||"landscape"==S["page-size-format"]){var n=1.414/.96;("width"==S.SIZE.l&&"portrait"==S["page-size-format"]||"height"==S.SIZE.l&&"landscape"==S["page-size-format"])&&(n=1/n),g=Math.min(l,Math.floor(f*n))}if(b.style[S.SIZE.b]=c.style[S.SIZE.b]=f+(S["item-padding-"+S.BASE.s]+S["item-padding-"+S.BASE.e])+"px",d.style["padding"+S.BASE.B]=S["item-padding-"+S.BASE.b]+"px",d.style["padding"+S.BASE.A]=S["item-padding-"+S.BASE.a]+"px",d.style["padding"+S.BASE.S]=S["item-padding-"+S.BASE.s]+"px",d.style["padding"+S.BASE.E]=S["item-padding-"+S.BASE.e]+"px",d.style[S.SIZE.b]=f+"px",d.style[S.SIZE.l]=g+"px",d.HTML.style[S.SIZE.b]=f+"px",d.HTML.style[S.SIZE.l]=g+"px",sML.style(d.HTML,{"column-axis":"","column-width":"","column-gap":"","column-rule":""}),function(){return"string"!=typeof S["fit-images"]||"no"==S["fit-images"]?!1:"always"==S["fit-images"]?!0:d.HTML.innerText&&d.Body.getElementsByTagName("img").length>1?!1:"in-single-image-only-item"==S["fit-images"]?!0:!1
}()){var h=1;j&&(sML.style(d.HTML,{transformOrigin:"",transform:""}),(d.HTML["scroll"+S.SIZE.B]>f||d.HTML["scroll"+S.SIZE.L]>g)&&(h=Math.floor(100*Math.min(f/d.HTML["scroll"+S.SIZE.B],g/d.HTML["scroll"+S.SIZE.L]))/100,sML.style(d.HTML,{transformOrigin:"50% 0",transform:"scale("+h+")"}))),sML.each(d.Body.getElementsByTagName("img"),function(){this.style.width=this.BiBi.DefaultStyle.width,this.style.height=this.BiBi.DefaultStyle.height;var a=Math.min(parseInt(getComputedStyle(d.Body)[S.SIZE.b]),Math.floor(f/h)),b=Math.min(parseInt(getComputedStyle(d.Body)[S.SIZE.l]),Math.floor(g/h));parseInt(getComputedStyle(this)[S.SIZE.b])>a&&(this.style[S.SIZE.b]=a+"px",this.style[S.SIZE.l]="auto"),parseInt(getComputedStyle(this)[S.SIZE.l])>b&&(this.style[S.SIZE.l]=b+"px",this.style[S.SIZE.b]="auto")})}if(k){var o=d.Body.getElementsByTagName("iframe")[0];o.style[S.SIZE.b]=f+"px",o.style[S.SIZE.l]=g+"px"}var p=sML.CSS.addRule("*","word-wrap: break-word;",d.contentDocument);d.ColumnBreadth=0,d.ColumnLength=0,d.ColumnGap=0,function(a,b,c){a=b.clientWidth,a=b.clientHeight,a=b.scrollWidth,a=b.scrollHeight,a=b.offsetWidth,a=b.offsetHeight,a=c.clientWidth,a=c.clientHeight,a=c.scrollWidth,a=c.scrollHeight,a=c.offsetWidth,a=c.offsetHeight}(0,d.HTML,d.Body),d.Body["scroll"+S.SIZE.B]>f&&(S.Paged=!0,d.ColumnBreadth=f,d.ColumnLength=g,d.ColumnGap=m,sML.style(d.HTML,{"column-axis":"ttb"!=S.SLD?"horizontal":"vertical","column-width":d.ColumnLength+"px","column-gap":d.ColumnGap+"px","column-rule":""})),sML.CSS.removeRule(p,d.contentDocument);var q=d.Body["scroll"+S.SIZE.L],r=j?Math.max(q,g):q,s=Math.ceil((r+m)/(g+m));r=(g+m)*s-m,b.style[S.SIZE.l]=c.style[S.SIZE.l]=r+(S["item-padding-"+S.BASE.b]+S["item-padding-"+S.BASE.a])+"px",d.style[S.SIZE.l]=r+"px",R.MaxSpreadWidth=Math.max(R.MaxSpreadWidth,b.offsetWidth);for(var t=0;s>t;t++){var i=c.appendChild(sML.create("span",{className:"page"}));i.style["padding"+S.BASE.B]=S["item-padding-"+S.BASE.b]+S["spread-gap"]/2+"px",i.style["padding"+S.BASE.A]=S["item-padding-"+S.BASE.a]+S["spread-gap"]/2+"px",i.style["padding"+S.BASE.S]=S["item-padding-"+S.BASE.s]+"px",i.style["padding"+S.BASE.E]=S["item-padding-"+S.BASE.e]+"px",i.style[S.SIZE.b]=f+"px",i.style[S.SIZE.l]=g+"px",i.style[S.BASE.b]=(g+m)*t-S["spread-gap"]/2+"px",i.PageIndex=R.Pages.length,R.Pages.push(i),i.PageIndexInItem=d.Pages.length,d.Pages.push(i),i.PageIndexInSpread=b.Pages.length,b.Pages.push(i),i.Item=d,i.Box=c,i.Spread=b}}}),sML.style(C.Navigation.Item,{"float":""}),"rtl"==S.SLD)){{C.Navigation.Item.scrollWidth-window.innerWidth}C.Navigation.Item.scrollWidth<window.innerWidth&&sML.style(C.Navigation.Item,{"float":"right"}),C.Navigation.Box.scrollLeft=C.Navigation.Box.scrollWidth-window.innerWidth}b=R.getTarget(b),R.CurrentEdgeSpread={Head:R.Spreads[0],Foot:R.Spreads[R.Spreads.length-1]},sML.each(R.Spreads,function(){"ttb"==S.SLD&&(this.style.marginLeft=S["spread-margin-start"]+this.MarginMore+"px");var a="all"==S.BDM?"":"none";"each"==S.BDM&&this==b.Item.Spread&&(a="",R.CurrentEdgeSpread.Head=R.CurrentEdgeSpread.Foot=b.Item.Spread),this.style.display=a});var g=Math.floor((window["inner"+S.SIZE.L]-R.CurrentEdgeSpread.Head["offset"+S.SIZE.L]-S["spread-gap"])/2),h=Math.ceil((window["inner"+S.SIZE.L]-R.CurrentEdgeSpread.Foot["offset"+S.SIZE.L]-S["spread-gap"])/2);return R.CurrentEdgeSpread.Head.style["margin"+S.BASE.B]=(g>0?g:0)+"px",R.CurrentEdgeSpread.Foot.style["margin"+S.BASE.A]=(h>0?h:0)+"px",R.Layouted&&R.focus(b,{p:1,t:1}),setTimeout(function(){R.Layouted||R.focus(b,{p:.5,t:1}),R.LayoutCanceled--,R.Layouted=!0,e||O.log(2,"Laid Out."),setTimeout(function(){R.ResizeTriggerCanceled--},444),"function"==typeof c&&c()},888),S}},R.changeView=function(a){a||(a={}),a.Reflesh=a["spread-layout-axis"]||a["page-size-format"];var b=R.getCurrentPages().Start;sML.style(R.Contents,{transition:"opacity 0.5s linear",opacity:0},function(){R.ResizeTriggerCanceled++,R.layout(a,{ItemIndex:b.Item.ItemIndex,PageProgressInItem:b.PageIndexInItem/b.Item.Pages.length}),setTimeout(function(){sML.style(R.Contents,["transition","opacity 0.5s linear","opacity",1],function(){setTimeout(function(){R.ResizeTriggerCanceled--},444)})},100)})},R.changeBookDisplayMode=function(a){a!=S.BDM&&R.changeView({"book-display-mode":a})},R.changeSpreadLayoutAxis=function(a){a!=S.SLA&&R.changeView({"spread-layout-axis":a})},R.changePageSizeFormat=function(a){a!=S.PSF&&R.changeView({"page-size-format":a})},R.getTarget=function(a){if("string"==typeof a?a={Edge:a}:"number"==typeof a&&(a={Item:R.Items[a]}),"object"!=typeof a||!a)return null;if(a.tagName&&(TargetElement=a,a={},"number"==typeof TargetElement.PageIndex?a.Page=TargetElement:"number"==typeof TargetElement.ItemIndex?a.Item=TargetElement:a.Element=TargetElement),"string"==typeof a.Edge){if("head"==a.Edge)return{Edge:"head",EdgeTRBL:"ttb"==S.SLD?"T":"rtl"==S.SLD?"R":"L",Item:R.Items[0],Page:R.Pages[0]};if("foot"==a.Edge)return{Edge:"foot",EdgeTRBL:"ttb"==S.SLD?"B":"rtl"==S.SLD?"L":"R",Item:R.Items[R.Items.length-1],Page:R.Pages[R.Pages.length-1]}}if(a.Item||"number"!=typeof a.ItemIndex||(a.Item=R.Items[a.ItemIndex]),a.Element){if(a.Element.tagName){var b=a.Element;if(!b.ownerDocument.body.Item)return null;a.Item=b.ownerDocument.body.Item}if("string"==typeof a.Element){if(!a.Item)return!0;a.Element=a.Item.contentDocument.querySelector(a.Element),a.Element||delete a.Element}a.Page=a.Item.Pages[0]}else a.Page?a.Item=a.Page.Item:"number"==typeof a.PageIndexInItem&&a.Item?a.Page=a.Item.Pages[a.PageIndexInItem]:"number"==typeof a.PageProgressInItem&&a.Item?a.Page=a.Item.Pages[Math.floor(a.Item.Pages.length*a.PageProgressInItem)]:"number"==typeof a.PageIndex&&(a.Page=R.Pages[a.PageIndex],a.Item=a.Page.Item);return a.Item?(a.Page||(a.Page=a.Item.Pages[0]),a):null},R.getCurrentPages=function(){for(var a=sML.getCoord(window),b=[],c=null,d=null,e=null,f=0,g=a[S.SIZE.l]/2,h=R.Pages.length,i=0;h>i;i++)if("none"!=R.Pages[i].style.display){var j=sML.getCoord(R.Pages[i]),k=Math.min(a[S.BASE.a]*S.AXIS.PM,j[S.BASE.a]*S.AXIS.PM)-Math.max(a[S.BASE.b]*S.AXIS.PM,j[S.BASE.b]*S.AXIS.PM),l=Math.abs(a[S.BASE.b]+a[S.BASE.a]-(j[S.BASE.b]+j[S.BASE.a]));if(k=0>=k||!j[S.SIZE.l]||isNaN(k)?-1:Math.round(k/j[S.SIZE.l]*100),f>k){if(b.length)break}else k==f?b.push(R.Pages[i]):k>f&&(b[0]=R.Pages[i],f=k),g>l&&(d=R.Pages[i],g=l)}return c=b[0],e=b[b.length-1],{All:b,Start:c,Center:d,End:e}},R.getPageGroup=function(a){a=R.getTarget(a);for(var b="a"==a.Side?-1:1,c=[],d=0,e=window["inner"+S.SIZE.L],f=a.Page.PageIndex;f>=0&&f<R.Pages.length&&(!a.Item.IsPrePaginated||R.Pages[f].Spread==a.Page.Spread)&&!(e-R.Pages[f]["offset"+S.SIZE.L]<0);f+=b)c.push(R.Pages[f]),"ttb"==S.SLD&&R.Pages[f].Item.Pair&&R.Pages[f].Item.Pair==a.Page.Item||(e-=R.Pages[f]["offset"+S.SIZE.L],d+=R.Pages[f]["offset"+S.SIZE.L]);var g=Math.floor(e/2),h=g;return"a"==a.Side&&(c.reverse(),h+=d-a.Page["offset"+S.SIZE.L]),{Page:a.Page,Pages:c,Length:d,MarginBeforeGroup:g,MarginBeforePage:h}},R.focus=function(a,b){var c=R.getTarget(a);if("object"!=typeof c||!c)return!1;if(b||(b={p:.4,t:10}),c.Edge){var d=/^[TL]$/.test(c.EdgeTRBL)?0:O.Body["scroll"+S.SIZE.L]-O.Body["client"+S.SIZE.L];return sML.scrollTo("ttb"==S.SLD?{y:d}:{x:d},b),!1}if("each"==S.BDM&&c.Spread!=R.getCurrentPages().Start.Spread&&R.layout({Reflesh:!1,NoLog:!0},{Item:c.Item,PageProgressInItem:c.Page.PageIndexInItem/c.Item.Pages.length}),"ttb"==S.SLD)var e=["Top","Left"],f=["top","left"];else var e=["Left","Top"],f=["left","top"];var g,d,h={Element:c.Element,TextNodeIndex:c.TextNodeIndex,TermStep:c.TermStep},i=function(){};if(c.Element){g=c.Item.Pages[0];for(var j=g["offset"+e[0]];g.offsetParent;)g=g.offsetParent,j+=g["offset"+e[0]];g=c.Element;for(var k=g["offset"+e[0]],l=g["offset"+e[1]];g.offsetParent;)g=g.offsetParent,k+=g["offset"+e[0]],l+=g["offset"+e[1]];sML.getCoord(c.Element)[S.BASE.s]>c.Item["offset"+S.SIZE.B]-S["item-padding-"+S.BASE.s]-S["item-padding-"+S.BASE.e]?(k=0==l?0:"rtl"!=S.PPD?(c.Item.ColumnLength+c.Item.ColumnGap)*Math.floor(l/c.Item.ColumnBreadth)-S["item-padding-"+S.BASE.b]:(c.Item.ColumnLength+c.Item.ColumnGap)*Math.ceil(l/c.Item.ColumnBreadth)-S["item-padding-"+S.BASE.a],"rtl"==S.SLD&&(k=c.Item["offset"+S.SIZE.L]-k)):"rtl"==S.SLD&&(k+=c.Element["offset"+S.SIZE.L]),j+=S["item-padding-"+f[0]]+k,sML.each(c.Item.Pages,function(){var a=sML.getCoord(this)[S.BASE.b];return(j+8)*S.AXIS.PM<a*S.AXIS.PM?!1:void(d=a)}),"number"==typeof h.TextNodeIndex&&R.pointTextLocation(h)}else{var m=R.getPageGroup(c);for(g=m.Pages[0],d=g["offset"+e[0]];g.offsetParent;)g=g.offsetParent,d+=g["offset"+e[0]];if("rtl"==S.SLD&&(d+=Math.floor(m.Pages[0]["offset"+S.SIZE.L])),window["inner"+S.SIZE.L]>m.Pages[0]["offset"+S.SIZE.L]){var n=Math.floor((window["inner"+S.SIZE.L]-m.Length)/2);n>0&&(d-=n*S.AXIS.PM)}}return"rtl"==S.SLD&&(d-=window["inner"+S.SIZE.L]),sML.scrollTo("ttb"==S.SLD?{y:d}:{x:d},b,i),!1},R.pointTextLocation=function(a){if("number"==typeof a.TextNodeIndex){var b=a.Element.childNodes[a.TextNodeIndex];if(b&&b.textContent){var c={Start:{Node:b,Index:0},End:{Node:b,Index:b.textContent.length}};if(a.TermStep)if(a.TermStep.Preceding||a.TermStep.Following){if(c.Start.Index=a.TermStep.Index,c.End.Index=a.TermStep.Index,a.TermStep.Preceding&&(c.Start.Index-=a.TermStep.Preceding.length),a.TermStep.Following&&(c.End.Index+=a.TermStep.Following.length),c.Start.Index<0||b.textContent.length<c.End.Index)return;if(b.textContent.substr(c.Start.Index,c.End.Index-c.Start.Index)!=a.TermStep.Preceding+a.TermStep.Following)return}else if(a.TermStep.Side&&"a"==a.TermStep.Side){for(c.Start.Node=b.parentNode.firstChild;c.Start.Node.childNodes.length;)c.Start.Node=c.Start.Node.firstChild;c.End.Index=a.TermStep.Index-1}else{for(c.Start.Index=a.TermStep.Index,c.End.Node=b.parentNode.lastChild;c.End.Node.childNodes.length;)c.End.Node=c.End.Node.lastChild;c.End.Index=c.End.Node.textContent.length}return sML.select(c)}}},R.page=function(a){if(!S.Paged)return R.scroll(a);-1!=a&&(a=1);var b=R.getCurrentPages(),c=0>a?b.Start:b.End,d=c.PageIndex+a;if(0>d)return R.focus({Edge:"head"});if(d>R.Pages.length-1)return R.focus({Edge:"foot"});var e=R.Pages[d];"vertical"==S.SLA&&e.Item.Pair&&c.Item.Pair==e.Item&&(d+=a>0?1:-1),"horizontal"==S.SLA&&e.Item.Pair&&(0>a&&0==e.PageIndexInSpread&&(e=e.Spread.Pages[1]),a>0&&1==e.PageIndexInSpread&&(e=e.Spread.Pages[0]));sML.getCoord(window);return"each"==S.BDM&&e.Spread!=c.Spread?R.layout({Reflesh:!1,NoLog:!0},{Item:e.Item,PageProgressInItem:e.PageIndexInItem/e.Item.Pages.length}):R.focus({Page:e,Side:a>0?"b":"a"})},R.scroll=function(a){if(S.Paged)return R.page(a);-1!=a&&(a=1);var b=sML.getCoord(window),c={};switch(S.SLD){case"ttb":c={y:b.top+b.height*a};break;case"ltr":c={x:b.left+b.width*a};break;case"rtl":c={x:b.left+b.width*a*-1}}return sML.scrollTo(c,{p:.4,t:10})},R.to=function(a){return R.focus(O.getBibitoTarget(a))},N.arise=function(){N.Opened=!0,N.Closed=!1,N.Translate=240,N.OpeningTransition="0.5s ease-out",N.ClosingTransition="0.5s ease-in",N.note=function(a){N.Message.innerHTML=a},N.toggle=function(a){return R.ControlPanel.Status="undefined"==typeof a?Math.abs(R.ControlPanel.Status-1):a,sML[(R.ControlPanel.Status?"add":"remove")+"Class"](O.HTML,"control-panel-on"),R.ControlPanel.Status},N.open=function(a){return this.Closed?(this.Closed=!1,N.Panel.style.zIndex=100,void sML.style(N.Panel,{transition:N.OpeningTransition,transform:"translate"+S.AXIS.XY+"(0)",opacity:.75},function(){N.Message.style.opacity=1,N.Opened=!0,"function"==typeof a&&a()})):this.close(function(){N.open(a)})},N.close=function(a){this.Opened&&(this.Opened=!1,N.Message.style.opacity=0,sML.style(N.Panel,{transition:N.ClosingTransition,transform:"translate"+S.AXIS.XY+"("+-1*S.AXIS.PM*N.Translate+"%)",opacity:0},function(){sML.style(N.Panel,{transition:"none",transform:"translate"+S.AXIS.XY+"("+S.AXIS.PM*N.Translate+"%)"}),N.Panel.style.zIndex=1,N.Closed=!0,"function"==typeof a&&a()}))},N.Panel=O.Body.appendChild(sML.create("div",{id:"bibi-notifier-panel"})),N.Cover=N.Panel.appendChild(sML.create("div",{id:"bibi-notifier-cover"})),N.Mark=N.Panel.appendChild(sML.create("p",{id:"bibi-notifier-mark",className:"animate"})),N.Message=N.Panel.appendChild(sML.create("p",{id:"bibi-notifier-message",className:"animate"})),N.Powered=N.Panel.appendChild(sML.create("p",{id:"bibi-notifier-powered",innerHTML:""+O.getLogo({Linkify:!0})}));for(var a=1;8>=a;a++)N.Mark.appendChild(sML.create("span",{className:"dot"+a}));N.createPlayButton=function(a){N.PlayButton=N.Panel.appendChild(sML.create("p",{id:"bibi-notifier-play-button",title:(sML.OS.iOS||sML.OS.Android?"Tap":"Click")+" to Open",play:function(b,c){if(O.SmartPhone){var d=location.href.replace(/&wait=[^&]+/g,"");return"number"==typeof c&&(d=[d,"bibi_x(nav:"+c+")"].join(/#/.test(d)?",":"#")),window.open(d)}b&&(X.To=b),L.play(),this.onclick=function(){return!1},sML.style(this,{opacity:0,cursor:"default"}),a.onplay()},onclick:function(a){this.play(),sML.stopPropagation(a)}})),N.PlayButton.innerHTML='<span class="non-visual">'+N.PlayButton.title+" to Open</span>"}},C.arise=function(){C.Shape={},C.Shape.Item='<span class="bibi-shape bibi-shape-item"></span>',C.Shape.Spread='<span class="bibi-shape bibi-shape-spread">'+C.Shape.Item+C.Shape.Item+"</span>",C.Shape.Spreads='<span class="bibi-shape bibi-shape-spreads">'+C.Shape.Spread+C.Shape.Spread+C.Shape.Spread+"</span>",C.Shape.SpreadsV='<span class="bibi-shape bibi-shape-spreads-vertical">'+C.Shape.Spread+C.Shape.Spread+C.Shape.Spread+"</span>",C.Shape.SpreadsH='<span class="bibi-shape bibi-shape-spreads-horizontal">'+C.Shape.Spread+C.Shape.Spread+C.Shape.Spread+"</span>",C.Go=O.Body.appendChild(sML.create("div",{id:"bibi-control-go"},{transition:"opacity 0.75s linear",opacity:0})),C.Go.Back=C.Go.appendChild(sML.create("div",{title:"Back",className:"bibi-control-go",id:"bibi-control-go-back",onclick:function(){R.page(-1)}})),C.Go.Forward=C.Go.appendChild(sML.create("div",{title:"Forward",className:"bibi-control-go",id:"bibi-control-go-forward",onclick:function(){R.page(1)}})),sML.each([C.Go.Back,C.Go.Forward],function(){this.addEventListener("mouseover",function(){this.clickedTimer&&clearTimeout(this.clickedTimer),sML.addClass(this,"shown")}),this.addEventListener("mouseout",function(){sML.removeClass(this,"shown")}),this.addEventListener("click",function(){sML.addClass(this,"shown");var a=this;this.clickedTimer&&clearTimeout(this.clickedTimer),this.clickedTimer=setTimeout(function(){sML.removeClass(a,"shown")},500)})}),C.Switch=O.Body.appendChild(sML.create("div",{id:"bibi-control-switch",changeLabel:function(a,b){a.title=b,a.innerHTML='<span class="non-visual">'+b+"</span>"}},{transition:"opacity 0.75s linear"})),C.Switch.Bar=C.Switch.appendChild(sML.create("span",{id:"bibi-control-switch-bar",Labels:["ja"==B.Package.Metadata.languages[0]?"メニューを開く":"Open Menu","ja"==B.Package.Metadata.languages[0]?"メニューを閉じる":"Close Menu"],toggle:function(a){"ttb"==S["spread-layout-direction"]?"X":"Y";C.Switch.Bar.On?(sML.style(C.Bar,{transition:"0.2s ease-out"}),sML.style(R.Contents,{transition:"0.2s ease-out"},a),sML.removeClass(O.HTML,"bibi-control-bar-opened")):(sML.style(C.Bar,{transition:"0.2s ease-in"}),sML.style(R.Contents,{transition:"0.2s ease-in"},a),sML.addClass(O.HTML,"bibi-control-bar-opened")),this.On=!this.On},onclick:function(){this.toggle()},On:!1},{})),C.Switch.NewWindow=C.Switch.appendChild(sML.create("a",{id:"bibi-control-switch-newwindow",Labels:["ja"==B.Package.Metadata.languages[0]?"新しいウィンドウで開く":"Open in New Window"],href:location.href.replace(/&wait=[^&]+/g,""),target:"_blank"},{display:"none"})),O.ParentFrame?C.Switch.NewWindow.style.display="":sML.addClass(O.HTML,"not-embeded"),C.Switch.FullScreen=C.Switch.appendChild(sML.create("span",{id:"bibi-control-switch-fullscreen",On:!1,Req:O.ParentFrame?O.ParentFrame:document.documentElement,Doc:O.ParentFrame?parent.document:document,Labels:["ja"==B.Package.Metadata.languages[0]?"フルスクリーンモードを開始":"Enter Full-Screen","ja"==B.Package.Metadata.languages[0]?"フルスクリーンモードを終了":"Exit Full-Screen"],enter:function(a){this.On=!0,sML.requestFullScreen(this.Req),setTimeout(function(){C.Switch.changeLabel(C.Switch.FullScreen,C.Switch.FullScreen.Labels[1]),sML.addClass(O.HTML,"bibi-fullscreen"),"function"==typeof a&&a()},200)},exit:function(a){this.On=!1,sML.exitFullScreen(this.Doc),setTimeout(function(){C.Switch.changeLabel(C.Switch.FullScreen,C.Switch.FullScreen.Labels[0]),sML.removeClass(O.HTML,"bibi-fullscreen"),"function"==typeof a&&a()},200)},toggle:function(a){this.On?this.exit(a):this.enter(a)},onclick:function(){this.toggle()}},{display:"none"})),sML.fullScreenEnabled(C.Switch.FullScreen.Doc)&&(parent==window||O.ParentFrame)?C.Switch.FullScreen.style.display="":sML.addClass(O.HTML,"not-enabled-full-screen"),sML.each([C.Switch.Bar,C.Switch.NewWindow,C.Switch.FullScreen],function(){C.Switch.changeLabel(this,this.Labels[0])}),C.Sheet=O.Body.appendChild(sML.create("div",{id:"bibi-control-sheet",onclick:C.Switch.Bar.toggle})),C.Bar=O.Body.appendChild(sML.create("div",{id:"bibi-control-bar"})),C.Misc=C.Bar.appendChild(sML.create("div",{id:"bibi-control-misc",innerHTML:O.getLogo({Linkify:!0})})),C.Navigation=C.Bar.appendChild(sML.create("div",{id:"bibi-control-navigation"})),C.Navigation.Box=C.Navigation.appendChild(sML.create("div",{id:"bibi-control-navigation-box",onclick:function(){C.Switch.Bar.toggle()}})),C.Navigation.Item=C.Navigation.Box.appendChild(sML.create("div",{id:"bibi-control-navigation-item"})),sML.UA.InternetExplorer<11||sML.UA.Gecko||sML.UA.Opera<15||(C.Menus=C.Bar.appendChild(sML.create("div",{id:"bibi-control-menus"})),C.Menus["book-display-mode"]=C.Menus.appendChild(sML.create("ul",{id:"book-display-mode"})),C.Menus["book-display-mode"].Buttons={all:C.Menus["book-display-mode"].appendChild(sML.create("li",{id:"display-all",innerHTML:'<span class="bibi-icon bibi-icon-all" title="Display All">'+C.Shape.Spreads+"</span>",onclick:function(){R.changeBookDisplayMode("all")}})),each:C.Menus["book-display-mode"].appendChild(sML.create("li",{id:"display-each",innerHTML:'<span class="bibi-icon bibi-icon-each" title="Display Each">'+C.Shape.Spread+"</span>",onclick:function(){R.changeBookDisplayMode("each")}}))},C.Menus["spread-layout-axis"]=C.Menus.appendChild(sML.create("ul",{id:"spread-layout-axis"})),C.Menus["spread-layout-axis"].Buttons={vertical:C.Menus["spread-layout-axis"].appendChild(sML.create("li",{id:"layout-vertical",innerHTML:'<span class="bibi-icon bibi-icon-vertical" title="Layout Vertically">'+C.Shape.SpreadsV+"</span>",onclick:function(){C.Switch.Bar.toggle(function(){R.changeSpreadLayoutAxis("vertical")})}})),horizontal:C.Menus["spread-layout-axis"].appendChild(sML.create("li",{id:"layout-horizontal",innerHTML:'<span class="bibi-icon bibi-icon-horizontal" title="Layout Horizontally">'+C.Shape.SpreadsH+"</span>",onclick:function(){C.Switch.Bar.toggle(function(){R.changeSpreadLayoutAxis("horizontal")})}}))},sML.each(C.Menus.getElementsByClassName("bibi-icon"),function(){this.innerHTML='<span class="non-visual">'+this.title+"</span>"+this.innerHTML}),C.listenKeys=function(a){C.KeyCode=a.keyCode;var b=null;if("ttb"==S["spread-layout-direction"])switch(a.keyCode){case 37:b=0;break;case 38:b=-1;break;case 39:b=0;break;case 40:b=1}else if("ltr"==S["spread-layout-direction"])switch(a.keyCode){case 37:b=-1;break;case 38:b=0;break;case 39:b=1;break;case 40:b=0}else if("rtl"==S["spread-layout-direction"])switch(a.keyCode){case 37:b=1;break;case 38:b=0;break;case 39:b=-1;break;case 40:b=0}switch(b){case-1:return R.page(-1);case 1:return R.page(1);case 0:return C.Switch.Bar.toggle()}},window.addEventListener("keydown",C.listenKeys,!1))},O.readExtra=function(){O.EPUBCFI=BibiEPUBCFI,Q=sML.getQueries(),H=O.parseHash(),X={},history.replaceState&&history.replaceState(null,null,location.href.replace(/[\,#]bibi_x\([^\)]*\)$/g,"")),Q=function(a,b,c){return Q.BDM=Q["book-display-mode"]||Q.dm,Q.SLA=Q["spread-layout-direction"]||Q.sd,Q.PSF=Q["page-size-format"]||Q.po,Q.preset&&c.push("preset:"+Q.preset),Q.BDM&&c.push(Q.BDM),Q.SLA&&c.push(Q.SLA),Q.PSF&&c.push(Q.PSF),c.length&&(a.bibi=c.join(",")),a.book=b,a}({},Q.book,[]),history.replaceState&&history.replaceState(null,null,location.href.replace(/[#\,]$/,"").replace(/(\?book=[^&#]+)[^#]*(#.+)?$/g,"$1$2")),!H.bibi&&Q.bibi&&(H.bibi=Q.bibi,history.replaceState&&history.replaceState(null,null,location.href+(location.hash?",":"#")+"bibi("+H.bibi+")")),X.Wait=!0,(parent==window&&!H.wait||H.auto)&&delete X.Wait,history.replaceState&&history.replaceState(null,null,location.href.replace(/\,?(wait|auto)\([^\)]*\)/g,"")),H.bibi&&(H.bibi=H.bibi.replace(" ",""),sML.each(H.bibi.split(","),function(){var a=this.split(":");if(a[0]){if(a[1])switch(a[0]){case"preset":return void(X.Preset=a[1].replace(/(\.js)?$/,".js"));case"to":return void(X.To=O.getBibitoTarget(a[1]));default:return}switch(a[0]){case"all":case"each":return void(X.BDM||(X.BDM=a[0]));case"horizontal":case"vertical":return void(X.SLA||(X.SLA=a[0]));case"window":case"portrait":case"landscape":return void(X.PSF||(X.PSF=a[0]))}}})),H.bibi_x&&(H.bibi_x=H.bibi_x.replace(" ",""),sML.each(H.bibi_x.split(","),function(){var a=this.split(":");if(a[0]&&a[1])switch(a[0]){case"nav":return void(X.Nav=1*a[1])}})),!X.To&&H.epubcfi&&(X.To=O.getEPUBCFITarget(H.epubcfi))},O.parseHash=function(){if(!location.hash)return{};var a=location.hash.replace(/^#/,""),b=0,c={},d=function(){for(var d=b,e="";/[a-z_]/.test(a.charAt(b));)b++;if("("!=a.charAt(b))return null;for(e=a.substr(d,b-1-d+1),b++;")"!=a.charAt(b);)b++;c[e]=a.substr(d,b-d+1).replace(/^[a-z_]+\(/,"").replace(/\)$/,""),b++};return function(){for(d();","==a.charAt(b);)b++,d()}(),c},O.getBibitoTarget=function(a){if("number"==typeof a&&(a=""+a),"string"!=typeof a||!/^[1-9][0-9]*(-[1-9][0-9]*(\.[1-9][0-9]*)*)?$/.test(a))return null;var b="",c=a.split("-"),d=parseInt(c[0]),e=c[1]?c[1]:null;return e&&sML.each(e.split("."),function(){b+=">*:nth-child("+this+")"}),{BibitoString:a,ItemIndex:d-1,Element:b?"body"+b:null}},O.getEPUBCFITarget=function(a){var b=O.EPUBCFI.parse(a);if(!b||b.Path.Steps.length<2||!b.Path.Steps[1].Index||b.Path.Steps[1].Index%2==1)return null;var c=b.Path.Steps[1].Index/2-1,d=null,e=null,f=null,g=null;return b.Path.Steps[2]&&b.Path.Steps[2].Steps&&(d="",sML.each(b.Path.Steps[2].Steps,function(a){return"IndirectPath"==this.Type?(g=this,!1):"TermStep"==this.Type?(f=this,!1):this.Index%2==1&&(e=this.Index-1,a!=b.Path.Steps[2].Steps.length-2)?!1:void(null===e&&(d=this.ID?"#"+this.ID:d+">*:nth-child("+this.Index/2+")"))}),d&&/^>/.test(d)&&(d="html"+d),d||(d=null)),{CFI:b,CFIString:a,ItemIndex:c,Element:d,TextNodeIndex:e,TermStep:f,IndirectPath:g}},O.getLogo=function(a){return["<",a.Linkify?"a":"span",' class="bibi-logo"',a.Linkify?' href="http://sarasa.la/bib/i" target="_blank" title="BiB/i | Web Site"':"",">",'<span class="bibi-type-B">B</span>','<span class="bibi-type-i">i</span>','<span class="bibi-type-B">B</span>','<span class="bibi-type-slash">/</span>','<span class="bibi-type-i">i</span>',"</",a.Linkify?"a":"span",">"].join("")},O.log=function(a,b){(!parent||parent==window)&&console&&console.log&&b&&"string"==typeof b&&(status="BiB/i: "+b,O.statusClearer&&clearTimeout(O.statusClearer),O.statusClearer=setTimeout(function(){status=defaultStatus},3210),0==a?b="[ERROR] "+b:1==a?b="---------------- "+b+" ----------------":2==a?b=b:3==a?b=" - "+b:4==a&&(b="   . "+b),console.log("BiB/i: "+b))},O.isBin=function(a){return/\.(gif|jpe?g|png|ttf|otf|woff|mp[g34]|m4[av]|ogg|webm|pdf)$/i.test(a)},O.getPath=function(){return function(a){for(var b=a[0],c=a.length,d=1;c>d;d++)b+="/"+a[d];return b}(arguments).replace(/\/\.\//g,"/").replace(/[^\/]+\/\.\.\//g,"").replace(/\/\//g,"/").replace(/^\//,"")},O.toBibiXML=function(a){return a.replace(/<\?[^>]*?\?>/g,"").replace(/<([\w:\d]+) ([^>]+?)\/>/g,"<$1 $2></$1>").replace(/<(opf:)?([^!\?\/ >]+)/g,"<bibi:$2").replace(/<\/(opf:)?([^!\?\/ >]+)>/g,"</bibi:$2>")},O.ContentTypeList={"image/gif":/\.gif$/i,"image/png":/\.png$/i,"image/jpeg":/\.jpe?g$/i,"image/svg+xml":/\.svg$/i,"font/truetype":/\.ttf$/i,"font/opentype":/\.otf$/i,"font/woff":/\.woff$/i,"text/css":/\.css$/i,"text/javascript":/\.js$/i,"text/html":/\.html?$/i,"application/xhtml+xml":/\.xhtml$/i,"application/pdf":/\.pdf$/i},sML.ready(O.welcome),BibiEPUBCFI={/*!
 *
 *  # BiB/i EPUB-CFI Utilities
 *
 *  - "EPUB-CFI Utilities (for BiB/i, or Others)"
 *  - (c) Satoru MATSUSHIMA - http://sarasa.la/bib/i
 *  - Licensed under the MIT license. - http://www.opensource.org/licenses/mit-license.php
 *
 *  - Sun June 22 23:59:59 2014 +0900
 */
Version:.32,Build:20140622,CFIString:"",Current:0,parse:function(a,b){if(!a||"string"!=typeof a)return null;try{a=decodeURIComponent(a)}catch(c){return this.log(0,"Unregulated URIEncoding."),null}return b&&"string"==typeof b&&"function"==typeof this["parse"+b]||(b="Fragment"),"Fragment"==b&&(a=a.replace(/^(epubcfi\()?/,"epubcfi(").replace(/(\))?$/,")")),this.CFIString=a,this.Current=0,this.Log&&this.LogCancelation&&(this.log(1,"BiB/i EPUB-CFI"),this.log(2,"parse"),this.log(3,"CFIString: "+this.CFIString)),this["parse"+b]()},parseFragment:function(){var a=this.Current,b={};return this.parseString("epubcfi(")?(b=this.parseCFI(),null===b?this.cancel(a):this.parseString(")")?b:this.cancel(a,"Fragment")):this.cancel(a,"Fragment")},parseCFI:function(){var a=this.Current,b={Type:"CFI",Path:{}};if(b.Path=this.parsePath(),!b.Path)return this.cancel(a,"CFI");if(this.parseString(",")){if(b.Start=this.parseLocalPath(),!b.Start.Steps.length&&!b.Start.TermStep)return this.cancel(a,"CFI > Range");if(!this.parseString(","))return this.cancel(a,"CFI > Range");if(b.End=this.parseLocalPath(),!b.End.Steps.length&&!b.End.TermStep)return this.cancel(a,"CFI > Range")}return b},parsePath:function(){var a=this.Current,b={Type:"Path",Steps:[]},c={};return b.Steps[0]=this.parseStep(),b.Steps[0]&&(c=this.parseLocalPath())?(b.Steps=b.Steps.concat(c.Steps),b):this.cancel(a,"Path")},parseLocalPath:function(){var a=(this.Current,{Type:"LocalPath",Steps:[]}),b=a,c=null,d=null;for(c=this.parseStep("Local");null!==c&&(b.Steps.push(c),c=this.parseStep("Local"));)if("IndirectStep"==c.Type){var e={Type:"IndirectPath",Steps:[]};b.Steps.push(e),b=e}else if("TermStep"==c.Type){d=c;break}return d&&b.Steps.push(d),a.Steps.length?a:null},parseStep:function(a){var b=this.Current,c={};if(this.parseString("/"))c.Type="Step";else if(a&&this.parseString("!/"))c.Type="IndirectStep";else{if(!a||!this.parseString(":"))return this.cancel(b,"Step");c.Type="TermStep"}if(c.Index=this.parseString(/^(0|[1-9][0-9]*)/),null===c.Index)return this.cancel(b,"Step");if(c.Index=parseInt(c.Index),this.parseString("[")){if("TermStep"!=c.Type){if(c.ID=this.parseString(/^[_a-zA-Z][_a-zA-Z0-9\-]+/),!c.ID)return this.cancel(b,"Step > Assertion > ID")}else{var d=[],e=null,f=/^((\^[\^\[\]\(\)\,\;\=])|[_a-zA-Z0-9%\- ])*/;if(d.push(this.parseString(f)),this.parseString(",")&&d.push(this.parseString(f)),d[0]&&(c.Preceding=d[0]),d[1]&&(c.Following=d[1]),this.parseString(/^;s=/)&&(e=this.parseString(/^[ab]/)),e&&(c.Side=e),!c.Preceding&&!c.Following&&!c.Side)return this.cancel(b,"Step > Assertion > TextLocation")}if(!this.parseString("]"))return this.cancel(b,"Step > Assertion")}return c},parseString:function(a){var b=null;if(a instanceof RegExp){var c=this.CFIString.substr(this.Current,this.CFIString.length-this.Current);a.test(c)&&(a=c.match(a)[0],this.Current+=a.length,b=a)}else this.CFIString.substr(this.Current,a.length)===a&&(this.Current+=a.length,b=a);return this.correct(b)},correct:function(a){return this.Log&&this.LogCorrection&&a&&this.log(3,a),a},cancel:function(a,b){return this.Log&&this.LogCancelation&&this.log(4,"cancel: parse"+b+" ("+a+"-"+this.Current+"/"+this.CFIString.length+")"),"number"==typeof a&&(this.Current=a),null},log:function(a,b){this.Log&&console&&console.log&&(0==a?b="[ERROR] "+b:1==a?b="---------------- "+b+" ----------------":2==a?b=b:3==a?b=" - "+b:4==a&&(b="   . "+b),console.log("BiB/i EPUB-CFI: "+b))}};
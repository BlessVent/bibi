/*!
 *
 * # BiB/i: Scripts
 *
 * 1. bib/i/res/scripts/src/bibi.core.js
 * 2. bib/i/res/scripts/src/bibi.epubcfi.js
 *
 * - 2014/07/24
 */
Bibi={/*!
 *
 *  # BiB/i (core)
 *
 *  - "EPUB Reader on Your Web Site."
 *  - (c) Satoru MATSUSHIMA - http://sarasa.la/bib/i
 *  - Licensed under the MIT license. - http://www.opensource.org/licenses/mit-license.php
 *
 *  - Mon July 21 23:05:00 2014 +0900
 */
Version:.997,Build:20140721},A={},B={},C={},H={},L={},N={},O={},P={},Q={},R={},S={},X={},O.welcome=function(){O.log(1,"Welcome !"),O.HTML=document.getElementsByTagName("html")[0],O.Head=document.getElementsByTagName("head")[0],O.Body=document.getElementsByTagName("body")[0],O.Title=document.getElementsByTagName("title")[0],(sML.OS.iOS||sML.OS.Android)&&(O.SmartPhone=!0,O.setOrientation=function(){window.scrollBy(1,1),sML.removeClass(O.HTML,"orientation-"+(0==window.orientation?"landscape":"portrait")),sML.addClass(O.HTML,"orientation-"+(0==window.orientation?"portrait":"landscape")),O.HTML.style.minHeight=window.innerHeight+"px"},window.addEventListener("orientationchange",O.setOrientation),O.setOrientation(),setTimeout(O.setOrientation,1),setTimeout(O.setOrientation,100),setTimeout(O.setOrientation,800)),sML.OS.iOS&&(O.Head.appendChild(sML.create("meta",{name:"apple-mobile-web-app-capable",content:"yes"})),O.Head.appendChild(sML.create("meta",{name:"apple-mobile-web-app-status-bar-style",content:"black"})));var a=["preparing"];for(var b in sML.OS)sML.OS[b]&&a.push(b);for(var c in sML.UA)sML.UA[c]&&c.length>2&&"Flash"!=c&&a.push(c);O.HTML.className=a.join(" "),R.Contents=O.Body.appendChild(sML.create("div",{id:"epub-contents"})),C.weaveCartain(),O.readExtra(),L.getBook(Q.book)},O.initialize=function(){O.log(2,"Initializing BiB/i..."),L.FileDigit=3,B={Container:{Path:"META-INF/container.xml"},Package:{}},R.Contents.innerHTML="",R.Contents.style.opacity=0,R.CoverImage=null,R.Navigation=null;var a="string"==typeof X.Preset&&X.Preset&&!/\//.test(X.Preset)?X.Preset.replace(/(\.js)?$/,".js"):"default.js",b=function(){sML.each(["spread-gap","spread-margin-start","spread-margin-end","item-padding-left","item-padding-right","item-padding-top","item-padding-bottom"],function(){P[this]="number"!=typeof P[this]||P[this]<0?0:Math.round(P[this])}),P["spread-gap"]%2&&P["spread-gap"]++,X.BDM&&/^(all|each)$/.test(X.BDM)&&(P["book-display-mode"]=X.BDM),X.SLA&&/^(horizontal|vertical)$/.test(X.SLA)&&(P["spread-layout-axis"]=X.SLA),X.PSF&&/^(portrait|landscape|window)$/.test(X.PSF)&&(P["page-size-format"]=X.PSF),"default.js"!==P.FileName&&O.updateSetting(P)};P.FileName||"default.js"!=a?P.FileName!=a&&(P.loaded=!1,document.getElementById("bibi-preset")&&sML.removeElement(document.getElementById("bibi-preset")),sML.insertAfter(sML.create("script",{id:"bibi-preset",onload:b}),document.getElementById("bibi-script")).src="../presets/"+a,P.FileName=a):(P.FileName="default.js",b()),O.log(3,'preset: "'+a+'"'),O.log(2,"Initialized.")},L.sayLoading=function(a){sML.addClass(O.HTML,"wait-please"),sML.addClass(C.Cartain,"animate"),C.Cartain.Message.note(a?a:"Loading ...")},L.shutUpLoading=function(a){sML.removeClass(O.HTML,"wait-please"),sML.removeClass(C.Cartain,"animate"),C.Cartain.Message.note(a?a:"")},L.error=function(a){sML.removeClass(O.HTML,"wait-please"),sML.removeClass(C.Cartain,"animate"),O.log(0,a)},L.download=function(a,b){var c=new XMLHttpRequest;return b&&c.overrideMimeType(b),c.open("GET",a,!1),c.send(null),200!==c.status?L.error("XHR HTTP status: "+c.status+' "'+a+'"'):c},L.requestDocument=function(a){var b=/\.(xml|opf|ncx)$/i.test(a);if(!B.Zipped){var c=L.download("../bookshelf/"+B.Name+"/"+a);if(!b)var d=c.responseXML}if("undefined"==typeof d||!d){var e=B.Zipped?A.Files[a]:c.responseText,d=sML.create("object",{innerHTML:b?O.toBibiXML(e):e});b&&sML.each([d].concat(sML.toArray(d.getElementsByTagName("*"))),function(){this.getElementsByTagName=function(a){return this.querySelectorAll("bibi_"+a.replace(/:/g,"_"))}})}return d&&d.childNodes&&d.childNodes.length?d:L.error('Invalid Content. - "'+a+'"')},L.getBook=function(a){var b=function(a){a.size&&/\.epub$/i.test(a.name)?(Q=H=X={},O.initialize(),L.sayLoading(),O.log(2,"Fetching EPUB..."),O.log(3,'"'+a.name+'"'),sML.edit(new FileReader,{onerror:function(){O.Body.style.opacity=1,C.Cartain.Message.note("Error. Something trouble...")},onload:function(){O.log(2,"Fetched."),L.preprocessEPUB(this.result),B.Name=a.name.replace(/\.epub$/i,""),B.Format="EPUB",B.Zipped=!0,L.readContainer()}}).readAsArrayBuffer(a)):C.Cartain.Message.note('Give me <span style="color:rgb(128,128,128);">EPUB</span>. Drop into this window.')};if(document.body.addEventListener("dragenter",function(a){a.preventDefault(),O.Body.style.opacity=.9},1),document.body.addEventListener("dragover",function(a){a.preventDefault(),O.Body.style.opacity=.9},1),document.body.addEventListener("dragleave",function(a){a.preventDefault(),O.Body.style.opacity=1},1),document.body.addEventListener("drop",function(a){a.preventDefault(),O.Body.style.opacity=1,b(a.dataTransfer.files[0])},1),"string"!=typeof a||!a||/\//.test(a))window.File?(C.Cartain.createCatcher({onchange:b}),C.Cartain.Message.note("Drop an EPUB file into this window, or click and select EPUB file.")):C.Cartain.Message.note("Tell me EPUB name via URL in address-bar.");else if(/\.epub$/i.test(a)){O.initialize();var c=function(){L.sayLoading(),O.log(2,"Fetching EPUB..."),O.log(3,'"'+a+'"');var b=L.download("../bookshelf/"+a,"text/plain;charset=x-user-defined").responseText;O.log(2,"Fetched."),L.preprocessEPUB(b),B.Name=a.replace(/\.epub$/i,""),B.Format="EPUB",B.Zipped=!0,L.readContainer()};X.Wait?(C.Cartain.createPlayButton({onplay:function(){c(),delete X.Wait}}),C.Cartain.Message.note("")):c()}else O.initialize(),L.sayLoading(),B.Name=a,B.Format="EPUB",L.readContainer()},L.preprocessEPUB=function(a){O.log(2,"Preprocessing EPUB..."),A={Files:{},FileCount:{All:0,HTML:0,CSS:0,SVG:0,Bitmap:0,Font:0,Audio:0,Video:0,PDF:0},getDataURI:function(a){for(var b in O.ContentTypeList)if(O.ContentTypeList[b].test(a))return"data:"+b+";base64,"+(O.isBin(a)?btoa(A.Files[a]):Base64.encode(A.Files[a]));return""}},a=(new JSZip).load(a);for(var b in a.files)a.files[b]._data&&(A.FileCount.All++,/\.(x?html?)$/i.test(b)?A.FileCount.HTML++:/\.(css)$/i.test(b)?A.FileCount.CSS++:/\.(svg)$/i.test(b)?A.FileCount.SVG++:/\.(gif|jpe?g|png)$/i.test(b)?A.FileCount.Bitmap++:/\.(woff|otf|ttf)$/i.test(b)?A.FileCount.Font++:/\.(m4a|aac|mp3|ogg)$/i.test(b)?A.FileCount.Audio++:/\.(mp4|m4v|ogv|webm)$/i.test(b)?A.FileCount.Video++:/\.(pdf)$/i.test(b)&&A.FileCount.PDF++,A.Files[b]=O.isBin(b)?a.file(b).asBinary():Base64.btou(a.file(b).asText()));L.FileDigit=(A.FileCount.All+"").length,A.FileCount.All&&O.log(3,sML.String.padZero(A.FileCount.All,L.FileDigit)+" Files"),A.FileCount.HTML&&O.log(4,sML.String.padZero(A.FileCount.HTML,L.FileDigit)+" HTML"),A.FileCount.CSS&&O.log(4,sML.String.padZero(A.FileCount.CSS,L.FileDigit)+" CSS"),A.FileCount.SVG&&O.log(4,sML.String.padZero(A.FileCount.SVG,L.FileDigit)+" SVG"),A.FileCount.Bitmap&&O.log(4,sML.String.padZero(A.FileCount.Bitmap,L.FileDigit)+" Bitmap"),A.FileCount.Font&&O.log(4,sML.String.padZero(A.FileCount.Font,L.FileDigit)+" Font"),A.FileCount.Audio&&O.log(4,sML.String.padZero(A.FileCount.Audio,L.FileDigit)+" Audio"),A.FileCount.Video&&O.log(4,sML.String.padZero(A.FileCount.Video,L.FileDigit)+" Video"),A.FileCount.PDF&&O.log(4,sML.String.padZero(A.FileCount.PDF,L.FileDigit)+" PDF"),delete a;var c=replaceResourceRefferences=function(a,b,c){"function"!=typeof c&&(c=function(a){return new RegExp("<\\??[a-zA-Z1-6:-]+[^>]*? "+a+'[ 	]*=[ 	]*[\'"](?!(?:https?|data):)([^"]+?)[\'"]',"g")});var d=A.Files[a].replace(/[\r\n]/g,"\n").replace(/\r/g,"\n"),e=a.replace(/\/?[^\/]+$/,"");for(var f in b){var g=c(f),h=d.match(g);if(h){var i=new RegExp("."+b[f]+"$","i");sML.each(h,function(){var b=this.replace(g,"$1"),c=O.getPath(e,(/^(\.*\/+|#)/.test(b)?"":"./")+b),f=c.split("#"),h=f[0]?f[0]:a,j=f[1]?f[1]:"";i.test(h)&&A.Files[h]&&(d=d.replace(this,this.replace(b,A.getDataURI(h)+(j?"#"+j:""))))})}}return d},d={CSS:0,SVG:0,HTML:0};for(var e in A.Files)/\.css$/.test(e)&&(A.Files[e]=function(a){var b=arguments.callee;if(!A.Files[a])return"";var d=/@import[ \t]*(?:url\()?["']?(?!(?:https?|data):)(.+?)['"]?(?:\))?[ \t]*;/g,e=A.Files[a].match(d);return e&&sML.each(e,function(){var c=O.getPath(a.replace(/[^\/]+$/,""),this.replace(d,"$1"));A.Files[c]&&(A.Files[a]=A.Files[a].replace(this,b(c)))}),A.Files[a]=c(a,{url:"gif|png|jpe?g|svg|ttf|otf|woff"},function(){return/url\(["']?(?!(?:https?|data):)(.+?)['"]?\)/g}),A.Files[a]}(e),d.CSS++);d.CSS&&O.log(3,sML.String.padZero(d.CSS,L.FileDigit)+" CSS");for(var e in A.Files)/\.svg$/.test(e)&&(A.Files[e]=c(e,{href:"css",src:"gif|png|jpe?g|svg|js","xlink:href":"gif|png|jpe?g"}),d.SVG++);d.SVG&&O.log(3,sML.String.padZero(d.SVG,L.FileDigit)+" SVG");for(var e in A.Files)/\.x?html?$/.test(e)&&(A.Files[e]=c(e,{href:"css",src:"gif|png|jpe?g|svg|js","xlink:href":"gif|png|jpe?g"}));for(var e in A.Files)/\.x?html?$/.test(e)&&(A.Files[e]=c(e,{src:"x?html?"}),d.HTML++);d.HTML&&O.log(3,sML.String.padZero(d.HTML,L.FileDigit)+" HTML"),O.log(2,"Preprocessed.")},L.readContainer=function(){var a=L.requestDocument(B.Container.Path);O.log(2,"Reading Container XML..."),O.log(3,B.Container.Path),B.Package.Path=a.getElementsByTagName("rootfile")[0].getAttribute("full-path"),B.Package.Dir=B.Package.Path.replace(/\/?[^\/]+$/,""),O.log(2,"Read."),delete a,L.readPackageDocument()},L.readPackageDocument=function(){var a=L.requestDocument(B.Package.Path);O.log(2,"Reading Package Document..."),O.log(3,B.Package.Path);var b=a.getElementsByTagName("metadata")[0],c=a.getElementsByTagName("manifest")[0],d=a.getElementsByTagName("spine")[0],e=c.getElementsByTagName("item"),f=d.getElementsByTagName("itemref");if(e.length<=0)return O.log(0,'"'+B.Package.Path+'" has no <item> in <manifest>.');if(f.length<=0)return O.log(0,'"'+B.Package.Path+'" has no <itemref> in <spine>.');B.Package.Metadata={title:"",creator:"",publisher:"",language:"",titles:[],creators:[],publishers:[],languages:[]},B.Package.Manifest={items:{},nav:{},"cover-image":{},"toc-ncx":{}},B.Package.Spine={itemrefs:[]},sML.each(b.getElementsByTagName("meta"),function(){if(!this.getAttribute("refines")){if(this.getAttribute("property")){var a=this.getAttribute("property").replace(/^dcterms:/,"");/^(title|creator|publisher|language)$/.test(a)?B.Package.Metadata[a+"s"].push(this.textContent):B.Package.Metadata[a]||(B.Package.Metadata[a]=this.textContent)}this.getAttribute("name")&&this.getAttribute("content")&&(B.Package.Metadata[this.getAttribute("name")]=this.getAttribute("content"))}}),B.Package.Metadata.titles.length||sML.each(a.getElementsByTagName("dc:title"),function(){return B.Package.Metadata.titles.push(this.textContent),!1}),B.Package.Metadata.creators.length||sML.each(a.getElementsByTagName("dc:creator"),function(){B.Package.Metadata.creators.push(this.textContent)}),B.Package.Metadata.publishers.length||sML.each(a.getElementsByTagName("dc:publisher"),function(){B.Package.Metadata.publishers.push(this.textContent)}),B.Package.Metadata.languages.length||sML.each(a.getElementsByTagName("dc:language"),function(){B.Package.Metadata.languages.push(this.textContent)}),B.Package.Metadata.languages.length||(B.Package.Metadata.languages[0]="en"),B.Package.Metadata.title=B.Package.Metadata.titles.join(", "),B.Package.Metadata.creator=B.Package.Metadata.creators.join(", "),B.Package.Metadata.publisher=B.Package.Metadata.publishers.join(", "),B.Package.Metadata.language=B.Package.Metadata.languages.join(", "),B.Package.Metadata["rendition:layout"]||(B.Package.Metadata["rendition:layout"]="reflowable"),B.Package.Metadata["rendition:orientation"]||(B.Package.Metadata["rendition:orientation"]="auto"),B.Package.Metadata["rendition:spread"]||(B.Package.Metadata["rendition:spread"]="auto"),B.Package.Metadata.cover||(B.Package.Metadata.cover=""),O.getMetadata=function(){return B.Package.Metadata};var g=d.getAttribute("toc");sML.each(e,function(){var a={id:this.getAttribute("id")||"",href:this.getAttribute("href")||"","media-type":this.getAttribute("media-type")||"",properties:this.getAttribute("properties")||"",fallback:this.getAttribute("fallback")||""};a.id&&a.href&&(B.Package.Manifest.items[a.id]=a,function(b){/ nav /.test(b)&&(B.Package.Manifest.nav.Path=O.getPath(B.Package.Dir,a.href)),/ cover-image /.test(b)&&(B.Package.Manifest["cover-image"].Path=O.getPath(B.Package.Dir,a.href))}(" "+a.properties+" "),g&&a.id==g&&(B.Package.Manifest["toc-ncx"].Path=O.getPath(B.Package.Dir,a.href)))}),B.Package.Spine["page-progression-direction"]=d.getAttribute("page-progression-direction"),B.Package.Spine["page-progression-direction"]&&/^(ltr|rtl)$/.test(B.Package.Spine["page-progression-direction"])||(B.Package.Spine["page-progression-direction"]="default");var h=[/(rendition:layout)-(.+)/,/(rendition:orientation)-(.+)/,/(rendition:spread)-(.+)/,/(rendition:page-spread)-(.+)/,/(page-spread)-(.+)/];sML.each(f,function(){var a={idref:this.getAttribute("idref")||"",linear:this.getAttribute("linear")||"",properties:this.getAttribute("properties")||"","page-spread":"","rendition:layout":B.Package.Metadata["rendition:layout"],"rendition:orientation":B.Package.Metadata["rendition:orientation"],"rendition:spread":B.Package.Metadata["rendition:spread"]};a.properties=a.properties.replace(/^\s+/,"").replace(/\s+$/,"").replace(/\s+/g," ").split(" "),sML.each(h,function(){var b=this;sML.each(a.properties,function(){return b.test(this)?(a[this.replace(b,"$1")]=this.replace(b,"$2").replace("rendition:",""),!1):void 0})}),a["rendition:page-spread"]&&(a["page-spread"]=a["rendition:page-spread"]),a["rendition:page-spread"]=a["page-spread"],a.viewport={content:null,width:null,height:null},a.viewBox={content:null,width:null,height:null},B.Package.Spine.itemrefs.push(a)});var i=[];B.Package.Metadata.title&&(i.push(B.Package.Metadata.title),O.log(3,"title: "+B.Package.Metadata.title)),B.Package.Metadata.creator&&(i.push(B.Package.Metadata.creator),O.log(3,"creator: "+B.Package.Metadata.creator)),B.Package.Metadata.publisher&&(i.push(B.Package.Metadata.publisher),O.log(3,"publisher: "+B.Package.Metadata.publisher)),i.length&&(O.Title.innerHTML="",O.Title.appendChild(document.createTextNode("BiB/i | "+i.join(" - ").replace(/&amp;?/gi,"&").replace(/&lt;?/gi,"<").replace(/&gt;?/gi,">")))),C.createPanel(),C.createSwitches(),O.log(2,"Read."),delete a,O.updateSetting({Reset:!0}),L.prepareSpine()},L.prepareSpine=function(){if(O.log(2,"Preparing Spine..."),R.Contents.innerHTML="",R.Spreads=[],R.Items=[],R.Pages=[],"rtl"==S.PPD)var a="right",b="left";else var a="left",b="right";sML.each(B.Package.Spine.itemrefs,function(c){var d=this,e=sML.create("iframe",{className:"item",id:"item-"+sML.String.padZero(c,L.FileDigit),scrolling:"no",allowtransparency:"true"});if(e.ItemRef=d,e.Path=O.getPath(B.Package.Dir,B.Package.Manifest.items[d.idref].href),e.Dir=e.Path.replace(/\/?[^\/]+$/,""),e.IsPrePaginated="pre-paginated"==d["rendition:layout"],"pre-paginated"==d["rendition:layout"]&&c){var f=R.Items[c-1];"pre-paginated"==f.ItemRef["rendition:layout"]&&f.ItemRef["page-spread"]==a&&d["page-spread"]==b&&(e.Pair=f,f.Pair=e)}if(e.Pair)var g=e.Pair.Spread;else{var h=R.Contents.appendChild(sML.create("div",{className:"spread-box"})),g=h.appendChild(sML.create("div",{className:"spread"}));"pre-paginated"==d["rendition:layout"]&&sML.addClass(h,"pre-paginated"),g.SpreadBox=h,g.Items=[],g.Pages=[],g.SpreadIndex=R.Spreads.length,R.Spreads.push(g)}var i=g.appendChild(sML.create("div",{className:"item-box"}));d["page-spread"]&&sML.addClass(i,"page-spread-"+d["page-spread"]),e.Spread=g,e.ItemBox=i,e.Pages=[],e.ItemIndexInSpread=g.Items.length,g.Items.push(e),e.ItemIndex=R.Items.length,R.Items.push(e)}),O.log(3,sML.String.padZero(R.Items.length,L.FileDigit)+" Items"),O.log(2,"Prepared."),L.loadCoverImage()},L.loadCoverImage=function(){if(!R.CoverImage){if(!B.Package.Manifest["cover-image"].Path)return O.log(2,"No Cover Image."),L.loadNavigation();R.CoverImage={Path:B.Package.Manifest["cover-image"].Path}}O.log(2,"Loading Cover Image..."),O.log(3,'"'+R.CoverImage.Path+'"'),sML.create("img",{onload:function(){sML.style(C.Cartain.Cover,{backgroundImage:"url("+this.src+")",opacity:1}),O.log(2,"Loaded."),L.loadNavigation()}}).src=function(){return B.Zipped?A.getDataURI(R.CoverImage.Path):"../bookshelf/"+B.Name+"/"+R.CoverImage.Path+"?cover-image"}()},L.loadNavigation=function(){if(B.Package.Manifest.nav.Path)R.Navigation={Path:B.Package.Manifest.nav.Path,Type:"NavigationDocument"};else{if(O.log(2,"No Navigation Document."),!B.Package.Manifest["toc-ncx"].Path)return O.log(2,"No TOC-NCX."),L.loadItems();R.Navigation={Path:B.Package.Manifest["toc-ncx"].Path,Type:"TOC-NCX"}}var a=L.requestDocument(R.Navigation.Path);if(O.log(2,"Loading Navigation..."),O.log(3,'"'+R.Navigation.Path+'"'),"NavigationDocument"==R.Navigation.Type)sML.each(a.querySelectorAll("nav"),function(){sML.each(this.querySelectorAll("*"),function(){this.removeAttribute("style")}),C.Panel.Navigation.Item.appendChild(this)});else{var b=a.getElementsByTagName("navMap")[0];sML.each(b.getElementsByTagName("navPoint"),function(){sML.insertBefore(sML.create("a",{href:this.getElementsByTagName("content")[0].getAttribute("src"),innerHTML:this.getElementsByTagName("text")[0].innerHTML}),this.getElementsByTagName("navLabel")[0]),sML.removeElement(this.getElementsByTagName("navLabel")[0]),sML.removeElement(this.getElementsByTagName("content")[0]);var a=sML.create("li");a.setAttribute("id",this.getAttribute("id")),a.setAttribute("playorder",this.getAttribute("playorder")),sML.insertBefore(a,this).appendChild(this),a.previousSibling&&a.previousSibling.tagName&&!/^a$/i.test(a.previousSibling.tagName)?a.previousSibling.appendChild(a):sML.insertBefore(sML.create("ul"),a).appendChild(a)}),C.Panel.Navigation.Item.innerHTML="<nav>"+b.innerHTML.replace(/<(bibi_)?navPoint( [^>]+)?>/gi,"").replace(/<\/(bibi_)?navPoint>/gi,"")+"</nav>"}L.postprocessLinkage(R.Navigation.Path,C.Panel.Navigation.Item,"InBibiNavigation"),O.log(2,"Loaded."),delete a,X.Wait?(L.shutUpLoading(),C.Cartain.createPlayButton({onplay:function(){L.loadItems()}}),C.Cartain.Message.note("")):L.loadItems()},L.loadItems=function(){O.log(2,"Loading Items..."),R.resetStage(),R.resetNavigation(),L.LoadedItems=0,L.ResizedWhileLoading=!1,L.listenResizingWhileLoading=function(){L.ResizedWhileLoading=!0},window.addEventListener("resize",L.listenResizingWhileLoading),sML.each(R.Items,function(){L.loadItem(this)}),setTimeout(function(){return L.LoadedItems<R.Items.length?setTimeout(arguments.callee,500):(document.body.style.display="",R.resetPages(),O.log(2,"Loaded."),void L.start())},250)},L.loadItem=function(a){var b=a.Path;if(a.Loaded=!1,/\.(x?html?)$/i.test(b))B.Zipped?(L.writeItemHTML(a,A.Files[b]),setTimeout(L.postprocessItem,10,a)):(a.src="../bookshelf/"+B.Name+"/"+b,a.onload=function(){L.postprocessItem(R.Items[a.ItemIndex])},a.ItemBox.appendChild(a));else if(/\.(svg)$/i.test(b))if(a.IsSVG=!0,B.Zipped)L.writeItemHTML(a,!1,"",A.Files[b].replace(/<\?xml-stylesheet (.+?)[ \t]?\?>/g,'<link rel="stylesheet" $1 />'));else{var c="../bookshelf/"+B.Name+"/"+b;L.writeItemHTML(a,!1,'<base href="'+c+'" />',L.download(c).responseText.replace(/<\?xml-stylesheet (.+?)[ \t]?\?>/g,'<link rel="stylesheet" $1 />'))}else/\.(gif|jpe?g|png)$/i.test(b)?(a.IsBitmap=!0,L.writeItemHTML(a,!1,"",'<img alt="" src="'+(B.Zipped?A.getDataURI(b):"../bookshelf/"+B.Name+"/"+b)+'" />')):/\.(pdf)$/i.test(b)&&(a.IsPDF=!0,L.writeItemHTML(a,!1,"",'<iframe     src="'+(B.Zipped?A.getDataURI(b):"../bookshelf/"+B.Name+"/"+b)+'" />'));O.log(3,sML.String.padZero(a.ItemIndex+1,L.FileDigit)+"/"+sML.String.padZero(B.Package.Spine.itemrefs.length,L.FileDigit)+" "+(b?'"'+b+'"':"... Not Found."))},L.writeItemHTML=function(a,b,c,d){a.ItemBox.appendChild(a),a.contentDocument.open(),a.contentDocument.write(b?b:["<html>","<head>"+c+"</head>",'<body onload="parent.L.postprocessItem(parent.R.Items['+a.ItemIndex+"]); document.body.removeAttribute('onload'); return false;\">"+d+"</body>","</html>"].join("")),a.contentDocument.close()},L.postprocessItem=function(a){O.showStatus("Loading... ( "+(L.LoadedItems+1)+"/"+R.Items.length+" Items )");var b=a.ItemRef;a.HTML=sML.edit(a.contentDocument.getElementsByTagName("html")[0],{Item:a}),a.Head=sML.edit(a.contentDocument.getElementsByTagName("head")[0],{Item:a}),a.Body=sML.edit(a.contentDocument.getElementsByTagName("body")[0],{Item:a}),sML.each(a.Body.getElementsByTagName("link"),function(){a.Head.appendChild(this)}),S["epub-additional-stylesheet"]&&a.Head.appendChild(sML.create("link",{rel:"stylesheet",href:S["epub-additional-stylesheet"]})),S["epub-additional-script"]&&a.Head.appendChild(sML.create("script",{src:S["epub-additional-script"]})),sML.each([a.HTML,a.Body],function(){this.Bibi={DefaultStyle:{margin:this.style&&this.style.margin?this.style.margin:"",padding:this.style&&this.style.padding?this.style.padding:""}}}),sML.UA.Gecko||sML.CSS.add({html:"-webkit-text-size-adjust: none;","::selection":"background: rgba(255,192,0,0.5);"},a.contentDocument);var c=a.contentDocument.querySelectorAll("body>*");if(1==c.length&&(/^svg$/i.test(c[0].tagName)?a.SingleSVG=!0:/^img$/i.test(c[0].tagName)&&(a.SingleIMG=!0)),sML.each(a.Body.getElementsByTagName("img"),function(){this.Bibi={DefaultStyle:{margin:this.style.margin?this.style.margin:"",width:this.style.width?this.style.width:"",height:this.style.height?this.style.height:"",maxWidth:this.style.maxWidth?this.style.maxWidth:"",maxHeight:this.style.maxHeight?this.style.maxHeight:""}}}),sML.each(a.Head.getElementsByTagName("meta"),function(){if("viewport"==this.name&&(b.viewport.content=this.getAttribute("content"),b.viewport.content)){var a=1*b.viewport.content.replace(/^.*?width=([^\, ]+).*$/,"$1"),c=1*b.viewport.content.replace(/^.*?height=([^\, ]+).*$/,"$1");isNaN(a)||isNaN(c)||(b.viewport.width=a,b.viewport.height=c)}}),"pre-paginated"==b["rendition:layout"]&&!(b.viewport.width*b.viewport.height))if(a.SingleSVG){if(c[0].getAttribute("viewBox")){b.viewBox.content=c[0].getAttribute("viewBox");var d=b.viewBox.content.split(" ");if(4==d.length){var e=1*d[2]-1*d[0],f=1*d[3]-1*d[1];e&&f&&("100%"!=c[0].getAttribute("width")&&c[0].setAttribute("width","100%"),"100%"!=c[0].getAttribute("height")&&c[0].setAttribute("height","100%"),b.viewport.width=b.viewBox.width=e,b.viewport.height=b.viewBox.height=f)}}}else a.SingleIMG&&(b.viewport.width=parseInt(getComputedStyle(c[0]).width),b.viewport.height=parseInt(getComputedStyle(c[0]).height));L.postprocessLinkage(a.Path,a.Body),R.resetItem(a),R.resetSpread(a.Spread),a.contentWindow.addEventListener("keydown",C.listenKeys,!1),L.LoadedItems++,a.Loaded=!0},L.postprocessLinkage=function(a,b,c){var d=a.replace(/\/?([^\/]+)$/,""),e=a.replace(/^.+?([^\/]+)$/,"$1");sML.each(b.getElementsByTagName("a"),function(b){var f=this;f.NavAIndex=b;var g=f.getAttribute("href");if(!g)return void(c&&(f.onclick=function(){return!1},sML.addClass(f,"bibi-navigation-inactive-link")));if(/^[a-zA-Z]+:/.test(g))return f.setAttribute("target","_blank");var h=O.getPath(d,(/^\.*\/+/.test(g)?"":"./")+(/^#/.test(g)?e:"")+g),i=h.split("#"),j=i[0]?i[0]:a,k=i[1]?i[1]:"";sML.each(R.Items,function(){var a=this;return j==a.Path?(f.setAttribute("data-bibi-original-href",g),f.setAttribute("href","bibi://"+B.Name+"/"+g),f.InBibiNavigation=c,f.Target={Item:a,Element:k?"#"+k:null},void(f.onclick=function(a){return R.Started?(this.InBibiNavigation&&sML.stopPropagation(a),R.focus(this.Target,{p:.75,t:20})):C.Cartain.PlayButton.play(this.Target,this.NavAIndex),!1})):void 0}),k&&/^epubcfi\(.+\)$/.test(k)&&(f.setAttribute("data-bibi-original-href",g),f.setAttribute("href","bibi://"+B.Name+"/#"+k),f.InBibiNavigation=c,f.Target=O.getEPUBCFITarget(k),f.onclick=function(a){return this.Target?(R.Started?(this.InBibiNavigation&&sML.stopPropagation(a),R.focus(this.Target,{p:.75,t:20})):C.Cartain.PlayButton.play(this.Target,this.NavAIndex),!1):!1}),c&&"number"==typeof X.Nav&&b==X.Nav&&f.Target&&(X.To=f.Target)})},L.start=function(){C.createArrows(),L.shutUpLoading(),sML.removeClass(O.HTML,"preparing"),R.layout({Reset:L.ResizedWhileLoading?!0:!1,Target:X.To?X.To:"head"}),window.removeEventListener("resize",L.listenResizingWhileLoading),delete L.listenResizingWhileLoading,delete L.ResizedWhileLoading,sML.each(R.Items,function(){this.ItemBox.style.background=this.contentDocument.defaultView.getComputedStyle(this.HTML).background,this.HTML.style.background="",this.style.background=this.contentDocument.defaultView.getComputedStyle(this.Body).background,this.Body.style.background=""}),sML.style(R.Contents,{transition:"opacity 0.75s ease-in-out",opacity:1}),sML.style(C.Switches.Panel,{display:"block"}),sML.style(C.Arrows,{opacity:1}),X.To&&sML.style(C.Arrows.Back,{opacity:1}),sML.style(C.Arrows.Forward,{opacity:1}),setTimeout(function(){C.Cartain.close(function(){setTimeout(function(){sML.each([C.Arrows.Back,C.Arrows.Forward],function(){sML.style(this,{opacity:""})})},500)})},1),L.shutUpLoading(),window.addEventListener(O.SmartPhone?"orientationchange":"resize",R.onresize),window.addEventListener("keydown",C.listenKeys,!1),R.Started=!0,O.log(1,"Enjoy!")},R.resetStage=function(){sML.OS.iOS&&sML.UA.Sa&&(O.Body.style.height="ttb"==S["spread-layout-direction"]?"100%":window.innerHeight+"px"),R.StageSize={Breadth:O.Body["client"+S.SIZE.B]-S["spread-margin-start"]-S["spread-margin-end"],Length:O.Body["client"+S.SIZE.L]-S["spread-gap"]},R.Contents.style["padding"+S.BASE.B]=R.Contents.style["padding"+S.BASE.A]=S["spread-gap"]/2+"px",R.Contents.style["padding"+S.BASE.S]=R.Contents.style["padding"+S.BASE.E]=S["spread-margin-start"]+"px",R.Contents.style.background=S["book-background"]},R.resetItem=function(a){a.Reset=!1,a.Reflowable="pre-paginated"!=a.ItemRef["rendition:layout"]||!a.ItemRef.viewport[S.SIZE.b]||!a.ItemRef.viewport[S.SIZE.l],a.Reflowable?R.resetItem_Reflowable(a):R.resetItem_PrePagenated(a),a.Reset=!0},R.resetItem_Reflowable=function(a){var b=(a.ItemIndex,a.ItemRef,a.ItemBox),c=a.Spread;a.Pages=[],a.scrolling="no";var d=""==a.HTML.innerText&&1==a.Body.getElementsByTagName("img").length,e=""==a.HTML.innerText&&1==a.Body.getElementsByTagName("iframe").length,f=R.StageSize.Breadth-(S["item-padding-"+S.BASE.s]+S["item-padding-"+S.BASE.e]),g=R.StageSize.Length-(S["item-padding-"+S.BASE.b]+S["item-padding-"+S.BASE.a]),h=f,i=g,j=S["item-padding-"+S.BASE.a]+S["spread-gap"]+S["item-padding-"+S.BASE.b];if("portrait"==S["page-size-format"]||"landscape"==S["page-size-format"]){var k=1.414/.96;("width"==S.SIZE.l&&"portrait"==S["page-size-format"]||"height"==S.SIZE.l&&"landscape"==S["page-size-format"])&&(k=1/k),i=Math.min(g,Math.floor(h*k))}if(b.style[S.SIZE.b]=h+(S["item-padding-"+S.BASE.s]+S["item-padding-"+S.BASE.e])+"px",a.style["padding"+S.BASE.B]=S["item-padding-"+S.BASE.b]+"px",a.style["padding"+S.BASE.A]=S["item-padding-"+S.BASE.a]+"px",a.style["padding"+S.BASE.S]=S["item-padding-"+S.BASE.s]+"px",a.style["padding"+S.BASE.E]=S["item-padding-"+S.BASE.e]+"px",a.style[S.SIZE.b]=h+"px",a.style[S.SIZE.l]=i+"px",a.HTML.style[S.SIZE.b]=h+"px",a.HTML.style[S.SIZE.l]=i+"px",sML.style(a.HTML,{"column-axis":"","column-width":"","column-gap":"","column-rule":""}),function(){return"string"!=typeof S["fit-images"]||"no"==S["fit-images"]?!1:"always"==S["fit-images"]?!0:a.HTML.innerText&&a.Body.getElementsByTagName("img").length>1?!1:"in-single-image-only-item"==S["fit-images"]?!0:!1}()){var l=1;d&&(sML.style(a.HTML,{"transform-origin":"",transformOrigin:"",transform:""}),(a.HTML["scroll"+S.SIZE.B]>h||a.HTML["scroll"+S.SIZE.L]>i)&&(l=Math.floor(100*Math.min(h/a.HTML["scroll"+S.SIZE.B],i/a.HTML["scroll"+S.SIZE.L]))/100,sML.style(a.HTML,{"transform-origin":"50% 0",transformOrigin:"50% 0",transform:"scale("+l+")"}))),sML.each(a.Body.getElementsByTagName("img"),function(){this.style.width=this.Bibi.DefaultStyle.width,this.style.height=this.Bibi.DefaultStyle.height;var b=Math.min(parseInt(getComputedStyle(a.Body)[S.SIZE.b]),Math.floor(h/l)),c=Math.min(parseInt(getComputedStyle(a.Body)[S.SIZE.l]),Math.floor(i/l));parseInt(getComputedStyle(this)[S.SIZE.b])>b&&(this.style[S.SIZE.b]=b+"px",this.style[S.SIZE.l]="auto"),parseInt(getComputedStyle(this)[S.SIZE.l])>c&&(this.style[S.SIZE.l]=c+"px",this.style[S.SIZE.b]="auto")})}if(e){var m=a.Body.getElementsByTagName("iframe")[0];m.style[S.SIZE.b]=h+"px",m.style[S.SIZE.l]=i+"px"}var n=sML.CSS.addRule("*","word-wrap: break-word;",a.contentDocument);a.ColumnBreadth=0,a.ColumnLength=0,a.ColumnGap=0,function(a,b,c){a=b.clientWidth,a=b.clientHeight,a=b.scrollWidth,a=b.scrollHeight,a=b.offsetWidth,a=b.offsetHeight,a=c.clientWidth,a=c.clientHeight,a=c.scrollWidth,a=c.scrollHeight,a=c.offsetWidth,a=c.offsetHeight}(0,a.HTML,a.Body),a.Body["scroll"+S.SIZE.B]>h&&(S.Paged=!0,a.ColumnBreadth=h,a.ColumnLength=i,a.ColumnGap=j,sML.style(a.HTML,{"column-axis":"ttb"!=S.SLD?"horizontal":"vertical","column-width":a.ColumnLength+"px","column-gap":a.ColumnGap+"px","column-rule":""})),sML.CSS.removeRule(n,a.contentDocument);var o=a.Body["scroll"+S.SIZE.L];sML.UA.InternetExplorer>=10&&(o=a.Body["client"+S.SIZE.L]);var p=d?Math.max(o,i):o,q=Math.ceil((p+j)/(i+j));p=(i+j)*q-j,b.style[S.SIZE.l]=p+(S["item-padding-"+S.BASE.b]+S["item-padding-"+S.BASE.a])+"px",a.style[S.SIZE.l]=p+"px";for(var r=0;q>r;r++){var s=b.appendChild(sML.create("span",{className:"page"}));s.style["padding"+S.BASE.B]=S["item-padding-"+S.BASE.b]+S["spread-gap"]/2+"px",s.style["padding"+S.BASE.A]=S["item-padding-"+S.BASE.a]+S["spread-gap"]/2+"px",s.style["padding"+S.BASE.S]=S["item-padding-"+S.BASE.s]+"px",s.style["padding"+S.BASE.E]=S["item-padding-"+S.BASE.e]+"px",s.style[S.SIZE.b]=h+"px",s.style[S.SIZE.l]=i+"px",s.style[S.BASE.b]=(i+j)*r-S["spread-gap"]/2+"px",s.Item=a,s.Spread=c,s.PageIndexInItem=a.Pages.length,a.Pages.push(s)}return a},R.resetItem_PrePagenated=function(a){var b=(a.ItemIndex,a.ItemRef),c=a.ItemBox,d=a.Spread;a.Pages=[],S.Paged=!0,a.HTML.style.margin=a.HTML.style.padding=a.Body.style.margin=a.Body.style.padding=0;var e=R.StageSize.Breadth,f=R.StageSize.Length;a.style["padding"+S.BASE.B]=a.style["padding"+S.BASE.A]=a.style["padding"+S.BASE.S]=a.style["padding"+S.BASE.E]=0,"ttb"!=S["spread-layout-direction"]||"right"!=b["page-spread"]&&"left"!=b["page-spread"]||(e/=2);var g=Math.min(Math.min(b.viewport[S.SIZE.b],e)/b.viewport[S.SIZE.b],Math.min(b.viewport[S.SIZE.l],f)/b.viewport[S.SIZE.l]);f=Math.floor(b.viewport[S.SIZE.l]*g),e=Math.floor(b.viewport[S.SIZE.b]*(f/b.viewport[S.SIZE.l])),a.style[S.SIZE.l]=c.style[S.SIZE.l]=f+"px",a.style[S.SIZE.b]=c.style[S.SIZE.b]=e+"px",sML.style(a.HTML,{width:b.viewport.width+"px",height:b.viewport.height+"px","transform-origin":"0 0",transformOrigin:"0 0",transform:"scale("+g+")"});var h=c.appendChild(sML.create("span",{className:"page"}));return"right"==b["page-spread"]?h.style.right=0:h.style.left=0,h.style[S.SIZE.b]=e+"px",h.style[S.SIZE.l]=f+"px",h.Item=a,h.Spread=d,h.PageIndexInItem=a.Pages.length,a.Pages.push(h),a},R.resetSpread=function(a){var b=a.SpreadBox;b.style["margin"+S.BASE.B]=b.style["margin"+S.BASE.A]="",b.style["margin"+S.BASE.E]=b.style["margin"+S.BASE.S]="auto",b.style.padding="",1==a.Items.length?(b.style[S.SIZE.b]=a.style[S.SIZE.b]=a.Items[0].ItemBox.style[S.SIZE.b],b.style[S.SIZE.l]=a.style[S.SIZE.l]=a.Items[0].ItemBox.style[S.SIZE.l]):(b.style.width=a.style.width=Math.ceil(parseFloat(a.Items[0].ItemBox.style.width)+parseFloat(a.Items[1].ItemBox.style.width))+"px",b.style.height=a.style.height=Math.ceil(Math.max(parseFloat(a.Items[0].ItemBox.style.height),parseFloat(a.Items[1].ItemBox.style.height)))+"px"),a.style["border-radius"]=S["spread-border-radius"],a.style["box-shadow"]=S["spread-box-shadow"]},R.resetPages=function(){return R.Pages=[],R.Spreads.forEach(function(a){a.Pages=[],a.Items.forEach(function(b){b.Pages.forEach(function(b){b.PageIndexInSpread=a.Pages.length,a.Pages.push(b),b.PageIndex=R.Pages.length,R.Pages.push(b)})})}),R.Pages},R.resetNavigation=function(){if(sML.style(C.Panel.Navigation.Item,{"float":""}),"rtl"==S.SLD){{C.Panel.Navigation.Item.scrollWidth-window.innerWidth}C.Panel.Navigation.Item.scrollWidth<window.innerWidth&&sML.style(C.Panel.Navigation.Item,{"float":"right"}),C.Panel.Navigation.ItemBox.scrollLeft=C.Panel.Navigation.ItemBox.scrollWidth-window.innerWidth}},R.layoutSpread=function(a,b){var c=a.SpreadBox,d=!1,e=!1;
if("each"==S.BDM?a==b.Item.Spread?(d=e=!0,c.style.display=""):c.style.display="none":(d=0==a.SpreadIndex,e=a.SpreadIndex==R.Spreads.length-1,c.style.display=""),c.style.padding="",c.offsetHeight<R.StageSize[S.SIZE.H]&&(c.style.padding=Math.floor((R.StageSize[S.SIZE.H]-c.offsetHeight)/2)+"px 0"),"vertical"==S.SLA){1==a.Items.length&&"right"==a.Items[0].ItemRef["page-spread"]?c.style.paddingLeft=a.offsetWidth+"px":1==a.Items.length&&"left"==a.Items[0].ItemRef["page-spread"]&&(c.style.paddingRight=a.offsetWidth+"px");var f=0;f=d?0:"reflowable"==B.Package.Metadata["rendition:layout"]?S["spread-gap"]:Math.floor(R.StageSize.Length/4-S["spread-gap"]),c.style.marginTop=f?f+"px":"",c.style.marginBottom=""}else{var g=0,h=0;d?(g=Math.floor((R.StageSize.Length-c["offset"+S.SIZE.L])/2),0>g&&(g=0)):g="reflowable"==B.Package.Metadata["rendition:layout"]?S["spread-gap"]:Math.floor(R.StageSize.Breadth/2-S["spread-gap"]),e&&(h=Math.ceil((R.StageSize.Length-c["offset"+S.SIZE.L])/2),0>h&&(h=0)),c.style["margin"+S.BASE.B]=g?g+"px":"",c.style["margin"+S.BASE.A]=h?h+"px":""}},R.layout=function(a){if(window.removeEventListener(O.SmartPhone?"orientationchange":"resize",R.onresize),a||(a={}),a.NoLog||(O.log(2,"Laying Out..."),O.log(3,"book-display-mode: "+S["book-display-mode"]),O.log(3,"spread-layout-axis: "+S["spread-layout-axis"]),O.log(3,"page-size-format: "+S["page-size-format"])),!a.Target){var b=R.getCurrentPages().Start;a.Target={ItemIndex:b.Item.ItemIndex,PageProgressInItem:b.PageIndexInItem/b.Item.Pages.length}}return a.Target=R.getTarget(a.Target),a.Setting&&O.updateSetting(a.Setting),a.Reset&&(S.Paged=!1,R.resetStage(),sML.each(R.Spreads,function(a){O.showStatus("Rendering... ( "+(a+1)+"/"+R.Spreads.length+" Spreads )"),sML.each(this.Items,function(){R.resetItem(this)}),R.resetSpread(this)}),R.resetPages(),R.resetNavigation()),sML.each(R.Spreads,function(){R.layoutSpread(this,a.Target)}),R.focus(a.Target,{p:1,t:1}),a.NoLog||O.log(2,"Laid Out."),"function"==typeof doAfter&&doAfter(),window.addEventListener(O.SmartPhone?"orientationchange":"resize",R.onresize),S},R.onresize=function(){R.Timer_layout_whenResized&&clearTimeout(R.Timer_layout_whenResized),R.Timer_layout_whenResized=setTimeout(function(){R.layout({Reset:!0})},sML.OS.iOS||sML.OS.Android?888:444)},R.changeView=function(a){sML.style(R.Contents,{transition:"opacity 0.5s linear",opacity:0},function(){R.layout({Setting:a,Reset:a["spread-layout-axis"]||a["page-size-format"]}),setTimeout(function(){sML.style(R.Contents,{transition:"opacity 0.5s linear",opacity:1})},100)})},R.changeBookDisplayMode=function(a){a!=S.BDM&&R.changeView({"book-display-mode":a})},R.changeSpreadLayoutAxis=function(a){a!=S.SLA&&R.changeView({"spread-layout-axis":a})},R.changePageSizeFormat=function(a){a!=S.PSF&&R.changeView({"page-size-format":a})},R.getTarget=function(a){if("string"==typeof a?a={Edge:a}:"number"==typeof a&&(a={Item:R.Items[a]}),"object"!=typeof a||!a)return null;if(a.tagName&&(TargetElement=a,a={},"number"==typeof TargetElement.SpreadIndex?a.Item=TargetElement.Items[0]:"number"==typeof TargetElement.ItemIndex?a.Item=TargetElement:"number"==typeof TargetElement.PageIndex?a.Page=TargetElement:a.Element=TargetElement),"string"==typeof a.Edge){if("head"==a.Edge)return{Edge:"head",EdgeTRBL:"ttb"==S.SLD?"T":"rtl"==S.SLD?"R":"L",Item:R.Items[0],Page:R.Pages[0]};if("foot"==a.Edge)return{Edge:"foot",EdgeTRBL:"ttb"==S.SLD?"B":"rtl"==S.SLD?"L":"R",Item:R.Items[R.Items.length-1],Page:R.Pages[R.Pages.length-1]}}return a.Item||"number"!=typeof a.ItemIndex||(a.Item=R.Items[a.ItemIndex]),a.Element?(a.Element.tagName?a.Item=a.Element.ownerDocument.body.Item?a.Element.ownerDocument.body.Item:null:"string"==typeof a.Element&&a.Item&&(a.Element=a.Item.contentDocument.querySelector(a.Element),a.Element||delete a.Element),a.Page=a.Item.Pages[0]):a.Page?a.Item=a.Page.Item:"number"==typeof a.PageIndexInItem&&a.Item?a.Page=a.Item.Pages[a.PageIndexInItem]:"number"==typeof a.PageProgressInItem&&a.Item?a.Page=a.Item.Pages[Math.floor(a.Item.Pages.length*a.PageProgressInItem)]:"number"==typeof a.PageIndex&&(a.Page=R.Pages[a.PageIndex],a.Item=a.Page.Item),a.Item?(a.Page||(a.Page=a.Item.Pages[0]),a):null},R.getCurrentPages=function(){for(var a=sML.getCoord(window),b=[],c=null,d=0,e=a[S.SIZE.l]/2,f=R.Pages.length,g=0;f>g;g++)if("none"!=R.Pages[g].style.display){var h=sML.getCoord(R.Pages[g]),i=Math.min(a[S.BASE.a]*S.AXIS.PM,h[S.BASE.a]*S.AXIS.PM)-Math.max(a[S.BASE.b]*S.AXIS.PM,h[S.BASE.b]*S.AXIS.PM),j=Math.abs(a[S.BASE.b]+a[S.BASE.a]-(h[S.BASE.b]+h[S.BASE.a]));if(i=0>=i||!h[S.SIZE.l]||isNaN(i)?-1:Math.round(i/h[S.SIZE.l]*100),d>i){if(b.length)break}else i==d?b.push(R.Pages[g]):i>d&&(b[0]=R.Pages[g],d=i),e>j&&(c=R.Pages[g],e=j)}return{All:b,Start:b[0],Center:c,End:b[b.length-1]}},R.getPageGroup=function(a){a=R.getTarget(a);for(var b="a"==a.Side?-1:1,c=[],d=0,e=window["inner"+S.SIZE.L],f=a.Page.PageIndex;f>=0&&f<R.Pages.length&&(!a.Item.IsPrePaginated||R.Pages[f].Spread==a.Page.Spread)&&!(e-R.Pages[f]["offset"+S.SIZE.L]<0);f+=b)c.push(R.Pages[f]),"ttb"==S.SLD&&R.Pages[f].Item.Pair&&R.Pages[f].Item.Pair==a.Page.Item||(e-=R.Pages[f]["offset"+S.SIZE.L],d+=R.Pages[f]["offset"+S.SIZE.L]);var g=Math.floor(e/2),h=g;return"a"==a.Side&&(c.reverse(),h+=d-a.Page["offset"+S.SIZE.L]),{Page:a.Page,Pages:c,Length:d,MarginBeforeGroup:g,MarginBeforePage:h}},R.focus=function(a,b){var c=R.getTarget(a);if("object"!=typeof c||!c)return!1;if(b||(b={p:.4,t:10}),c.Edge){var d=/^[TL]$/.test(c.EdgeTRBL)?0:O.Body["scroll"+S.SIZE.L]-O.Body["client"+S.SIZE.L];return sML.scrollTo("ttb"==S.SLD?{y:d}:{x:d},b),!1}if("each"==S.BDM&&c.Spread!=R.getCurrentPages().Start.Spread&&sML.each(R.Spreads,function(){R.layoutSpread(this,c)}),"ttb"==S.SLD)var e=["Top","Left"],f=["top","left"];else var e=["Left","Top"],f=["left","top"];var g,d,h={Element:c.Element,TextNodeIndex:c.TextNodeIndex,TermStep:c.TermStep},i=function(){};if(c.Element){g=c.Item.Pages[0];for(var j=g["offset"+e[0]];g.offsetParent;)g=g.offsetParent,j+=g["offset"+e[0]];g=c.Element;for(var k=g["offset"+e[0]],l=g["offset"+e[1]];g.offsetParent;)g=g.offsetParent,k+=g["offset"+e[0]],l+=g["offset"+e[1]];sML.getCoord(c.Element)[S.BASE.s]>c.Item["offset"+S.SIZE.B]-S["item-padding-"+S.BASE.s]-S["item-padding-"+S.BASE.e]?(k=0==l?0:"rtl"!=S.PPD?(c.Item.ColumnLength+c.Item.ColumnGap)*Math.floor(l/c.Item.ColumnBreadth)-S["item-padding-"+S.BASE.b]:(c.Item.ColumnLength+c.Item.ColumnGap)*Math.ceil(l/c.Item.ColumnBreadth)-S["item-padding-"+S.BASE.a],"rtl"==S.SLD&&(k=c.Item["offset"+S.SIZE.L]-k)):"rtl"==S.SLD&&(k+=c.Element["offset"+S.SIZE.L]),j+=S["item-padding-"+f[0]]+k,sML.each(c.Item.Pages,function(){var a=sML.getCoord(this)[S.BASE.b];return(j+8)*S.AXIS.PM<a*S.AXIS.PM?!1:void(d=a)}),"number"==typeof h.TextNodeIndex&&R.pointTextLocation(h)}else{var m=R.getPageGroup(c);for(g=m.Pages[0],d=g["offset"+e[0]];g.offsetParent;)g=g.offsetParent,d+=g["offset"+e[0]];if("rtl"==S.SLD&&(d+=Math.floor(m.Pages[0]["offset"+S.SIZE.L])),window["inner"+S.SIZE.L]>m.Pages[0]["offset"+S.SIZE.L]){var n=Math.floor((window["inner"+S.SIZE.L]-m.Length)/2);n>0&&(d-=n*S.AXIS.PM)}}return"rtl"==S.SLD&&(d-=window["inner"+S.SIZE.L]),sML.scrollTo("ttb"==S.SLD?{y:d}:{x:d},b,i),!1},R.pointTextLocation=function(a){if("number"==typeof a.TextNodeIndex){var b=a.Element.childNodes[a.TextNodeIndex];if(b&&b.textContent){var c={Start:{Node:b,Index:0},End:{Node:b,Index:b.textContent.length}};if(a.TermStep)if(a.TermStep.Preceding||a.TermStep.Following){if(c.Start.Index=a.TermStep.Index,c.End.Index=a.TermStep.Index,a.TermStep.Preceding&&(c.Start.Index-=a.TermStep.Preceding.length),a.TermStep.Following&&(c.End.Index+=a.TermStep.Following.length),c.Start.Index<0||b.textContent.length<c.End.Index)return;if(b.textContent.substr(c.Start.Index,c.End.Index-c.Start.Index)!=a.TermStep.Preceding+a.TermStep.Following)return}else if(a.TermStep.Side&&"a"==a.TermStep.Side){for(c.Start.Node=b.parentNode.firstChild;c.Start.Node.childNodes.length;)c.Start.Node=c.Start.Node.firstChild;c.End.Index=a.TermStep.Index-1}else{for(c.Start.Index=a.TermStep.Index,c.End.Node=b.parentNode.lastChild;c.End.Node.childNodes.length;)c.End.Node=c.End.Node.lastChild;c.End.Index=c.End.Node.textContent.length}return sML.select(c)}}},R.page=function(a){if(!S.Paged)return R.scroll(a);-1!=a&&(a=1);var b=R.getCurrentPages(),c=0>a?b.Start:b.End,d=c.PageIndex+a;if(0>d)return R.focus({Edge:"head"});if(d>R.Pages.length-1)return R.focus({Edge:"foot"});var e=R.Pages[d];"vertical"==S.SLA&&e.Item.Pair&&c.Item.Pair==e.Item&&(d+=a>0?1:-1),"horizontal"==S.SLA&&e.Item.Pair&&window["inner"+S.SIZE.L]>2*e.Item[S.SIZE.L]&&(0>a&&0==e.PageIndexInSpread&&(e=e.Spread.Pages[1]),a>0&&1==e.PageIndexInSpread&&(e=e.Spread.Pages[0]));sML.getCoord(window);return"each"==S.BDM&&e.Spread!=c.Spread?R.focus(e,{p:1,t:1}):R.focus({Page:e,Side:a>0?"b":"a"})},R.scroll=function(a){if(S.Paged)return R.page(a);-1!=a&&(a=1);var b=sML.getCoord(window),c={};switch(S.SLD){case"ttb":c={y:b.top+b.height*a};break;case"ltr":c={x:b.left+b.width*a};break;case"rtl":c={x:b.left+b.width*a*-1}}return sML.scrollTo(c,{p:.4,t:10})},R.to=function(a){return R.focus(O.getBibitoTarget(a))},C.weaveCartain=function(){C.Cartain=O.Body.appendChild(sML.create("div",{id:"bibi-cartain",State:1,open:function(a){return 1==this.State?"function"==typeof a?a():this.State:(this.State=1,this.style.display="block",this.style.zIndex=100,sML.style(this,{transition:"0.5s ease-out",transform:"translate"+S.AXIS.XY+"(0)",opacity:.75},function(){"function"==typeof a&&a()}),this.State)},close:function(a){return 0==this.State?"function"==typeof a?a():this.State:(this.State=0,this.Message.style.opacity=0,sML.style(this,{transition:"0.5s ease-in",transform:"translate"+S.AXIS.XY+"("+-1*S.AXIS.PM*240+"%)",opacity:0},function(){sML.style(this,{transition:"none",transform:"translate"+S.AXIS.XY+"("+240*S.AXIS.PM+"%)"}),this.style.zIndex=1,this.style.display="none","function"==typeof a&&a()}),this.State)},toggle:function(a){return 0==this.State?this.open(a):this.close(a)}})),C.Cartain.Cover=C.Cartain.appendChild(sML.create("div",{id:"bibi-cartain-cover"})),C.Cartain.Mark=C.Cartain.appendChild(sML.create("p",{id:"bibi-cartain-mark",className:"animate"})),C.Cartain.Message=C.Cartain.appendChild(sML.create("p",{id:"bibi-cartain-message",className:"animate"})),C.Cartain.Powered=C.Cartain.appendChild(sML.create("p",{id:"bibi-cartain-powered",innerHTML:""+O.getLogo({Linkify:!0})}));for(var a=1;8>=a;a++)C.Cartain.Mark.appendChild(sML.create("span",{className:"dot"+a}));C.Cartain.createPlayButton=function(a){C.Cartain.PlayButton=C.Cartain.appendChild(sML.create("p",{id:"bibi-cartain-playbutton",title:(sML.OS.iOS||sML.OS.Android?"Tap":"Click")+" to Open",play:function(b,c){if(O.SmartPhone){var d=location.href.replace(/&wait=[^&]+/g,"");return"number"==typeof c&&(d=[d,"bibi_x(nav:"+c+")"].join(/#/.test(d)?",":"#")),window.open(d)}b&&(X.To=b),L.sayLoading(),this.onclick=function(){return!1},sML.style(this,{opacity:0,cursor:"default"}),a.onplay()},onclick:function(a){this.play(),sML.stopPropagation(a)}})),C.Cartain.PlayButton.innerHTML='<span class="non-visual">'+C.Cartain.PlayButton.title+" to Open</span>"},C.Cartain.createCatcher=function(a){C.Cartain.Catcher=C.Cartain.appendChild(sML.create("p",{id:"bibi-cartain-catcher",title:"Drop me an EPUB! or Click me!",onclick:function(){this.Input||(this.Input=this.appendChild(sML.create("input",{type:"file",onchange:function(b){a.onchange(b.target.files[0]),C.Cartain.Catcher.style.opacity=0}}))),this.Input.click()}}))},C.Cartain.Message.note=function(a){return C.Cartain.Message.innerHTML=a,a}},C.createPanel=function(){if(C.Panel?C.Panel.innerHTML="":C.Panel=O.Body.appendChild(sML.create("div",{id:"bibi-panel",State:0,open:function(a){return 1==this.State?"function"==typeof a?a():this.State:(this.State=1,C.Switches.Panel.toggleState(this.State),sML.style(C.Panel,{transition:"0.2s ease-in"}),sML.style(R.Contents,{transition:"0.2s ease-in"}),sML.addClass(O.HTML,"bibi-panel-opened"),setTimeout(a,250),this.State)},close:function(a){return 0==this.State?"function"==typeof a?a():this.State:(this.State=0,C.Switches.Panel.toggleState(this.State),sML.style(C.Panel,{transition:"0.2s ease-out"}),sML.style(R.Contents,{transition:"0.2s ease-out"}),sML.removeClass(O.HTML,"bibi-panel-opened"),setTimeout(a,250),this.State)},toggle:function(a){return 0==this.State?this.open(a):this.close(a)}})),C.Panel.Misc=C.Panel.appendChild(sML.create("div",{id:"bibi-panel-misc",innerHTML:O.getLogo({Linkify:!0})})),C.Panel.Navigation=C.Panel.appendChild(sML.create("div",{id:"bibi-panel-navigation"})),C.Panel.Navigation.ItemBox=C.Panel.Navigation.appendChild(sML.create("div",{id:"bibi-panel-navigation-item-box",onclick:function(){C.Panel.toggle()}})),C.Panel.Navigation.Item=C.Panel.Navigation.ItemBox.appendChild(sML.create("div",{id:"bibi-panel-navigation-item"})),C.Panel.Menu=C.Panel.appendChild(sML.create("div",{id:"bibi-panel-menu"})),!(sML.UA.InternetExplorer<12||sML.UA.Opera<15||sML.UA.Gecko)){var a={};a.Item='<span class="bibi-shape bibi-shape-item"></span>',a.Spread='<span class="bibi-shape bibi-shape-spread">'+a.Item+a.Item+"</span>",a.Spreads='<span class="bibi-shape bibi-shape-spreads">'+a.Spread+a.Spread+a.Spread+"</span>",a.SpreadsV='<span class="bibi-shape bibi-shape-spreads-vertical">'+a.Spread+a.Spread+a.Spread+"</span>",a.SpreadsH='<span class="bibi-shape bibi-shape-spreads-horizontal">'+a.Spread+a.Spread+a.Spread+"</span>",C.Panel.Menu["book-display-mode"]=C.Panel.Menu.appendChild(sML.create("ul",{id:"book-display-mode"})),C.Panel.Menu["book-display-mode"].Buttons={all:C.Panel.Menu["book-display-mode"].appendChild(sML.create("li",{id:"display-all",innerHTML:'<span class="bibi-icon bibi-icon-all" title="Display All">'+a.Spreads+"</span>",onclick:function(){R.changeBookDisplayMode("all")}})),each:C.Panel.Menu["book-display-mode"].appendChild(sML.create("li",{id:"display-each",innerHTML:'<span class="bibi-icon bibi-icon-each" title="Display Each">'+a.Spread+"</span>",onclick:function(){R.changeBookDisplayMode("each")}}))},C.Panel.Menu["spread-layout-axis"]=C.Panel.Menu.appendChild(sML.create("ul",{id:"spread-layout-axis"})),C.Panel.Menu["spread-layout-axis"].Buttons={vertical:C.Panel.Menu["spread-layout-axis"].appendChild(sML.create("li",{id:"layout-vertical",innerHTML:'<span class="bibi-icon bibi-icon-vertical" title="Layout Vertically">'+a.SpreadsV+"</span>",onclick:function(){C.Panel.toggle(function(){R.changeSpreadLayoutAxis("vertical")})}})),horizontal:C.Panel.Menu["spread-layout-axis"].appendChild(sML.create("li",{id:"layout-horizontal",innerHTML:'<span class="bibi-icon bibi-icon-horizontal" title="Layout Horizontally">'+a.SpreadsH+"</span>",onclick:function(){C.Panel.toggle(function(){R.changeSpreadLayoutAxis("horizontal")})}}))},sML.each(C.Panel.Menu.getElementsByClassName("bibi-icon"),function(){this.innerHTML='<span class="non-visual">'+this.title+"</span>"+this.innerHTML})}},C.createSwitches=function(){C.Switches?C.Switches.innerHTML="":C.Switches=O.Body.appendChild(sML.create("div",{id:"bibi-switches"},{transition:"opacity 0.75s linear"}));var a=function(a){this.State="number"==typeof a?a:Math.abs(this.State-1);var b=B.Package.Metadata.languages[0].split("-")[0],c=(b&&"en"!=b?this.Labels[this.State][b]+" / ":"")+this.Labels[this.State].en;return this.title=c,this.innerHTML='<span class="non-visual">'+c+"</span>",this.State};C.Switches.Panel=C.Switches.appendChild(sML.create("span",{className:"bibi-switches-switch",id:"bibi-switches-panel",State:0,Labels:[{ja:"メニューを開く",en:"Open Menu"},{ja:"メニューを閉じる",en:"Close Menu"}],toggleState:a,onclick:function(){return C.Panel.toggle()}})),C.Switches.FullScreen=C.Switches.appendChild(sML.create("span",{className:"bibi-switches-switch",id:"bibi-switches-fullscreen",State:0,Labels:[{ja:"フルスクリーンモードを開始",en:"Enter Full-Screen"},{ja:"フルスクリーンモードを終了",en:"Exit Full-Screen"}],toggleState:a,enter:function(a){this.toggleState(1),sML.requestFullScreen(parent!=window?O.ParentFrame:null),setTimeout(function(){sML.addClass(O.HTML,"bibi-fullscreen"),"function"==typeof a&&a()},200)},exit:function(a){this.toggleState(0),sML.exitFullScreen(parent.document),setTimeout(function(){sML.removeClass(O.HTML,"bibi-fullscreen"),"function"==typeof a&&a()},200)},toggle:function(a){return 0==this.State?this.enter(a):this.exit(a)},onclick:function(){this.toggle()}},{display:function(){try{if(sML.fullScreenEnabled(parent.document))return"";throw new Error}catch(a){return sML.addClass(O.HTML,"not-enabled-full-screen"),"none"}}()})),C.Switches.NewWindow=C.Switches.appendChild(sML.create("a",{className:"bibi-switches-switch",id:"bibi-switches-newwindow",href:location.href.replace(/&wait=[^&]+/g,""),target:"_blank",Labels:[{ja:"新しいウィンドウで開く",en:"Open in New Window"}],toggleState:a},{display:function(){return parent!=window?"":(sML.addClass(O.HTML,"not-embeded"),"none")}()})),sML.each(C.Switches.getElementsByClassName("bibi-switches-switch"),function(){this.toggleState(0)})},C.createArrows=function(){C.Arrows?C.Arrows.innerHTML="":C.Arrows=O.Body.appendChild(sML.create("div",{id:"bibi-arrows"},{transition:"opacity 0.75s linear",opacity:0})),C.Arrows.Back=C.Arrows.appendChild(sML.create("div",{title:"Back",className:"bibi-arrow",id:"bibi-arrow-back",onclick:function(){R.page(-1)}})),C.Arrows.Forward=C.Arrows.appendChild(sML.create("div",{title:"Forward",className:"bibi-arrow",id:"bibi-arrow-forward",onclick:function(){R.page(1)}})),sML.each([C.Arrows.Back,C.Arrows.Forward],function(){this.addEventListener("mouseover",function(){this.clickedTimer&&clearTimeout(this.clickedTimer),sML.addClass(this,"shown")}),this.addEventListener("mouseout",function(){sML.removeClass(this,"shown")}),this.addEventListener("click",function(){sML.addClass(this,"shown");var a=this;this.clickedTimer&&clearTimeout(this.clickedTimer),this.clickedTimer=setTimeout(function(){sML.removeClass(a,"shown")},500)})})},C.listenKeys=function(a){if(R.Started){var b=parent!=window&&parent.Bibi?parent:window;b.C.KeyCode=a.keyCode;var c=null;if("ttb"==S["spread-layout-direction"])switch(a.keyCode){case 37:c=0;break;case 38:c=-1;break;case 39:c=0;break;case 40:c=1}else if("ltr"==S["spread-layout-direction"])switch(a.keyCode){case 37:c=-1;break;case 38:c=0;break;case 39:c=1;break;case 40:c=0}else if("rtl"==S["spread-layout-direction"])switch(a.keyCode){case 37:c=1;break;case 38:c=0;break;case 39:c=-1;break;case 40:c=0}switch(c){case-1:return b.R.page(-1);case 1:return b.R.page(1);case 0:return b.C.Panel.toggle()}}},O.updateSetting=function(a){if("object"!=typeof a)return S;var b=S.BDM,c=S.SLA,d=S.SLD,e=S.PSF,f=S.PPD;if(a.Reset){for(var g in S)delete S[g];for(var g in P)S[g]=P[g];S["page-progression-direction"]=B.Package.Spine["page-progression-direction"],"default"==S["page-progression-direction"]&&(S["page-progression-direction"]=P["page-progression-direction"]),delete a.Reset}for(var g in a)S[g]=a[g];return(sML.UA.InternetExplorer<11||sML.UA.Opera<15)&&(S["book-display-mode"]="all",S["spread-layout-axis"]="vertical",S["page-size-format"]="window"),sML.UA.Gecko&&(S["book-display-mode"]="all",S["spread-layout-axis"]="vertical",S["page-size-format"]="window"),"auto"==S["spread-layout-axis"]&&(S["spread-layout-axis"]=B.Package.Spine["page-progression-direction"]),"default"==S["spread-layout-axis"]&&(S["spread-layout-axis"]="pre-paginated"==B.Package.Metadata["rendition:layout"]?S["page-progression-direction"]:"vertical"),"vertical"!=S["spread-layout-axis"]&&(S["spread-layout-axis"]="horizontal"),"vertical"==S["spread-layout-axis"]&&(S["spread-layout-direction"]="ttb"),"horizontal"==S["spread-layout-axis"]&&(S["spread-layout-direction"]="rtl"!=S["page-progression-direction"]?"ltr":"rtl"),S.BDM=S["book-display-mode"],S.SLA=S["spread-layout-axis"],S.SLD=S["spread-layout-direction"],S.PPD=S["page-progression-direction"],S.PSF=S["page-size-format"],"vertical"==S.SLA?(S.SIZE={b:"width",B:"Width",l:"height",L:"Height",w:"breadth",W:"Breadth",h:"length",H:"Length"},S.AXIS={XY:"Y",YX:"X",PM:1},S.BASE="ltr"==S.PPD?{b:"top",B:"Top",a:"bottom",A:"Bottom",s:"left",S:"Left",e:"right",E:"Right",c:"center",m:"middle"}:{b:"top",B:"Top",a:"bottom",A:"Bottom",s:"right",S:"Right",e:"left",E:"Left",c:"center",m:"middle"}):(S.SIZE={b:"height",B:"Height",l:"width",L:"Width",w:"length",W:"Length",h:"breadth",H:"Breadth"},"ltr"==S.PPD?(S.AXIS={XY:"X",YX:"Y",PM:1},S.BASE={b:"left",B:"Left",a:"right",A:"Right",s:"top",S:"Top",e:"bottom",E:"Bottom",c:"middle",m:"center"}):(S.AXIS={XY:"X",YX:"Y",PM:-1},S.BASE={b:"right",B:"Right",a:"left",A:"Left",s:"top",S:"Top",e:"bottom",E:"Bottom",c:"middle",m:"center"})),b!=S.BDM&&sML.replaceClass(O.HTML,"display-"+b,"display-"+S.BDM),c!=S.SLA&&sML.replaceClass(O.HTML,"spread-"+c,"spread-"+S.SLA),d!=S.SLD&&sML.replaceClass(O.HTML,"spread-"+d,"spread-"+S.SLD),e!=S.PSF&&sML.replaceClass(O.HTML,"page-"+e,"page-"+S.PSF),f!=S.PPD&&sML.replaceClass(O.HTML,"page-"+f,"page-"+S.PPD),S},O.readExtra=function(){if(O.EPUBCFI=BibiEPUBCFI,Q=sML.getQueries(),H=O.parseHash(),X={},history.replaceState&&history.replaceState(null,null,location.href.replace(/[\,#]bibi_x\([^\)]*\)$/g,"")),!Q.book){var a=location.pathname.split("/"),b=a[a.length-1];""!=b&&"index.html"!=b&&(Q.book=b.replace(/\.html$/,""))}X.Wait=!0,(parent==window&&!H.wait||H.auto)&&delete X.Wait,history.replaceState&&history.replaceState(null,null,location.href.replace(/\,?(wait|auto)\([^\)]*\)/g,"")),H.bibi&&(H.bibi=H.bibi.replace(" ",""),sML.each(H.bibi.split(","),function(){var a=this.split(":");if(a[0]){if(a[1])switch(a[0]){case"preset":return void(X.Preset=a[1].replace(/(\.js)?$/,".js"));case"to":return void(X.To=O.getBibitoTarget(a[1]));default:return}switch(a[0]){case"all":case"each":return void(X.BDM||(X.BDM=a[0]));case"horizontal":case"vertical":return void(X.SLA||(X.SLA=a[0]));case"window":case"portrait":case"landscape":return void(X.PSF||(X.PSF=a[0]))}}})),H.bibi_x&&(H.bibi_x=H.bibi_x.replace(" ",""),sML.each(H.bibi_x.split(","),function(){var a=this.split(":");if(a[0]&&a[1])switch(a[0]){case"nav":return void(X.Nav=1*a[1])}})),!X.To&&H.epubcfi&&(X.To=O.getEPUBCFITarget(H.epubcfi))},O.parseHash=function(){if(!location.hash)return{};var a=location.hash.replace(/^#/,""),b=0,c={},d=function(){for(var d=b,e="";/[a-z_]/.test(a.charAt(b));)b++;if("("!=a.charAt(b))return null;for(e=a.substr(d,b-1-d+1),b++;")"!=a.charAt(b);)b++;c[e]=a.substr(d,b-d+1).replace(/^[a-z_]+\(/,"").replace(/\)$/,""),b++};return function(){for(d();","==a.charAt(b);)b++,d()}(),c},O.getBibitoTarget=function(a){if("number"==typeof a&&(a=""+a),"string"!=typeof a||!/^[1-9][0-9]*(-[1-9][0-9]*(\.[1-9][0-9]*)*)?$/.test(a))return null;var b="",c=a.split("-"),d=parseInt(c[0]),e=c[1]?c[1]:null;return e&&sML.each(e.split("."),function(){b+=">*:nth-child("+this+")"}),{BibitoString:a,ItemIndex:d-1,Element:b?"body"+b:null}},O.getEPUBCFITarget=function(a){var b=O.EPUBCFI.parse(a);if(!b||b.Path.Steps.length<2||!b.Path.Steps[1].Index||b.Path.Steps[1].Index%2==1)return null;var c=b.Path.Steps[1].Index/2-1,d=null,e=null,f=null,g=null;return b.Path.Steps[2]&&b.Path.Steps[2].Steps&&(d="",sML.each(b.Path.Steps[2].Steps,function(a){return"IndirectPath"==this.Type?(g=this,!1):"TermStep"==this.Type?(f=this,!1):this.Index%2==1&&(e=this.Index-1,a!=b.Path.Steps[2].Steps.length-2)?!1:void(null===e&&(d=this.ID?"#"+this.ID:d+">*:nth-child("+this.Index/2+")"))}),d&&/^>/.test(d)&&(d="html"+d),d||(d=null)),{CFI:b,CFIString:a,ItemIndex:c,Element:d,TextNodeIndex:e,TermStep:f,IndirectPath:g}},O.getLogo=function(a){return["<",a.Linkify?"a":"span",' class="bibi-logo"',a.Linkify?' href="http://sarasa.la/bib/i" target="_blank" title="BiB/i | Web Site"':"",">",'<span class="bibi-type-B">B</span>','<span class="bibi-type-i">i</span>','<span class="bibi-type-B">B</span>','<span class="bibi-type-slash">/</span>','<span class="bibi-type-i">i</span>',"</",a.Linkify?"a":"span",">"].join("")},O.Log=(!parent||parent==window)&&console&&console.log,O.log=function(a,b){O.Log&&b&&"string"==typeof b&&(O.showStatus(b),0==a?b="[ERROR] "+b:1==a?b="---------------- "+b+" ----------------":2==a?b=b:3==a?b=" - "+b:4==a&&(b="   . "+b),console.log("BiB/i: "+b))},O.showStatus=function(a){status="BiB/i: "+a,O.statusClearer&&clearTimeout(O.statusClearer),O.statusClearer=setTimeout(function(){status=defaultStatus},3210)},O.isBin=function(a){return/\.(gif|jpe?g|png|ttf|otf|woff|mp[g34]|m4[av]|ogg|webm|pdf)$/i.test(a)},O.getPath=function(){return function(a){for(var b=a[0],c=a.length,d=1;c>d;d++)b+="/"+a[d];return b}(arguments).replace(/\/\.\//g,"/").replace(/[^\/]+\/\.\.\//g,"").replace(/\/\//g,"/").replace(/^\//,"")},O.toBibiXML=function(a){return a.replace(/<\?[^>]*?\?>/g,"").replace(/<(\/?)([\w\d]+):/g,"<$1$2_").replace(/<(\/?)(opf_)?([^!\?\/ >]+)/g,"<$1bibi_$3").replace(/<([\w\d_]+) ([^>]+?)\/>/g,"<$1 $2></$1>")},O.ContentTypeList={"image/gif":/\.gif$/i,"image/png":/\.png$/i,"image/jpeg":/\.jpe?g$/i,"image/svg+xml":/\.svg$/i,"font/truetype":/\.ttf$/i,"font/opentype":/\.otf$/i,"font/woff":/\.woff$/i,"text/css":/\.css$/i,"text/javascript":/\.js$/i,"text/html":/\.html?$/i,"application/xhtml+xml":/\.xhtml$/i,"application/xml":/\.xml$/i,"application/pdf":/\.pdf$/i},sML.ready(O.welcome),BibiEPUBCFI={/*!
 *
 *  # BiB/i EPUB-CFI Utilities
 *
 *  - "EPUB-CFI Utilities (for BiB/i, or Others)"
 *  - (c) Satoru MATSUSHIMA - http://sarasa.la/bib/i
 *  - Licensed under the MIT license. - http://www.opensource.org/licenses/mit-license.php
 *
 *  - Sun June 22 23:59:59 2014 +0900
 */
Version:.32,Build:20140622,CFIString:"",Current:0,parse:function(a,b){if(!a||"string"!=typeof a)return null;try{a=decodeURIComponent(a)}catch(c){return this.log(0,"Unregulated URIEncoding."),null}return b&&"string"==typeof b&&"function"==typeof this["parse"+b]||(b="Fragment"),"Fragment"==b&&(a=a.replace(/^(epubcfi\()?/,"epubcfi(").replace(/(\))?$/,")")),this.CFIString=a,this.Current=0,this.Log&&this.LogCancelation&&(this.log(1,"BiB/i EPUB-CFI"),this.log(2,"parse"),this.log(3,"CFIString: "+this.CFIString)),this["parse"+b]()},parseFragment:function(){var a=this.Current,b={};return this.parseString("epubcfi(")?(b=this.parseCFI(),null===b?this.cancel(a):this.parseString(")")?b:this.cancel(a,"Fragment")):this.cancel(a,"Fragment")},parseCFI:function(){var a=this.Current,b={Type:"CFI",Path:{}};if(b.Path=this.parsePath(),!b.Path)return this.cancel(a,"CFI");if(this.parseString(",")){if(b.Start=this.parseLocalPath(),!b.Start.Steps.length&&!b.Start.TermStep)return this.cancel(a,"CFI > Range");if(!this.parseString(","))return this.cancel(a,"CFI > Range");if(b.End=this.parseLocalPath(),!b.End.Steps.length&&!b.End.TermStep)return this.cancel(a,"CFI > Range")}return b},parsePath:function(){var a=this.Current,b={Type:"Path",Steps:[]},c={};return b.Steps[0]=this.parseStep(),b.Steps[0]&&(c=this.parseLocalPath())?(b.Steps=b.Steps.concat(c.Steps),b):this.cancel(a,"Path")},parseLocalPath:function(){var a=(this.Current,{Type:"LocalPath",Steps:[]}),b=a,c=null,d=null;for(c=this.parseStep("Local");null!==c&&(b.Steps.push(c),c=this.parseStep("Local"));)if("IndirectStep"==c.Type){var e={Type:"IndirectPath",Steps:[]};b.Steps.push(e),b=e}else if("TermStep"==c.Type){d=c;break}return d&&b.Steps.push(d),a.Steps.length?a:null},parseStep:function(a){var b=this.Current,c={};if(this.parseString("/"))c.Type="Step";else if(a&&this.parseString("!/"))c.Type="IndirectStep";else{if(!a||!this.parseString(":"))return this.cancel(b,"Step");c.Type="TermStep"}if(c.Index=this.parseString(/^(0|[1-9][0-9]*)/),null===c.Index)return this.cancel(b,"Step");if(c.Index=parseInt(c.Index),this.parseString("[")){if("TermStep"!=c.Type){if(c.ID=this.parseString(/^[_a-zA-Z][_a-zA-Z0-9\-]+/),!c.ID)return this.cancel(b,"Step > Assertion > ID")}else{var d=[],e=null,f=/^((\^[\^\[\]\(\)\,\;\=])|[_a-zA-Z0-9%\- ])*/;if(d.push(this.parseString(f)),this.parseString(",")&&d.push(this.parseString(f)),d[0]&&(c.Preceding=d[0]),d[1]&&(c.Following=d[1]),this.parseString(/^;s=/)&&(e=this.parseString(/^[ab]/)),e&&(c.Side=e),!c.Preceding&&!c.Following&&!c.Side)return this.cancel(b,"Step > Assertion > TextLocation")}if(!this.parseString("]"))return this.cancel(b,"Step > Assertion")}return c},parseString:function(a){var b=null;if(a instanceof RegExp){var c=this.CFIString.substr(this.Current,this.CFIString.length-this.Current);a.test(c)&&(a=c.match(a)[0],this.Current+=a.length,b=a)}else this.CFIString.substr(this.Current,a.length)===a&&(this.Current+=a.length,b=a);return this.correct(b)},correct:function(a){return this.Log&&this.LogCorrection&&a&&this.log(3,a),a},cancel:function(a,b){return this.Log&&this.LogCancelation&&this.log(4,"cancel: parse"+b+" ("+a+"-"+this.Current+"/"+this.CFIString.length+")"),"number"==typeof a&&(this.Current=a),null},log:function(a,b){this.Log&&console&&console.log&&(0==a?b="[ERROR] "+b:1==a?b="---------------- "+b+" ----------------":2==a?b=b:3==a?b=" - "+b:4==a&&(b="   . "+b),console.log("BiB/i EPUB-CFI: "+b))}};
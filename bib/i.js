/*!
 *
 *  # Pipi: BiB/i Putter
 *
 *  - "Putting EPUBs in a Web Page with BiB/i."
 *  - (c) Satoru MATSUSHIMA - http://bibi.epub.link/
 *  - Licensed under the MIT license. - http://www.opensource.org/licenses/mit-license.php
 */
!function(){if(!window["bibi:pipi"]){var e=window["bibi:pipi"]={version:"0.999.0",build:20150929.1551,Status:"",Bibis:[],Anchors:[],Holders:[],Frames:[],TrustworthyOrigins:[location.origin],Loaded:0};e.BibiPath=document.querySelector('script[src$="bib/i.js"]').src.replace(/\.js$/,""),e.embed=function(){e.Status="Started";for(var t=document.body.querySelectorAll("a[data-bibi]"),i=t.length,n=0;i>n;n++)if(t[n].getAttribute("href")&&!t[n].Bibi){var o={Index:n,Number:n+1},a=o.Anchor=t[n];/ bibi-anchor /.test(" "+a.className+" ")||(a.className="bibi-anchor"+(a.className?" "+a.className:""));var r=Href=a.getAttribute("href"),s=a.getAttribute("data-bibi-class"),d=a.getAttribute("data-bibi-id"),b=a.getAttribute("data-bibi-style"),u=a.getAttribute("data-bibi-autostart"),c=a.getAttribute("data-bibi-reader-view-mode"),l=a.getAttribute("data-bibi-to"),m=a.getAttribute("data-bibi-nav"),h=a.getAttribute("data-bibi-view"),p=a.getAttribute("data-bibi-arrows");a.origin!=location.origin&&e.TrustworthyOrigins.push(a.origin),a.addEventListener("bibi:load",function(e){console.log("BiB/i: Loaded. - #"+e.detail.Number+": "+e.detail.Anchor.href)},!1),e.Anchors.push(a);var g=o.Holder=e.create("span",{className:"bibi-holder",id:"bibi-holder-"+(n+1),title:(a.innerText?a.innerText+" ":"")+"(powered by BiB/i)"});s&&(g.className+=" "+s),d&&(g.id=d),b&&g.setAttribute("style",b);var v=[];v.push("pipi-id:"+g.id),v.push("parent-uri:"+e.encode(location.href)),v.push("parent-origin:"+e.encode(location.origin)),u&&/^(undefined|autostart|yes|true)?$/.test(u)&&v.push("autostart"),c&&/^(horizontal|vertical|paged)?$/.test(c)&&v.push("reader-view-mode:"+c),l&&/^[1-9][\d\-\.]*$/.test(l)&&v.push("to:"+l),m&&/^[1-9]\d*$/.test(m)&&v.push("nav:"+m),h&&/^fixed$/.test(h)&&v.push("view:"+h),p&&/^hidden$/.test(p)&&v.push("arrows:"+p),v.length&&(r+=(/#/.test(r)?",":"#")+"pipi("+v.join(",")+")"),e.Holders.push(g);var f=o.Frame=g.appendChild(e.create("iframe",{className:"bibi-frame",frameborder:"0",scrolling:"auto",allowfullscreen:"true",src:r}));f.addEventListener("load",function(){e.Loaded++,this.Bibi.Anchor.dispatchEvent(new CustomEvent("bibi:load",{detail:this.Bibi})),"Timeouted"!=e.Status&&e.Loaded==e.Bibis.length&&(e.Status="Loaded",document.dispatchEvent(new CustomEvent("bibi:load",{detail:e})))},!1),e.Frames.push(f),e.Bibis.push(o),f.Bibi=g.Bibi=a.Bibi=o}for(var n=0,i=e.Bibis.length;i>n;n++)if(!e.Bibis[n].Embedded){var o=e.Bibis[n];o.move=function(e){"number"==typeof Target&&this.Frame.contentWindow.postMessage('{"bibi:command:move":"'+e+'"}',this.Anchor.origin)},o.focus=function(e){("string"==typeof e||"number"==typeof e)&&this.Frame.contentWindow.postMessage('{"bibi:command:focus":"'+e+'"}',this.Anchor.origin)},o.changeView=function(e){"string"==typeof Target&&this.Frame.contentWindow.postMessage('{"bibi:command:changeView":"'+e+'"}',this.Anchor.origin)},o.togglePanel=function(){this.Frame.contentWindow.postMessage('{"bibi:command:togglePanel":""}',this.Anchor.origin)},o.Anchor.style.display="none",o.Anchor.parentNode.insertBefore(o.Holder,o.Anchor),o.Anchor.dispatchEvent(new CustomEvent("bibi:ready",{detail:o}))}return setTimeout(function(){"Loaded"!=e.Status&&(e.Status="Timeouted",document.dispatchEvent(new CustomEvent("bibi:timeout",{detail:e})))},12e3),e.Status="Readied",document.dispatchEvent(new CustomEvent("bibi:ready",{detail:e})),e.Bibis},e.encode=function(e){return encodeURIComponent(e).replace("(","_BibiKakkoOpen_").replace(")","_BibiKakkoClose_")},e.create=function(e,t){var i=document.createElement(e);for(var n in t)i[n]=t[n];return i},(!window.CustomEvent||"function"!=typeof window.CustomEvent&&-1===window.CustomEvent.toString().indexOf("CustomEventConstructor"))&&(window.CustomEvent=function(e,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var i=document.createEvent("CustomEvent");return i.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),i},window.CustomEvent.prototype=window.Event.prototype),window.addEventListener("message",function(t){if(t&&t.data)for(var i=0,n=e.TrustworthyOrigins.length;n>i;i++)if(t.origin==e.TrustworthyOrigins[i]){var o=t.data;try{if(o=JSON.parse(o),"object"!=typeof o||!o)return!1;for(var a in o)/^bibi:command:/.test(a)&&document.dispatchEvent(new CustomEvent(a,{detail:o[a]}));return!0}catch(r){}return!1}},!1),document.getElementsByTagName("head")[0].appendChild(e.create("link",{rel:"stylesheet",id:"bibi-css",href:e.BibiPath+".css"})),document.addEventListener("bibi:ready",function(e){console.log("BiB/i: Readied. - "+e.detail.Bibis.length+" Bibi(s).")},!1),document.addEventListener("bibi:load",function(e){console.log("BiB/i: Loaded. - "+e.detail.Bibis.length+" Bibi(s).")},!1),document.addEventListener("bibi:timeout",function(e){console.log("BiB/i: Timeouted.")},!1),document.addEventListener("DOMContentLoaded",e.embed,!1)}}();